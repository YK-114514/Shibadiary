<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../css/personal.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../http.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body>
    <div class="header">
        <div class="header-next">
        <a class="index" href="/index">
            <img class="logo" src="../images/logo.png">
            <img class="title" src="../images/title.png">
        </a>
        <a href="/setting" class="setting">è´¦å·è®¾ç½®</a>
        </div>
    </div>

    <div class="middle">
        <img class="profile" src="" alt="avatar">
        <div class="info-block">
            <p class="name">æµ‹è¯•</p>
            <p class="stats">å…³æ³¨: -- | ç²‰ä¸: --</p>
        </div>
    </div>

    <div class="section-title">æˆ‘ çš„ å‘ å¸ƒ</div>

    <div class="content-container">
        <ul class="content"></ul>
    </div>
    
    <!-- åˆ†é¡µæ§ä»¶ -->
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item">
                <a class="page-link" href="javascript:;" id="prevPage" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            <li class="page-item">
                <span class="page-link" id="currentPageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
            </li>
            <li class="page-item">
                <a class="page-link" href="javascript:;" id="nextPage" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
</body>
</html>

<script>
    // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œå¦‚æœæœªç™»å½•åˆ™è·³è½¬åˆ°ç™»å½•é¡µé¢
    (function checkLoginStatus() {
        const token = localStorage.getItem('eleToken');
        const userData = localStorage.getItem('user_data');
        
        if (!token || !userData) {
            console.log('æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
            window.location.href = '/login';
            return;
        }
        
        try {
            JSON.parse(userData);
        } catch (e) {
            console.log('ç”¨æˆ·æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
            window.location.href = '/login';
            return;
        }
    })();

    // è·å–DOMå…ƒç´ 
    const avatarGet = document.querySelector('.profile')
    const nameGet = document.querySelector('.name')
    const statsElement = document.querySelector('.stats')
    const content = document.querySelector('.content')

    // åˆ†é¡µç›¸å…³DOMå…ƒç´ 
    const currentPageInfo = document.getElementById('currentPageInfo')
    const prevPageBtn = document.getElementById('prevPage')
    const nextPageBtn = document.getElementById('nextPage')

    // è·å–URLä¸­çš„ç”¨æˆ·ID
    function getUserIdFromUrl() {
        const pathParts = window.location.pathname.split('/');
        const userId = pathParts[pathParts.length - 1];
        console.log('ä»URLè·å–ç”¨æˆ·ID:', userId);
        
        // å¦‚æœæœ€åä¸€æ®µæ˜¯"personal"ï¼Œè¯´æ˜æ˜¯è®¿é—®è‡ªå·±çš„ä¸ªäººé¡µé¢
        if (userId === 'personal') {
            // ä»localStorageè·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ID
            const userData = localStorage.getItem('user_data');
            if (userData) {
                try {
                    const parsedUserData = JSON.parse(userData);
                    console.log('ä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·ID:', parsedUserData.id_user);
                    return parsedUserData.id_user;
                } catch (e) {
                    console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                    return null;
                }
            }
            return null;
        }
        
        return userId;
    }

    // è·å–ä¸ªäººä¿¡æ¯localStorageï¼ˆå½“å‰ç™»å½•ç”¨æˆ·ï¼‰
    const userD = localStorage.getItem('user_data')
    let user_data = null;
    try {
        user_data = userD ? JSON.parse(userD) : null;
    } catch (e) {
        console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
    }

    // ä»æ•°æ®åº“è·å–æŒ‡å®šç”¨æˆ·çš„ä¿¡æ¯
    async function fetchUserData(userId) {
        try {
            // ä½¿ç”¨ç°æœ‰çš„accounts APIæ¥è·å–ç”¨æˆ·ä¿¡æ¯
            const response = await axios.get(`/api/accounts/${userId}/accounts`);
            console.log('ç”¨æˆ·æ•°æ®APIå“åº”:', response.data);
            
            // ä»postsä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœpostsä¸ä¸ºç©ºï¼‰
            if (response.data.posts && response.data.posts.length > 0) {
                const firstPost = response.data.posts[0];
                const userData = {
                    id_user: firstPost.id_user,
                    name: firstPost.name,
                    avatar: firstPost.avatar
                };
                
                console.log('å·²ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯:', userData);
                return userData;
            } else {
                // å¦‚æœç”¨æˆ·æ²¡æœ‰å¸–å­ï¼Œä»localStorageè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ä½œä¸ºå¤‡é€‰
                console.log('ç”¨æˆ·æ²¡æœ‰å¸–å­ï¼Œä½¿ç”¨localStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯');
                const userData = localStorage.getItem('user_data');
                if (userData) {
                    try {
                        const parsedUserData = JSON.parse(userData);
                        // éªŒè¯ç”¨æˆ·IDæ˜¯å¦åŒ¹é…
                        if (parsedUserData.id_user == userId) {
                            return {
                                id_user: parsedUserData.id_user,
                                name: parsedUserData.name,
                                avatar: parsedUserData.avatar
                            };
                        }
                    } catch (e) {
                        console.error('è§£ælocalStorageç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                    }
                }
                return null;
            }
        } catch (error) {
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            return null;
        }
    }

    // ä»æ•°æ®åº“è·å–æœ€æ–°çš„å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
    async function fetchLatestUserData() {
        const token = localStorage.getItem('eleToken');
        if (!token) {
            console.log('æœªç™»å½•ï¼Œæ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯');
            return null;
        }
        
        try {
            const response = await axios.get('/api/user/me', {
                headers: { 'Authorization': token }
            });
            
            if (response.data.success && response.data.user) {
                const latestUserData = {
                    id_user: response.data.user.id,
                    name: response.data.user.name,
                    avatar: response.data.user.avatar,
                    phone: response.data.user.phone
                };
                
                // æ›´æ–°localStorageä¸­çš„ç”¨æˆ·æ•°æ®
                localStorage.setItem('user_data', JSON.stringify(latestUserData));
                
                // æ›´æ–°å…¨å±€user_dataå˜é‡
                user_data = latestUserData;
                
                console.log('å·²ä»æ•°æ®åº“è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯:', latestUserData);
                return latestUserData;
            }
        } catch (error) {
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            return null;
        }
    }

    let allData = []
    let currentPage = 1
    let totalPages = 1
    let totalPosts = 0
    
            // ç›‘å¬ç”¨æˆ·ä¿¡æ¯æ›´æ–°
    window.addEventListener('storage', function(e) {
            if (e.key === 'userUpdate') {
            try {
                const updateData = JSON.parse(e.newValue);
                    console.log('è§£æçš„ç”¨æˆ·ä¿¡æ¯æ›´æ–°æ•°æ®:', updateData);
                    
                    // æ›´æ–°å¤´åƒ
                if (updateData && updateData.avatar) {
                    updateAllAvatars(updateData.avatar);
                    }
                    
                    // æ›´æ–°æ˜µç§°
                    if (updateData && updateData.nickname) {
                        const nameElement = document.querySelector('.name');
                        if (nameElement) {
                            nameElement.textContent = updateData.nickname;
                        }
                    }
                    
                    // ä»æ•°æ®åº“è·å–æœ€æ–°çš„ç”¨æˆ·ä¿¡æ¯
                    fetchLatestUserData().then(() => {
                        // æ›´æ–°é¡µé¢ä¸Šçš„ç”¨æˆ·åå’Œå¤´åƒæ˜¾ç¤º
                        const nameElement = document.querySelector('.name');
                        const avatarElement = document.querySelector('.profile');
                        if (nameElement && user_data) {
                            nameElement.textContent = user_data.name;
                        }
                        if (avatarElement && user_data) {
                            avatarElement.src = user_data.avatar;
                        }
                        console.log('ä¸ªäººé¡µé¢å·²æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º');
                    });
                    
                    console.log('ä¸ªäººé¡µé¢æ”¶åˆ°ç”¨æˆ·ä¿¡æ¯æ›´æ–°é€šçŸ¥:', updateData);
            } catch (error) {
                    console.error('è§£æç”¨æˆ·ä¿¡æ¯æ›´æ–°æ•°æ®å¤±è´¥:', error);
            }
        }
    });
    
    // æ›´æ–°æ‰€æœ‰å¤´åƒçš„å‡½æ•°
    function updateAllAvatars(newAvatarUrl) {
        console.log('å¼€å§‹æ›´æ–°ä¸ªäººé¡µé¢å¤´åƒï¼Œæ–°å¤´åƒURL:', newAvatarUrl);
        
        // æ›´æ–°æ‰€æœ‰imgæ ‡ç­¾çš„å¤´åƒ
        const allImages = document.querySelectorAll('img');
        let updatedCount = 0;
        allImages.forEach(img => {
            // æ£€æŸ¥æ˜¯å¦æ˜¯å¤´åƒå›¾ç‰‡ï¼ˆæ›´å®½æ¾çš„æ¡ä»¶ï¼‰
            if (img.src && (
                img.src.includes('/images/default_avatar.jpg') || 
                img.src.includes('/images/avatars/') ||
                img.classList.contains('avatar') ||
                img.classList.contains('touxiang') ||
                img.classList.contains('profile')
            )) {
                console.log('æ›´æ–°imgæ ‡ç­¾å¤´åƒ:', img.src, '->', newAvatarUrl);
                // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                const newUrl = newAvatarUrl + (newAvatarUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
                img.src = newUrl;
                updatedCount++;
            }
        });
        
        // æ›´æ–°æ‰€æœ‰imageæ ‡ç­¾çš„å¤´åƒ
        const allImageElements = document.querySelectorAll('image');
        allImageElements.forEach(img => {
            // æ£€æŸ¥æ˜¯å¦æ˜¯å¤´åƒå›¾ç‰‡ï¼ˆæ›´å®½æ¾çš„æ¡ä»¶ï¼‰
            if (img.src && (
                img.src.includes('/images/default_avatar.jpg') || 
                img.src.includes('/images/avatars/') ||
                img.classList.contains('avatar') ||
                img.classList.contains('touxiang') ||
                img.classList.contains('profile')
            )) {
                console.log('æ›´æ–°imageæ ‡ç­¾å¤´åƒ:', img.src, '->', newAvatarUrl);
                // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                const newUrl = newAvatarUrl + (newAvatarUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
                img.src = newUrl;
                updatedCount++;
            }
        });
        
        console.log('ä¸ªäººé¡µé¢å¤´åƒæ›´æ–°å®Œæˆï¼Œå…±æ›´æ–°äº†', updatedCount, 'ä¸ªå¤´åƒ');
    }

    // è·å–ä¸ªäººæ•°æ®
    async function getPersonal(page = 1) {
        try {
            // è·å–URLä¸­çš„ç”¨æˆ·ID
            const targetUserId = getUserIdFromUrl();
            console.log('ç›®æ ‡ç”¨æˆ·ID:', targetUserId);
            
            if (!targetUserId) {
                console.error('æ— æ³•è·å–ç”¨æˆ·ID');
                return [];
            }
            
            // è·å–ç›®æ ‡ç”¨æˆ·çš„ä¿¡æ¯
            const targetUserData = await fetchUserData(targetUserId);
            if (!targetUserData) {
                console.error('æ— æ³•è·å–ç›®æ ‡ç”¨æˆ·ä¿¡æ¯');
                // å¦‚æœæ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå°è¯•ä½¿ç”¨localStorageä¸­çš„å½“å‰ç”¨æˆ·ä¿¡æ¯
                const currentUserData = localStorage.getItem('user_data');
                if (currentUserData) {
                    try {
                        const parsedUserData = JSON.parse(currentUserData);
                        if (parsedUserData.id_user == targetUserId) {
                            console.log('ä½¿ç”¨localStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯');
                            nameGet.innerHTML = parsedUserData.name;
                            avatarGet.src = parsedUserData.avatar;
                        } else {
                            console.error('ç”¨æˆ·IDä¸åŒ¹é…');
                            return [];
                        }
                    } catch (e) {
                        console.error('è§£ælocalStorageç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                        return [];
                    }
                } else {
                    console.error('localStorageä¸­æ²¡æœ‰ç”¨æˆ·æ•°æ®');
                    return [];
                }
            } else {
                // è®¾ç½®å¤´åƒå’Œåå­—ï¼ˆæ˜¾ç¤ºç›®æ ‡ç”¨æˆ·çš„ä¿¡æ¯ï¼‰
                nameGet.innerHTML = targetUserData.name;
                avatarGet.src = targetUserData.avatar;
            }

            // è·å–ç›®æ ‡ç”¨æˆ·çš„å¸–å­
            const res = await axios.get(`/api/accounts/${targetUserId}/accounts`);
            console.log('API Response:', res.data);

            // æ­£ç¡®ä½¿ç”¨è¿”å›çš„æ•°æ®ç»“æ„
            allData = res.data.posts || [];

            // è®¾ç½®å…³æ³¨æ•°å’Œç²‰ä¸æ•°ï¼Œå¦‚æœä¸ºnullåˆ™æ˜¾ç¤º0
            const following = res.data.following || 0;
            const followers = res.data.followers || 0;
            statsElement.innerHTML = `å…³æ³¨: ${following} | ç²‰ä¸: ${followers}`;

            // ç”±äºç°æœ‰APIæ²¡æœ‰åˆ†é¡µåŠŸèƒ½ï¼Œæˆ‘ä»¬æ‰‹åŠ¨å¤„ç†åˆ†é¡µ
            const allPosts = res.data.posts || [];
            const postsPerPage = 5;
            const startIndex = (page - 1) * postsPerPage;
            const endIndex = startIndex + postsPerPage;
            
            // åˆ†é¡µå¤„ç†
            allData = allPosts.slice(startIndex, endIndex);
            currentPage = page;
            totalPages = Math.ceil(allPosts.length / postsPerPage);
            totalPosts = allPosts.length;
            
            updatePaginationInfo();
            updatePaginationControls();

            // æ¸²æŸ“å¸–å­
            renderPosts(allData);

            return allData;
        } catch(error) {
            console.error('è·å–ä¸ªäººæ•°æ®å¤±è´¥:', error);
            return [];
        }
    }

    // æ›´æ–°åˆ†é¡µä¿¡æ¯æ˜¾ç¤º
    function updatePaginationInfo() {
        currentPageInfo.textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`
    }

    // æ›´æ–°åˆ†é¡µæ§ä»¶çŠ¶æ€
    function updatePaginationControls() {
        // æ›´æ–°ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µæŒ‰é’®çŠ¶æ€
        const prevPageItem = prevPageBtn.parentElement
        const nextPageItem = nextPageBtn.parentElement
        
        if (currentPage <= 1) {
            prevPageItem.classList.add('disabled')
        } else {
            prevPageItem.classList.remove('disabled')
        }
        
        if (currentPage >= totalPages) {
            nextPageItem.classList.add('disabled')
        } else {
            nextPageItem.classList.remove('disabled')
        }
    }

    // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
    async function goToPage(page) {
        if (page < 1 || page > totalPages) return
        currentPage = page
        await getPersonal(currentPage)
    }

    // æ¸²æŸ“å¸–å­
    function renderPosts(post_Datas) {
        content.innerHTML = '' // æ¸…ç©ºç°æœ‰å†…å®¹
        
        if (post_Datas.length === 0) {
            return
        }

        post_Datas.forEach(async (post) => {
            const formatted = new Date(post.time).toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            })

            // è·å–ç”¨æˆ·çš„å…³æ³¨æ•°å’Œç²‰ä¸æ•°
            let userFollowing = 0;
            let userFollowers = 0;
            try {
                const userRes = await axios.get(`/api/accounts/${post.id_user}/accounts`);
                userFollowing = userRes.data.following || 0;
                userFollowers = userRes.data.followers || 0;
            } catch (error) {
                console.error('è·å–ç”¨æˆ·å…³æ³¨æ•°æ®å¤±è´¥:', error);
            }

            // å¤„ç†å›¾ç‰‡
            let imagesArr = [];
            try {
                imagesArr = post.images ? JSON.parse(post.images) : [];
            } catch(error) {
                imagesArr = [];
            }
            let picturesHtml = '';
            if (imagesArr.length > 0) {
                picturesHtml = `<div class="pictures">` +
                    imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                    `</div>`;
            }

            // æ·»åŠ åˆ é™¤æŒ‰é’®ï¼ˆå› ä¸ºæ˜¯è‡ªå·±çš„å¸–å­ï¼‰
            let deleteBtnHtml = '';
            if (user_data && post.id_user == user_data.id_user) {
                deleteBtnHtml = `<button class="delete-post-btn" data-id="${post.id}">
                    <i class="bi bi-trash"></i>
                </button>`;
            }

            const li = document.createElement('li')
            li.innerHTML = `
                <div class="mulu-top" style="position:relative;">
                    ${deleteBtnHtml}
                    <div class="mulu">
                        <image class="avatar" src=${post.avatar}></image>
                        <div class="list">
                            <div class="divide_row">
                                <a href="javascript:;" class="uname" data-userid="${post.id_user}">${post.name}</a>
                                <div class="information">
                                    <div class="divide">
                                        <image class="touxiang" src=${post.avatar}></image>
                                        <p class="name">${post.name}</p>
                                    </div>
                                    <div class="people">
                                        <p>å…³æ³¨: ${userFollowing}</p>
                                        <p>ç²‰ä¸: ${userFollowers}</p>
                                    </div>
                                </div>
                            </div>
                            <p class="sentences">${post.content}</p>
                            ${picturesHtml}
                            <div class="last">
                                <p class="time">${formatted}</p>
                                <div class="others">
                                    <a href="javascript:;" class="like" data-id="${post.id}">â¤ 0</a>
                                    <a href="javascript:;" class="collect" data-id="${post.id}">â­ æ”¶è—</a>
                                    <a href='javascript:;' class="say" data-id="${post.id}">ğŸ–Š è¯„è®º</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `
            content.prepend(li)
        })
    }

    // æ£€æŸ¥æœªè¯»æ¶ˆæ¯æ•°é‡å¹¶æ›´æ–°çº¢ç‚¹çŠ¶æ€
    async function checkUnreadMessages() {
        try {
            const token = localStorage.getItem('eleToken');
            if (!token) {
                // æœªç™»å½•ï¼Œéšè—çº¢ç‚¹
                const messageDot = document.querySelector('.message-dot');
                if (messageDot) {
                    messageDot.style.display = 'none';
                }
                return;
            }

            const response = await axios.get('/api/message', {
                headers: {
                    'Authorization': token
                }
            });

            if (response.data.success) {
                const unreadCount = response.data.unreadCount;
                const messageDot = document.querySelector('.message-dot');
                
                if (messageDot) {
                    if (unreadCount > 0) {
                        messageDot.style.display = 'inline-block';
                    } else {
                        messageDot.style.display = 'none';
                    }
                }
            }
        } catch (error) {
            console.error('æ£€æŸ¥æœªè¯»æ¶ˆæ¯å¤±è´¥:', error);
            // å‡ºé”™æ—¶éšè—çº¢ç‚¹
            const messageDot = document.querySelector('.message-dot');
            if (messageDot) {
                messageDot.style.display = 'none';
            }
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', async () => {
        // æ£€æŸ¥æœªè¯»æ¶ˆæ¯å¹¶æ›´æ–°çº¢ç‚¹çŠ¶æ€
        await checkUnreadMessages();
        
        getPersonal()
        
        // æ·»åŠ ç”¨æˆ·åæ‚¬åœäº‹ä»¶å¤„ç†
        document.addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('uname')) {
                const information = e.target.nextElementSibling;
                if (information && information.classList.contains('information')) {
                    information.classList.add('active');
                }
            }
        });

        document.addEventListener('mouseout', function(e) {
            if (e.target.classList.contains('uname')) {
                const information = e.target.nextElementSibling;
                if (information && information.classList.contains('information')) {
                    information.classList.remove('active');
                }
            }
        });

        // æ·»åŠ ç‚¹èµäº‹ä»¶å¤„ç†
        document.addEventListener('click', async function(e) {
            if (e.target.classList.contains('like')) {
                const postId = e.target.dataset.id;
                const userData = JSON.parse(localStorage.getItem('user_data'));
                
                if (!userData) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }

                try {
                    const response = await axios.post('/api/posts/addLike', {
                        userid_like: userData.id_user,
                        id_from_post: postId
                    });

                    if (response.data.success) {
                        // æ›´æ–°ç‚¹èµæ˜¾ç¤º
                        const likeCount = e.target.textContent.match(/\d+/);
                        const currentCount = parseInt(likeCount ? likeCount[0] : 0);
                        
                        if (e.target.classList.contains('active')) {
                            e.target.classList.remove('active');
                            e.target.innerHTML = `â¤ ${currentCount - 1}`;
                        } else {
                            e.target.classList.add('active');
                            e.target.innerHTML = `â¤ ${currentCount + 1}`;
                        }
                    }
                } catch (error) {
                    console.error('ç‚¹èµå¤±è´¥:', error);
                }
            }
        });

        // æ·»åŠ æ”¶è—äº‹ä»¶å¤„ç†
        document.addEventListener('click', async function(e) {
            if (e.target.classList.contains('collect')) {
                const postId = e.target.dataset.id;
                const userData = JSON.parse(localStorage.getItem('user_data'));
                
                if (!userData) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }

                try {
                    const response = await axios.post('/api/posts/addCollect', {
                        userid_collect: userData.id_user,
                        id_from_post: postId
                    });

                    if (response.data.success) {
                        if (e.target.classList.contains('active')) {
                            e.target.classList.remove('active');
                            e.target.innerHTML = 'â­ æ”¶è—';
                        } else {
                            e.target.classList.add('active');
                            e.target.innerHTML = 'â­ å·²æ”¶è—';
                        }
                    }
                } catch (error) {
                    console.error('æ”¶è—å¤±è´¥:', error);
                }
            }
        });

        // æ·»åŠ åˆ é™¤å¸–å­äº‹ä»¶å¤„ç†
        document.addEventListener('click', async function(e) {
            if (e.target.closest('.delete-post-btn')) {
                const postId = e.target.closest('.delete-post-btn').dataset.id;
                
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¸–å­å—ï¼Ÿ')) {
                    try {
                        const token = localStorage.getItem('eleToken');
                        const response = await axios.delete(`/api/posts/${postId}`, {
                            headers: {
                                'Authorization': token
                            }
                        });

                        if (response.data.code === 0) {
                            // åˆ é™¤æˆåŠŸï¼Œç§»é™¤DOMå…ƒç´ 
                            e.target.closest('li').remove();
                            alert('åˆ é™¤æˆåŠŸ');
                        } else {
                            alert(response.data.msg || 'åˆ é™¤å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åˆ é™¤å¸–å­å¤±è´¥:', error);
                        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }
            }
        });

        // æ·»åŠ è¯„è®ºäº‹ä»¶å¤„ç†
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('say')) {
                const postId = e.target.dataset.id;
                window.location.href = `/post-detail/${postId}`;
            }
        });

        // æ·»åŠ åˆ†é¡µæ§ä»¶äº‹ä»¶å¤„ç†
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        });
    })
</script>