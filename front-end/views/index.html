<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="../css/index.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="../http.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&display=swap" rel="stylesheet">
    </head>
<body>
    <!-- å¼•å…¥headerç»„ä»¶ -->
    <div class="father">
    
        <div class='header'>
           <div class="header-next">
                <image class="logo" src="../images/logo.png"></image>
                <image class="title" src="../images/title.png"></image>
                <ul class="topics">
                    <li >
                        <a href="/index" class="active" data-id="1">å® ç‰©åšå®¢</a>
                    </li>
                    <li>
                        <a data-id="2" >å® ç‰©é—®ç­”</a>
                    </li>
                  
                </ul>
              <div class="login-header">
                <a href="/login" class="before-login">ç™»å½•</a>
                <a href="javascript:;" class="user-menu" style="display:none">
                    æ¬¢è¿ï¼Œ<span class="username"></span>
                   
                </a>
                <div class="user-dropdown">
                    <a href="/personal">ä¸ªäººä¿¡æ¯</a>
                    <a href="/message">æ¶ˆæ¯ä¸­å¿ƒ<span class="message-dot"></span></a>
                    <a href="javascript:;">æˆ‘çš„ç§ä¿¡</a>
                    <a href="javascript:;" id="logout">é€€å‡ºç™»å½•</a>
                </div>
               </div>
               
            </div>
        </div>
    

    <!-- å·¦ä¾§èœå•æ -->
    <div class="next">
        <div class="menu">
            <div class="menu-next">
                <ul class="part">
                   
                        <a href="javascript:;" onclick="navigate('post')" class="active" data-id="1">æ™’å›¾</a>
                    
                  
                   
                        <a href="javascript:;" onclick="navigate('friend')" data-id="3">å¥½å‹</a>
                    
                        <a href="javascript:;" onclick="navigate('collect')" data-id="4">æ”¶è—</a>
                   

                </ul>
            </div>
            <!-- æ·»åŠ å†…å®¹æŒ‰é’® -->

        <img class='adding' src="../images/add.png" alt="æ·»åŠ " onclick="showAdding()">


    <!-- æ·»åŠ å†…å®¹å¼¹çª— -->
    <div class="adding_content" style="display:none">
        <div class="top_new">
            <h3 class="title">æ·»åŠ å†…å®¹</h3>
            <a href="javascript:;" class="out" onclick="closeAdding()">Ã—</a>
        </div>
        <form id="contentForm" class="row g-3 needs-validation" novalidate enctype="multipart/form-data">
            <div class="mb-3">
                <label for="contentType" class="form-label">ç±»å‹</label>
                <select class="form-control" id="contentType" required>
                    <option value="å¸–å­">å¸–å­</option>
                    <option value="é—®ç­”">é—®ç­”</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="content" class="form-label">å†…å®¹</label>
                <textarea class="form-control" id="content" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">å›¾ç‰‡ï¼ˆæœ€å¤š9å¼ ï¼‰</label>
                <div class="image-upload-area" id="imageUploadArea">
                    <input type="file" id="imageInput" accept="image/*" multiple style="display:none">
                    <div class="image-grid" id="imageGrid">
                        <div class="add-image-btn" id="addImageBtn">+</div>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-secondary">å‘å¸ƒ</button>
        </form>
    </div>
    <div class="alert alert-success" role="alert" style="display:none">
        å‘å¸ƒæˆåŠŸ
    </div>
    <div class="alert alert-danger" role="alert" style="display:none">
        å‘å¸ƒå¤±è´¥ï¼
    </div>

        </div>
    </div>

    <!-- æœç´¢æ å±•ç¤º -->
    <div class="content">
        <div class="main-card">
            <div class="content-top-bar">
                <div class="sort-dropdown">
                    <button class="sort-toggle">
                        <span class="arrow">&#9660;</span>
                    </button>
                    <div class="two_type" style="display: none;">
                        <a href="javascript:;" id="likeDesc" class="active">æœ€çƒ­</a>
                        <a href="javascript:;" id="timeDesc">æœ€æ–°</a>
                    </div>
                </div>
                <div class="search-bar-demo">
                    <input type="text" class="search-input-demo" placeholder="æœç´¢ä½ æ„Ÿå…´è¶£çš„å†…å®¹..." disabled>
                    <button class="search-btn-demo" disabled>
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
            <ul class="content-next">
            </ul>
            <!-- æ·»åŠ åˆ†é¡µç»„ä»¶ -->
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item">
                        <a class="page-link" href="javascript:;" id="prevPage" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <span class="page-link" id="currentPageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="javascript:;" id="nextPage" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        <!-- æ·»åŠ å›¾ç‰‡é¢„è§ˆå®¹å™¨ -->
        <div class="image-preview-overlay" style="display: none;">
            <img class="preview-image" src="" alt="é¢„è§ˆå›¾ç‰‡">
        </div>
    </div>

    <div class="right-sidebar">
        <div class="sidebar-card">
            <div class="sidebar-title">ä½ æƒ³è®¤è¯†çš„äºº</div>
            <ul class="sidebar-list">
                <li>
                    <span class="sidebar-avatar"></span>
                    <span class="sidebar-name">xxx</span>
                </li>
                <li>
                    <span class="sidebar-avatar"></span>
                    <span class="sidebar-name">xxx</span>
                </li>
                <li>
                    <span class="sidebar-avatar"></span>
                    <span class="sidebar-name">xxx</span>
                </li>
            </ul>
        </div>
    </div>

    <script>
        // åŠ è½½headerç»„ä»¶
        const userD = localStorage.getItem('user_data');
        let userData = null;
        try {
            userData = userD ? JSON.parse(userD) : null;
        } catch (e) {
            console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
        }

        // è·å–headerç›¸å…³å…ƒç´ 
        const logining = document.querySelector('.login-header .before-login');
        const userMenu = document.querySelector('.user-menu');
        const username = document.querySelector('.username');
        const userDropdown = document.querySelector('.user-dropdown');
        const logout_click = document.getElementById('logout');

        // åˆå§‹åŒ–ç™»å½•çŠ¶æ€
        function initLoginState() {
            console.log('åˆå§‹åŒ–ç™»å½•çŠ¶æ€');
            if(!localStorage.getItem('eleToken') || !userData){
                logining.style.display = 'block';
                userMenu.style.display = 'none';
            } else {
                logining.style.display = 'none';
                userMenu.style.display = 'block';
                username.textContent = userData.name;

                // ç‚¹å‡»æ˜¾ç¤º/éšè—ä¸‹æ‹‰èœå•
                if (userMenu && userDropdown) {
                    userMenu.addEventListener('click', (e) => {
                        e.preventDefault();
                        userDropdown.classList.toggle('show');
                        const arrow = userMenu.querySelector('.arrow');
                        if (arrow) {
                            arrow.classList.toggle('rotate');
                        }
                    });

                    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                    document.addEventListener('click', (e) => {
                        if (userMenu && userDropdown && !userMenu.contains(e.target) && !userDropdown.contains(e.target)) {
                            userDropdown.classList.remove('show');
                            const arrow = userMenu.querySelector('.arrow');
                            if (arrow) {
                                arrow.classList.remove('rotate');
                            }
                        }
                    });
                }

                // é€€å‡ºç™»å½•
                if (logout_click) {
                    logout_click.addEventListener('click', () => {
                        localStorage.removeItem('eleToken');
                        localStorage.clear();
                        // æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
                        logining.style.display = 'block';
                        userMenu.style.display = 'none';
                        userDropdown.classList.remove('show');
                        const arrow = userMenu?.querySelector('.arrow');
                        if (arrow) arrow.classList.remove('rotate');
                    });
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç™»å½•çŠ¶æ€
        //document.addEventListener('DOMContentLoaded', initLoginState);

         initLoginState();
        // è·å–å…¶ä»–å¿…è¦çš„å…ƒç´ 
        const addingImg = document.querySelector('.adding');
        const forms = document.querySelectorAll('.needs-validation');
        const danger = document.querySelector('.alert-danger');
        const success_alert = document.querySelector('.alert-success');

        // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæ·»åŠ æŒ‰é’®
        if(localStorage.getItem('eleToken')){
            addingImg.style.display='block';
        }else{
            addingImg.style.display='none';
        }

        //loadcontent è®¾ç½®
        async function loadContent(page) {
            const content = document.querySelector('.content-next');
            

            try {
                switch(page) {
                    case 'post':
                        content.innerHTML = ""
                        await getPosts('like');
                        break;
                    case 'friend':
                        content.innerHTML = ''
                        await getFriend();
                        break;
                    case 'collect':
                        content.innerHTML = ''
                        await getCollect()
                        break;
                   
                }
            } catch (error) {
                console.error('åŠ è½½å†…å®¹å¤±è´¥:', error);
                content.innerHTML = '<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            }
        }

        //åˆ‡æ¢åœ°å€æ 
        function navigate(page) {
            // ä¿®æ”¹åœ°å€æ URLï¼Œä½†ä¸ä¼šåˆ·æ–°é¡µé¢
            history.pushState({}, '', `/index/${page}`);
            // æ›´æ–°å¯¼èˆªæ activeçŠ¶æ€
             updateNavigation(page);

            // æ ¹æ®pageæ›´æ–°å†…å®¹
            loadContent(page);
        }

       

        //è·å–å…¨éƒ¨èµ„æ–™å…ˆ
        
        let allData = []; // å­˜å‚¨æ‰€æœ‰æ•°æ®
       async function getAllData(){
        try {
            const res = await axios.get('/api/posts/index');
            allData = res.data; // ä¿å­˜æ•°æ®åˆ°å…¨å±€å˜é‡
            return res.data;  // è¿”å›çœŸæ­£çš„æ•°æ®ï¼
        } catch (error) {
            console.error('è·å–æ•°æ®å¤±è´¥:', error);
            return []; // å¤±è´¥æ—¶è¿”å›ç©ºæ•°ç»„
        }
       
       }
       getAllData().then((allTable)=>{
        console.log(allTable)
       })

       //æŒ‰ç…§ç‚¹èµçƒ­åº¦æ¥æ’åº
       let allDataLikeDesc = []
       async function getLikeDesc(){
        try{
            const res = await axios.get('/api/posts/indexLike')
            allDataLikeDesc = res.data
            return allDataLikeDesc
        }catch(error){
            console.log(error)
            return []
        }
       }

       //æ”¶è—
       let allCollect = []

    async function getCollectData(){
        try{
            const res = await axios.get('/api/posts/collect')
            allCollect = res.data
            
            return(allCollect)
        }catch(error){
            console.log(error.message)
            return []
        }

    }
    getCollectData().then(allC=>console.log(allC))

    async function getLikeData(postId) {
    try {
        const res = await axios.get(`/api/posts/like/${postId}`);
        return res.data;
    } catch (error) {
        console.error('è·å–ç‚¹èµæ•°æ®å¤±è´¥:', error);
        return { likeCount: 0, userIdLike: [] };
    }
}

    //é¦–å…ˆçœ‹æ˜¯å¦æ˜¯æŒ‰çƒ­åº¦/æŒ‰ç‚¹èµ

    const likeDesc = document.getElementById('likeDesc')
    const timeDesc = document.getElementById('timeDesc')
    const content = document.querySelector('.content-next')

    //ç„¶åæˆ‘ä»¬è·å–çƒ­é—¨è´´
    async function getPosts(sortBy) {
        let post_Datas = [];

        if (sortBy === 'like') {
            post_Datas = await getLikeDesc();
        } else {
            post_Datas = await getAllData();
        }
        
        content.innerHTML = "";
        
        for (let i in post_Datas) {
            if (post_Datas[i].type == 'å¸–å­') {
                const formatted = new Date(post_Datas[i].time).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                    });

                // åˆ¤æ–­æ˜¯å¦ä¸ºè´´ä¸»
                let deleteBtnHtml = '';
                if (userData && post_Datas[i].id_user == userData.id_user) {
                    deleteBtnHtml = `<button class="btn btn-link btn-sm delete-post-btn" data-id="${post_Datas[i].id}">
                        <i class="bi bi-trash" style="font-size:20px;color:rgb(207, 185, 137);"></i>
                    </button>`;
                }

                // å¤„ç†å›¾ç‰‡
                let imagesArr = [];
                try {
                    imagesArr = post_Datas[i].images ? JSON.parse(post_Datas[i].images) : [];
                } catch(error) {
                    console.error('è§£æå›¾ç‰‡æ•°æ®å¤±è´¥:', error);
                    imagesArr = [];
                }

                let picturesHtml = '';
                if (imagesArr.length > 0) {
                    picturesHtml = `<div class="pictures">` +
                        imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                        `</div>`;
                }

                const li = document.createElement('li');
                content.appendChild(li);
       
        li.innerHTML = `
        <div class="mulu-top" style="position:relative;">
        ${deleteBtnHtml}
        <div class="mulu">
        <image class="avatar" src=${post_Datas[i].avatar}></image>
                        <div class="list">
                        <div class="divide_row">
                            <a href="javascript:;" class="uname" data-userid="${post_Datas[i].id_user}">${post_Datas[i].name}</a>
                              </div>
                            <p class="sentences">${post_Datas[i].content}</p>
                            ${picturesHtml}
                            <div class="last">
                                <p class="time">${formatted}</p>
                                <div class="others">
                                    <a href="javascript:;" class="like" data-id="${post_Datas[i].id}">â¤ 0</a>
                                    <a href="javascript:;" class="collect" data-id="${post_Datas[i].id}">â­ æ”¶è—</a>
                                    <a href='javascript:;' class="say" data-id="${post_Datas[i].id}">ğŸ–Š è¯„è®º</a>
                                </div>
                            </div>
                        </div>
        </div>
         <div class="comments hidden" data-id="${post_Datas[i].id}">
                    <div class="inputComment">
                     <textarea id="my" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." maxlength="200"></textarea>
                     <button class="submitComment">å‘é€</button>
                     </div>
                            <div class="otherComments"></div>
                     </div>
                    </div>
                `;

                // è·å–ç‚¹èµæ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
                if (userData) {
                    try {
                        const likeData = await getLikeData(post_Datas[i].id);
                        const likeIcon = li.querySelector('.like');
                        likeIcon.innerHTML = `â¤${likeData.likeCount}`;
                        
                        for (let p in likeData.userIdLike) {
                            if (likeData.userIdLike[p] == userData.id_user) {
                                likeIcon.classList.add('active');
                            }
                        }
                    } catch(error) {
                        console.error('è·å–ç‚¹èµæ•°æ®å¤±è´¥:', error);
                    }
                }

                // è·å–æ”¶è—æ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
                if (userData) {
                    try {
                        const collectPost = await getCollectData();
                        const collectIcon = li.querySelector('.collect');
                        
                        for (let m in collectPost) {
                            if (collectPost[m].id_from_post == post_Datas[i].id) {
                                collectIcon.classList.add('active');
                            }
                        }
                    } catch(error) {
                        console.error('è·å–æ”¶è—æ•°æ®å¤±è´¥:', error);
                    }
                }
            }
        }
    }

    // ç‚¹å‡»æŒ‰çƒ­åº¦æ’åº
    likeDesc.addEventListener('click', () => {
        if (!likeDesc.classList.contains('active')) {
            likeDesc.classList.add('active')
            timeDesc.classList.remove('active')
            getPosts('like')  // åˆ·æ–°ä¸ºæŒ‰ç‚¹èµæ•°
        }
    })

    // ç‚¹å‡»æŒ‰æ—¶é—´æ’åº
    timeDesc.addEventListener('click', () => {
        if (!timeDesc.classList.contains('active')) {
            timeDesc.classList.add('active')
            likeDesc.classList.remove('active')
            getPosts('time')  // åˆ·æ–°ä¸ºæŒ‰æ—¶é—´
        }
    })


 

     //ç„¶åæˆ‘ä»¬è·å–é—®ç­”è´´
     async function getAsk(){
        
        const ask_Datas = await getAllData()
        console.log('alldata',ask_Datas)
       
        //let post_Datas = []
        for(let i in ask_Datas){

            if(ask_Datas[i].type == 'é—®ç­”'){
                const formatted = new Date(ask_Datas[i].time).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                    });

        
        
            ask_Datas.push(allData)
            const content = document.querySelector('.content-next');
        const li = document.createElement(`li`)
        content.appendChild(li)
       
        li.innerHTML = `
        <div class="mulu-top">
        <div class="mulu">
        <image class="avatar" src=${ask_Datas[i].avatar}></image>
                
                        <div class="list">
                        <div class="divide_row">
                            <a href="javascript:;" class="uname" data-userid="${ask_Datas[i].id_user}">${ask_Datas[i].name}</a>
                            
                              </div>
                             <div class="information">
                      
                <div class="divide">
                <image class="touxiang" src=${ask_Datas[i].avatar}></image>
                <p class="name">${ask_Datas[i].name}</p>
                <i class="bi bi-trash" style = "display:none"></i>
                </div>
               
                
                </div>
                            <p class="sentences">${ask_Datas[i].content}</p>
                            <div class="pictures">
                            
                            </div>
                            <div class="last">
                                <p class="time">${formatted}</p>
                                <div class="others">
                                    <a href="javascript:;" class="like" data-id="${i}">â¤0</a>
                                    <a href="javascript:;" class="collect" data-id="${i}">â­Collects</a>
                                    <a href='javascript:;' class="say" data-id="${i}">ğŸ–ŠComments</a>
    
                                    
                                </div>
                            </div>
                        
                            
                        
        </div>
                   
            </div>
           
        `

        }
    }

    }

    

    async function getCollect() {
        const content = document.querySelector('.content-next');
        content.innerHTML = '';
        if (!userData) {
            content.innerHTML = 'è¯·å…ˆç™»å½•';
            return;
        }
        // è·å–æ‰€æœ‰æ”¶è—è®°å½•
        const collectData = await getCollectData();
        // è·å–æ‰€æœ‰å¸–å­
        const allPosts = await getAllData();

        // åªä¿ç•™å½“å‰ç”¨æˆ·æ”¶è—çš„å¸–å­id
        const myCollectIds = collectData
            .filter(item => item.userid_collect == userData.id_user)
            .map(item => item.id_from_post);

        // è¿‡æ»¤å‡ºè¢«æ”¶è—çš„å¸–å­
        const collectPosts = allPosts.filter(post => myCollectIds.includes(post.id));

        if (collectPosts.length === 0) {
            content.innerHTML = 'æš‚æ— æ”¶è—';
            return;
        }

        for (let i in collectPosts) {
            const post = collectPosts[i];
            const formatted = new Date(post.time).toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            // å¤„ç†å›¾ç‰‡
            let imagesArr = [];
            try {
                imagesArr = post.images ? JSON.parse(post.images) : [];
            } catch (error) {
                imagesArr = [];
            }
            let picturesHtml = '';
            if (imagesArr.length > 0) {
                picturesHtml = `<div class="pictures">` +
                    imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                    `</div>`;
            }

            const li = document.createElement('li');
            content.appendChild(li);

            li.innerHTML = `
            <div class="mulu-top" style="position:relative;">
            <div class="mulu">
            <image class="avatar" src=${post.avatar}></image>
                <div class="list">
                    <div class="divide_row">
                        <a href="javascript:;" class="uname" data-userid="${post.id_user}">${post.name}</a>
                    </div>
                    <p class="sentences">${post.content}</p>
                    ${picturesHtml}
                    <div class="last">
                        <p class="time">${formatted}</p>
                        <div class="others">
                            <a href="javascript:;" class="like" data-id="${post.id}">â¤ 0</a>
                            <a href="javascript:;" class="collect active" data-id="${post.id}">â­ æ”¶è—</a>
                            <a href='javascript:;' class="say" data-id="${post.id}">ğŸ–Š è¯„è®º</a>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            `;
            // ç‚¹èµã€æ”¶è—ç­‰åŠŸèƒ½å¯å¤ç”¨getPostsé‡Œçš„é€»è¾‘
        }
    }
  
   
     




// æ£€æŸ¥æœªè¯»æ¶ˆæ¯æ•°é‡å¹¶æ›´æ–°çº¢ç‚¹çŠ¶æ€
async function checkUnreadMessages() {
    try {
        const token = localStorage.getItem('eleToken');
        if (!token) {
            // æœªç™»å½•ï¼Œéšè—çº¢ç‚¹
            const messageDot = document.querySelector('.message-dot');
            if (messageDot) {
                messageDot.style.display = 'none';
            }
            return;
        }

        const response = await axios.get('/api/message', {
            headers: {
                'Authorization': token
            }
        });

        if (response.data.success) {
            const unreadCount = response.data.unreadCount;
            const messageDot = document.querySelector('.message-dot');
            
            if (messageDot) {
                if (unreadCount > 0) {
                    messageDot.style.display = 'inline-block';
                } else {
                    messageDot.style.display = 'none';
                }
            }
        }
    } catch (error) {
        console.error('æ£€æŸ¥æœªè¯»æ¶ˆæ¯å¤±è´¥:', error);
        // å‡ºé”™æ—¶éšè—çº¢ç‚¹
        const messageDot = document.querySelector('.message-dot');
        if (messageDot) {
            messageDot.style.display = 'none';
        }
    }
}

// é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–å†…å®¹
document.addEventListener('DOMContentLoaded', async () => {
    // æ£€æŸ¥æœªè¯»æ¶ˆæ¯å¹¶æ›´æ–°çº¢ç‚¹çŠ¶æ€
    await checkUnreadMessages();
    
    // è·å–å½“å‰URLè·¯å¾„
    const path = window.location.pathname;
    
    // æ ¹æ®è·¯å¾„å†³å®šåŠ è½½ä»€ä¹ˆå†…å®¹
   if (path.includes('/friend')) {
        await loadContent('friend');
    } else if (path.includes('/collect')) {
        await loadContent('collect');
    } else {
        // é»˜è®¤åŠ è½½å¸–å­åˆ—è¡¨
        await loadContent('post');
    }
    
    // æ›´æ–°å¯¼èˆªæ activeçŠ¶æ€
    document.querySelector('.content-next').addEventListener('click', async function(e) {
        const target = e.target;
        const postId = parseInt(target.dataset.id, 10);

        // ç‚¹èµæŒ‰é’®
        if (target.classList.contains('like')) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è·³è½¬åˆ°å¸–å­è¯¦æƒ…é¡µ
            if (!localStorage.getItem('eleToken')) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const userData = JSON.parse(localStorage.getItem('user_data'));
            if (!userData || !userData.id_user) {
                console.error('ç”¨æˆ·æ•°æ®ä¸å®Œæ•´');
                alert('ç”¨æˆ·æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ç™»å½•');
                return;
            }

            try {
                const res = await axios.post('/api/posts/addLike', {
                    userid_like: userData.id_user,
                    id_from_post: postId
                });

                if (res.data.success) {
                    target.classList.toggle('active');
                    const currentCount = parseInt(target.textContent.match(/\d+/)[0]);
                    target.innerHTML = `â¤ ${target.classList.contains('active') ? currentCount + 1 : currentCount - 1}`;

                    const successAlert = document.querySelector('.alert-success');
                    if (successAlert) {
                        successAlert.style.display = 'block';
                        successAlert.textContent = target.classList.contains('active') ? 'ç‚¹èµæˆåŠŸ' : 'å–æ¶ˆç‚¹èµ';
                        setTimeout(() => {
                            successAlert.style.display = 'none';
                        }, 5000);
                    }
                    
                    // æ›´æ–°çº¢ç‚¹çŠ¶æ€
                    await checkUnreadMessages();
                } else {
                    alert(res.data.message);
                }
            } catch (error) {
                console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
                if (error.response) {
                    console.error('å“åº”æ•°æ®:', error.response.data);
                    console.error('å“åº”çŠ¶æ€:', error.response.status);
                    console.error('å“åº”å¤´:', error.response.headers);
                }
                const danger = document.querySelector('.alert-danger');
                if (danger) {
                    danger.textContent = 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•';
                    danger.style.display = 'block';
                    setTimeout(() => {
                        danger.style.display = 'none';
                    }, 5000);
                }
            }
            return;
        }
            
            // æ”¶è—æŒ‰é’®
            if (target.classList.contains('collect')) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è·³è½¬åˆ°å¸–å­è¯¦æƒ…é¡µ
                if (!localStorage.getItem('eleToken')) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }
                
                try {
                    const res = await axios.post('/api/posts/addCollect', {
                        userid_collect: userData.id_user,
                        id_from_post: postId
                    });
                    
                    if (res.data) {
                        target.classList.toggle('active');
                        const currentCount = parseInt(target.textContent.match(/\d+/)[0]);
                        target.innerHTML = `â¤ ${target.classList.contains('active') ? currentCount + 1 : currentCount - 1}`;
                        
                        const successAlert = document.querySelector('.alert-success');
                        if (successAlert) {
                            successAlert.style.display = 'block';
                            successAlert.textContent = target.classList.contains('active') ? 'æ”¶è—æˆåŠŸ' : 'å–æ¶ˆæ”¶è—';
                            setTimeout(() => {
                                successAlert.style.display = 'none';
                            }, 5000);
                        }
                        
                        // æ›´æ–°çº¢ç‚¹çŠ¶æ€
                        await checkUnreadMessages();
                    }
                } catch (error) {
                    console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
                    const danger = document.querySelector('.alert-danger');
                    if (danger) {
                        danger.textContent = 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•';
                        danger.style.display = 'block';
                        setTimeout(() => {
                            danger.style.display = 'none';
                        }, 5000);
                    }
                }
                return;
            }
            
            // åˆ é™¤æŒ‰é’®
            if (target.classList.contains('delete-post-btn') || target.closest('.delete-post-btn')) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è·³è½¬åˆ°å¸–å­è¯¦æƒ…é¡µ
                const deleteBtn = target.classList.contains('delete-post-btn') ? target : target.closest('.delete-post-btn');
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¸–å­å—ï¼Ÿ')) {
                    try {
                        const res = await axios.delete(`/api/posts/${deleteBtn.dataset.id}`);
                        if (res.data) {
                            const postElement = deleteBtn.closest('.mulu-top');
                            postElement.remove();
                            const successAlert = document.querySelector('.alert-success');
                            if (successAlert) {
                                successAlert.style.display = 'block';
                                successAlert.textContent = 'åˆ é™¤æˆåŠŸ';
                                setTimeout(() => {
                                    successAlert.style.display = 'none';
                                }, 5000);
                            }
                        }
                    } catch (error) {
                        console.error('åˆ é™¤å¤±è´¥:', error);
                        const danger = document.querySelector('.alert-danger');
                        if (danger) {
                            danger.textContent = 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•';
                            danger.style.display = 'block';
                            setTimeout(() => {
                                danger.style.display = 'none';
                            }, 5000);
                        }
                    }
                }
                return;
            }
            
            // å›¾ç‰‡ç‚¹å‡»äº‹ä»¶
            if (target.classList.contains('post-image')) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è·³è½¬åˆ°å¸–å­è¯¦æƒ…é¡µ
                const previewImage = document.querySelector('.preview-image');
                const overlay = document.querySelector('.image-preview-overlay');
                if (previewImage && overlay) {
                    previewImage.src = target.src;
                    overlay.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
                return;
            }

            // è¯„è®ºæŒ‰é’®
            if (target.classList.contains('say')) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è·³è½¬åˆ°å¸–å­è¯¦æƒ…é¡µ
                console.log('ç‚¹å‡»äº†è¯„è®ºæŒ‰é’®');
                const postId = target.dataset.id;
                console.log('å¸–å­ID:', postId);
                
                const muluTop = target.closest('.mulu-top');
                console.log('æ‰¾åˆ°çš„mulu-topå…ƒç´ :', muluTop);
                
                if (muluTop) {
                    const cmt = muluTop.querySelector(`.comments[data-id="${postId}"]`);
                    console.log('æ‰¾åˆ°çš„è¯„è®ºåŒºåŸŸå…ƒç´ :', cmt);
                    console.log('è¯„è®ºåŒºåŸŸå½“å‰æ˜¾ç¤ºçŠ¶æ€:', cmt ? cmt.classList.contains('hidden') : 'æœªæ‰¾åˆ°');
                    
                    if (cmt) {
                        console.log('åˆ‡æ¢è¯„è®ºåŒºåŸŸæ˜¾ç¤ºçŠ¶æ€');
                        cmt.classList.toggle('hidden');
                        console.log('åˆ‡æ¢åçš„æ˜¾ç¤ºçŠ¶æ€:', cmt.classList.contains('hidden'));
                        
                        // å¦‚æœè¯„è®ºåŒºåŸŸæ˜¾ç¤ºï¼Œåˆ™åŠ è½½è¯„è®º
                        if (!cmt.classList.contains('hidden')) {
                            try {
                                const res = await axios.get(`/api/posts/${postId}/comments`);
                                const comments = res.data;
                                const otherComments = cmt.querySelector('.otherComments');
                                
                                // 1. åˆ†ç»„
                                const commentMap = {};
                                const rootComments = [];
                                const flatReplies = [];
                                comments.forEach(comment => {
                                    commentMap[comment.idcomments] = comment;
                                    if (!comment.parent_id) {
                                        rootComments.push(comment);
                                    } else {
                                        flatReplies.push(comment);
                                    }
                                });

                                // 2. æ¸²æŸ“
                                function renderReplies(parentId) {
                                    return flatReplies
                                        .filter(reply => reply.parent_id == parentId)
                                        .map(reply => {
                                            let showName = reply.name;
                                            // åˆ¤æ–­æ˜¯å¦æ˜¯"å›å¤çš„å›å¤"
                                            if (reply.parent_id && reply.parent_user_name && commentMap[reply.parent_id] && commentMap[reply.parent_id].parent_id) {
                                                showName = `${reply.name} å›å¤ ${reply.parent_user_name}`;
                                            }
                                            return `
                                                <div class="xijie" data-idcomments="${reply.idcomments}" data-userid="${reply.id_user}" data-parent-id="${reply.parent_id}">
                                                    <image class="avatar1" src=${reply.avatar}></image>
                                                    <div class="exceptA">
                                                        <div class='author-container'>
                                                            <a href="javascript:;" class="name" data-userid="${reply.id_user}">${showName}</a>
                                                        </div>
                                                        <div class="information"></div>
                                                        <p class="words">${reply.content}</p>
                                                        <div class="timesLike">
                                                            <p class="ctime">${reply.time}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('');
                                }

                                function renderComment(comment) {
                                    let html = `
                                        <div class="xijie" data-idcomments="${comment.idcomments}" data-userid="${comment.id_user}" data-parent-id="">
                                            <image class="avatar1" src=${comment.avatar}></image>
                                            <div class="exceptA">
                                                <div class='author-container'>
                                                    <a href="javascript:;" class="name" data-userid="${comment.id_user}">${comment.name}</a>
                                                </div>
                                                <div class="information"></div>
                                                <p class="words">${comment.content}</p>
                                                <div class="timesLike">
                                                    <p class="ctime">${comment.time}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="reply-container" style="margin-left:32px;">
                                            ${renderReplies(comment.idcomments)}
                                        </div>
                                    `;
                                    return html;
                                }

                                if (comments.length === 0) {
                                    otherComments.innerHTML = '<div class="empty-comment">æŠ¢ä¸ªæ²™å‘å§</div>';
                                } else {
                                    otherComments.innerHTML = rootComments.map(renderComment).join('');
                                }

                                // 3. ç»‘å®šç‚¹å‡»äº‹ä»¶
                                const commentItems = otherComments.querySelectorAll('.xijie');
                                commentItems.forEach(item => {
                                    item.addEventListener('click', function(e) {
                                        e.stopPropagation();
                                        const commentId = this.dataset.idcomments;
                                        const commentName = this.querySelector('.name').textContent;
                                        const commentUserId = this.dataset.userid;
                                        const parentId = this.dataset.parentId;

                                        const textarea = cmt.querySelector('textarea');
                                        // åˆ¤æ–­æ˜¯å›å¤è¯„è®ºè¿˜æ˜¯å›å¤å›å¤
                                        if (parentId) {
                                            // å›å¤çš„æ˜¯å›å¤
                                            textarea.placeholder = `å›å¤ ${commentName}ï¼š`;
                                            textarea.dataset.parentId = parentId;
                                            textarea.dataset.parentUserId = commentUserId;
                                        } else {
                                            // å›å¤çš„æ˜¯è¯„è®º
                                            textarea.placeholder = `å›å¤ ${commentName}ï¼š`;
                                            textarea.dataset.parentId = commentId;
                                            textarea.dataset.parentUserId = commentUserId;
                                        }
                                        textarea.focus();
                                    });
                                });

                                // è®¾ç½®è¯„è®ºæäº¤æŒ‰é’®äº‹ä»¶
                                const submitBtn = cmt.querySelector('.submitComment');
                                const textarea = cmt.querySelector('textarea');
                                
                                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                                if (!localStorage.getItem('eleToken')) {
                                    textarea.placeholder = 'è¯·å…ˆç™»å½•åå†è¯„è®º';
                                    submitBtn.disabled = true;
                                    submitBtn.style.cursor = 'not-allowed';
                                    submitBtn.style.opacity = '0.6';
                                } else {
                                    textarea.placeholder = 'è¯´ç‚¹ä»€ä¹ˆå§...';
                                    submitBtn.disabled = false;
                                    submitBtn.style.cursor = 'pointer';
                                    submitBtn.style.opacity = '1';
                                    
                                    submitBtn.onclick = async () => {
                                        const content = textarea.value.trim();
                                        if (!content) {
                                            alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º');
                                            return;
                                        }
                                        
                                        const userData = JSON.parse(localStorage.getItem('user_data'));
                                        if (!userData || !userData.id_user) {
                                            alert('ç”¨æˆ·æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ç™»å½•');
                                            return;
                                        }
                                        
                                        try {
                                            const commentData = {
                                                name: userData.name,
                                                avatar: userData.avatar,
                                                content: content,
                                                id_user: userData.id_user,
                                                id_from_post: postId
                                            };

                                            if (textarea.dataset.parentId) {
                                                commentData.parent_id = textarea.dataset.parentId;
                                                console.log('å‘é€å›å¤ï¼Œparent_id:', commentData.parent_id);
                                            }
                                            if (textarea.dataset.parentUserId) {
                                                commentData.parent_user_id = textarea.dataset.parentUserId;
                                                console.log('å‘é€å›å¤ï¼Œparent_user_id:', commentData.parent_user_id);
                                            }

                                            const res = await axios.post('/api/posts/comments', commentData);
                                            
                                            if (res.data && res.data.success) {
                                                success_alert.style.display = 'block';
                                                success_alert.textContent = 'è¯„è®ºæˆåŠŸ';
                                                setTimeout(() => {
                                                    success_alert.style.display = 'none';
                                                }, 5000);
                                                
                                                // æ·»åŠ æ–°è¯„è®ºåˆ°åˆ—è¡¨
                                                const newComment = document.createElement('div');
                                                newComment.innerHTML = renderComment(res.data);
                                                otherComments.insertBefore(newComment, otherComments.firstChild);
                                                textarea.value = '';
                                                textarea.placeholder = 'è¯´ç‚¹ä»€ä¹ˆå§...';
                                                delete textarea.dataset.parentId;
                                                delete textarea.dataset.parentUserId;
                                            }
                                        } catch (error) {
                                            console.error('è¯„è®ºæäº¤å¤±è´¥:', error);
                                            danger.textContent = 'è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•';
                                            danger.style.display = 'block';
                                            setTimeout(() => {
                                                danger.style.display = 'none';
                                            }, 5000);
                                        }
                                    };
                                }
                            } catch (error) {
                                console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                            }
                        }
                    }
                }
                return;
            }
            
            // ç”¨æˆ·é¡µé¢è·³è½¬
            if (target.classList.contains('uname')) {
                const userId = target.dataset.userid;
                // åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰ç™»å½•ç”¨æˆ·
                if (userData && userId == userData.id_user) {
                    window.location.href = '/personal';
                } else {
                    window.location.href = `/accounts?id=${userId}`;
                }
                return;
            }
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯å¸–å­å®¹å™¨ï¼Œè·³è½¬åˆ°è¯¦æƒ…é¡µ
            const muluTop = target.closest('.mulu-top');
            if (muluTop) {
                const postId = muluTop.querySelector('.like').dataset.id;
                window.location.href = `/post/${postId}`;
            }
        });
        
    });

    // æ·»åŠ å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
    const overlay = document.querySelector('.image-preview-overlay');
    const previewImage = document.querySelector('.preview-image');

    // ç‚¹å‡»é®ç½©å±‚å…³é—­é¢„è§ˆ
    overlay.addEventListener('click', function() {
        overlay.style.display = 'none';
        document.body.style.overflow = '';
    });

    // é˜»æ­¢å›¾ç‰‡ç‚¹å‡»äº‹ä»¶å†’æ³¡
    previewImage.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // æ›´æ–°å¯¼èˆªæ activeçŠ¶æ€
    function updateNavigation(path) {
        // å½’ä¸€åŒ–è·¯å¾„ï¼Œå–æœ€åä¸€æ®µ
        let type = path.split('/').filter(Boolean).pop();
        // å…¼å®¹ /index æˆ– /index/ è¿™ç§æƒ…å†µ
        if (!type || type === 'index') type = 'post';

        const items = document.querySelectorAll('.part a, .menu .part a');
        items.forEach(item => {
            item.classList.remove('active');
            item.style.color = 'black';
            // å–æŒ‰é’®çš„ç±»å‹
            const btnType = item.getAttribute('data-type') || (item.getAttribute('onclick') ? item.getAttribute('onclick').match(/'([^']+)'/)[1] : '');
            if (btnType === type) {
                item.classList.add('active');
                item.style.color = "#e09620";
            }
        });
    }

// æ˜¾ç¤ºæ·»åŠ å†…å®¹å¼¹çª—
function showAdding() {
    document.querySelector('.adding').classList.add('active');
    document.querySelector('.adding_content').style.display = 'block';
}

// å…³é—­æ·»åŠ å†…å®¹å¼¹çª—
function closeAdding() {
    document.querySelector('.adding').classList.remove('active');
    document.querySelector('.adding_content').style.display = 'none';
}

//æäº¤è¡¨å•

Array.from(forms).forEach(form=>{
    form.addEventListener('submit',async(event)=>{
        event.preventDefault();
        event.stopPropagation();

        //æ£€æŸ¥ä¸€ä¸‹å†…å®¹ä¸èƒ½ä¸ºç©º
        const newContent = document.getElementById('content');
        const newType = document.getElementById('contentType');
        
        if(newContent.value.trim()==""){
            danger.textContent = 'å†…å®¹ä¸èƒ½ä¸ºç©º';
            danger.style.display = 'block';
            setTimeout(()=>{
                danger.style.display = 'none';
            },5000);
            return;
        }

        const formData = new FormData();
        formData.append('name', userData.name);
        formData.append('content', newContent.value.trim());
        formData.append('avatar', userData.avatar);
        formData.append('type', newType.value);
        formData.append('id_user', userData.id_user);
        formData.append('time', new Date().toISOString());
        selectedImages.forEach((img, idx) => {
            formData.append('images', img.file);
        });

        try {
            console.log('å‘é€è¯·æ±‚çš„ç”¨æˆ·æ•°æ®:', userData);
            // ä½¿ç”¨å°è£…åçš„requestæ–¹æ³•å‘é€è¯·æ±‚
            const res = await axios.post('/api/posts/add', formData, {
                    headers: {'Content-Type': 'multipart/form-data'}
                    });
            
            console.log('å‘å¸ƒå“åº”:', res);
            
            if(res.data) {
                //æ˜¾ç¤ºæˆåŠŸ
                success_alert.style.display = 'block';
                setTimeout(()=>{
                    success_alert.style.display = 'none';
                },5000);
                // é‡æ–°åŠ è½½å†…å®¹
                await loadContent(newType.value === 'å¸–å­' ? 'post' : 'ask');
                closeAdding();
                // æ¸…ç©ºè¡¨å•
                form.reset();
            }
        } catch(error) {
            console.error('å‘å¸ƒå¤±è´¥:', error);
            danger.textContent = error.response?.data || error.message || 'å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•';
            danger.style.display = 'block';
            setTimeout(()=>{
                danger.style.display = 'none';
            },5000);
        }
    });
});

// å›¾ç‰‡ä¸Šä¼ ä¸é¢„è§ˆ
let selectedImages = [];

const imageInput = document.getElementById('imageInput');
const addImageBtn = document.getElementById('addImageBtn');
const imageGrid = document.getElementById('imageGrid');

addImageBtn.onclick = () => {
    if (selectedImages.length >= 9) return;
    imageInput.click();
};

imageInput.onchange = function(e) {
    const files = Array.from(e.target.files);
    const remain = 9 - selectedImages.length;
    const toAdd = files.slice(0, remain);
    toAdd.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(ev) {
            selectedImages.push({file, url: ev.target.result});
            renderImageGrid();
        };
        reader.readAsDataURL(file);
    });
    imageInput.value = '';
};

function renderImageGrid() {
    imageGrid.innerHTML = '';
    selectedImages.forEach((img, idx) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'image-thumb-wrapper';
        wrapper.innerHTML = `
            <img src="${img.url}" class="image-thumb">
            <button class="image-thumb-delete" data-idx="${idx}">&times;</button>
        `;
        imageGrid.appendChild(wrapper);
    });
    if (selectedImages.length < 9) {
        imageGrid.appendChild(addImageBtn);
    }
    // åˆ é™¤æŒ‰é’®äº‹ä»¶
    imageGrid.querySelectorAll('.image-thumb-delete').forEach(btn => {
        btn.onclick = function() {
            const idx = parseInt(btn.dataset.idx);
            selectedImages.splice(idx, 1);
            renderImageGrid();
        }
    });
}

const sortDropdown = document.querySelector('.sort-dropdown');
const sortToggle = document.querySelector('.sort-toggle');
const twoType = document.querySelector('.sort-dropdown .two_type');

sortToggle.addEventListener('click', function(e) {
    e.stopPropagation();
    sortDropdown.classList.toggle('open');
    if (sortDropdown.classList.contains('open')) {
        twoType.style.display = 'flex';
    } else {
        twoType.style.display = 'none';
    }
});

// ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹è‡ªåŠ¨æ”¶èµ·
document.addEventListener('click', function(e) {
    if (sortDropdown.classList.contains('open')) {
        sortDropdown.classList.remove('open');
        twoType.style.display = 'none';
    }
});

// è·å–å¥½å‹ï¼ˆå…³æ³¨çš„äººï¼‰å‘çš„æ‰€æœ‰å¸–å­
async function getFriend() {
    const content = document.querySelector('.content-next');
    content.innerHTML = '';
    if (!userData) {
        content.innerHTML = 'è¯·å…ˆç™»å½•';
        return;
    }
    // è·å–å½“å‰ç”¨æˆ·å…³æ³¨çš„idåˆ—è¡¨
    const followingStr = userData.following || '';
    const followingArr = followingStr ? followingStr.split(',').filter(id => id.trim() !== '') : [];
    if (followingArr.length === 0) {
        content.innerHTML = 'ä½ è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•äºº';
        return;
    }
    // è·å–æ‰€æœ‰å¸–å­
    const allPosts = await getAllData();
    // è¿‡æ»¤å‡ºè¢«å…³æ³¨ç”¨æˆ·çš„å¸–å­
    const friendPosts = allPosts.filter(post => followingArr.includes(String(post.id_user)));
    if (friendPosts.length === 0) {
        content.innerHTML = 'ä½ å…³æ³¨çš„äººè¿˜æ²¡æœ‰å‘è¿‡å¸–å­';
        return;
    }
    for (let i in friendPosts) {
        const post = friendPosts[i];
        const formatted = new Date(post.time).toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        // å¤„ç†å›¾ç‰‡
        let imagesArr = [];
        try {
            imagesArr = post.images ? JSON.parse(post.images) : [];
        } catch(error) {
            imagesArr = [];
        }
        let picturesHtml = '';
        if (imagesArr.length > 0) {
            picturesHtml = `<div class="pictures">` +
                imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                `</div>`;
        }
        const li = document.createElement('li');
        content.appendChild(li);
        li.innerHTML = `
        <div class="mulu-top" style="position:relative;">
        <div class="mulu">
        <image class="avatar" src=${post.avatar}></image>
            <div class="list">
                <div class="divide_row">
                    <a href="javascript:;" class="uname" data-userid="${post.id_user}">${post.name}</a>
                </div>
                <p class="sentences">${post.content}</p>
                ${picturesHtml}
                <div class="last">
                    <p class="time">${formatted}</p>
                    <div class="others">
                        <a href="javascript:;" class="like" data-id="${post.id}">â¤ 0</a>
                        <a href="javascript:;" class="collect" data-id="${post.id}">â­ æ”¶è—</a>
                        <a href='javascript:;' class="say" data-id="${post.id}">ğŸ–Š è¯„è®º</a>
                    </div>
                </div>
            </div>
        </div>
        </div>
        `;
        // ç‚¹èµã€æ”¶è—ç­‰åŠŸèƒ½å¯å¤ç”¨getPostsé‡Œçš„é€»è¾‘
    }
}

window.addEventListener('popstate', function() {
    const path = window.location.pathname;
    let page = 'post';
    if (path.includes('/friend')) page = 'friend';
    else if (path.includes('/collect')) page = 'collect';
    else if (path.includes('/ask')) page = 'ask';
    loadContent(page);
});

   

       
    </script>
