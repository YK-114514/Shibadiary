<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="../css/index.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="../http.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    </head>
<body>
    <!--header-->
<div class="father">
    
    <div class='header'>
       <div class="header-next">
            <image class="logo" src="../images/logo.png"></image>
            <image class="title" src="../images/title.png"></image>
            <ul class="topics">
                <li >
                    <a href="/index" class="active" data-id="1">è®¨è®ºå°æŸ´</a>
                </li>
                <li>
                    <a data-id="2" >æˆ‘çš„å°æŸ´</a>
                </li>
                <li >
                    <a data-id="3">å°æŸ´æ‰‹å†Œ</a>
                </li>
            </ul>
          <div class="login-header">
            <a href="/login" class="before-login">ç™»å½•</a>
            <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#userInfo" style="display:none">
                æ¬¢è¿ï¼Œ
            </button>
            <div class="collapse mt-3" id="userInfoShowing" style="display:none">
                <a href="/personal" class="card card-body" id="personal">
                    ä¸ªäººä¿¡æ¯
                </a>
                <a href="javascript:;" class="card card-body" id="logout">
                    é€€å‡ºç™»å½•
                </a>
              </div>
           </div>
           
        </div>

</div>

<div class="content">
    <div class="sort-dropdown">
        <button class="sort-toggle">
            
            <span class="arrow">&#9660;</span>
        </button>
        <div class="two_type" style="display: none;">
            <a href="javascript:;" id="likeDesc" class="active">æœ€çƒ­</a>
            <a href="javascript:;" id="timeDesc">æœ€æ–°</a>
        </div>
    </div>
    <ul class="content-next">
    </ul>
    <!-- æ·»åŠ åˆ†é¡µç»„ä»¶ -->
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item">
                <a class="page-link" href="javascript:;" id="prevPage" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            <li class="page-item">
                <span class="page-link" id="currentPageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
            </li>
            <li class="page-item">
                <a class="page-link" href="javascript:;" id="nextPage" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
</div>


<!--å·¦ä¾§èœå•æ -->

<div class="next">
    <div class="menu">
        <div class="menu-next">
            <ul class="part">
               
                    <a href="javascript:;" onclick="navigate('post')" class="active" data-id="1">Posts</a>
                
              
                    <a href="javascript:;" onclick="navigate('ask')" data-id="2">Questions</a>
               
                    <a href="javascript:;" onclick="navigate('friends')" data-id="3">Friends</a>
                
                    <a href="javascript:;" onclick="navigate('collect')" data-id="4">Collects</a>
               

            </ul>
        </div>
        <!-- æ·»åŠ å†…å®¹æŒ‰é’® -->

    <img class='adding' src="../images/add.png" alt="æ·»åŠ " onclick="showAdding()">


<!-- æ·»åŠ å†…å®¹å¼¹çª— -->
<div class="adding_content" style="display:none">
    <div class="top_new">
        <h3 class="title">æ·»åŠ å†…å®¹</h3>
        <a href="javascript:;" class="out" onclick="closeAdding()">Ã—</a>
    </div>
    <form id="contentForm" class="row g-3 needs-validation" novalidate enctype="multipart/form-data">
        <div class="mb-3">
            <label for="contentType" class="form-label">ç±»å‹</label>
            <select class="form-control" id="contentType" required>
                <option value="å¸–å­">å¸–å­</option>
                <option value="é—®ç­”">é—®ç­”</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="content" class="form-label">å†…å®¹</label>
            <textarea class="form-control" id="content" rows="3" required></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">å›¾ç‰‡ï¼ˆæœ€å¤š9å¼ ï¼‰</label>
            <div class="image-upload-area" id="imageUploadArea">
                <input type="file" id="imageInput" accept="image/*" multiple style="display:none">
                <div class="image-grid" id="imageGrid">
                    <div class="add-image-btn" id="addImageBtn">+</div>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-secondary">å‘å¸ƒ</button>
    </form>
</div>
<div class="alert alert-success" role="alert" style="display:none">
    å‘å¸ƒæˆåŠŸ
</div>
<div class="alert alert-danger" role="alert" style="display:none">
    å‘å¸ƒå¤±è´¥ï¼
</div>

    </div>
</body>
    <script >
        const userD = sessionStorage.getItem('user_data');
        let userData = null;
        try {
            userData = userD ? JSON.parse(userD) : null;
        } catch (e) {
            console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
        }
        //ç™»å½•å‰å
        const logining = document.querySelector('.login-header .before-login')
        const showing = document.querySelector('.btn-primary')
        const showing_content = document.getElementById('userInfoShowing')
        const logout_click = document.getElementById('logout')
        const addingImg = document.querySelector('.adding')
        const forms = document.querySelectorAll('.needs-validation');
        const danger = document.querySelector('.alert-danger');
        const success_alert = document.querySelector('.alert-success');

        let isShow = false;
        if(!localStorage.getItem('eleToken') || !userData){
            logining.style.display = 'block'
            showing.style.display = 'none'
            showing_content.style.display = 'none'
        }else{
            logining.style.display = 'none'
            showing.style.display = 'block'
            showing.innerHTML = `æ¬¢è¿ï¼Œ${userData.name}`

            //ç‚¹å‡»æ˜¾ç¤º
            showing.addEventListener('click',()=>{
                if(!isShow){
                    isShow = true;
                    showing_content.style.display = 'block'
                }else{
                    isShow = false;
                    showing_content.style.display = 'none'
                }
            })

            //é€€å‡ºç™»å½•
            logout_click.addEventListener('click',()=>{
                localStorage.removeItem('eleToken');
                sessionStorage.clear();
                // æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
                logining.style.display = 'block';
                showing.style.display = 'none';
                showing_content.style.display = 'none';
                isShow = false;
            })

            
        }

        //addingæ˜¯å¦æ˜¾ç¤º
        if(localStorage.getItem('eleToken')){
            addingImg.style.display='block'
        }else{
            addingImg.style.display='none'
        }
         //loadcontent è®¾ç½®
         async function loadContent(page) {
            const content = document.querySelector('.content-next');
            

            try {
                switch(page) {
                    case 'post':
                        content.innerHTML = ""
                        await getPosts('like');
                        break;
                    case 'ask':
                        content.innerHTML = ""
                        await getAsk();
                        break;
                    case 'friend':
                        content.innerHTML = ''
                        content.innerHTML = '<h2>å¥½å‹åˆ—è¡¨</h2><p>æ·»åŠ å°ä¼™ä¼´ï½</p>';
                        break;
                    case 'collect':
                        content.innerHTML = ''
                        await getCollect()
                        break;
                   
                }
            } catch (error) {
                console.error('åŠ è½½å†…å®¹å¤±è´¥:', error);
                content.innerHTML = '<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            }
        }

        //åˆ‡æ¢åœ°å€æ 
        function navigate(page) {
            // ä¿®æ”¹åœ°å€æ URLï¼Œä½†ä¸ä¼šåˆ·æ–°é¡µé¢
            history.pushState({}, '', `/index/${page}`);
            // æ›´æ–°å¯¼èˆªæ activeçŠ¶æ€
             updateNavigation(page);

            // æ ¹æ®pageæ›´æ–°å†…å®¹
            loadContent(page);
        }

       

        //è·å–å…¨éƒ¨èµ„æ–™å…ˆ
        
        let allData = []; // å­˜å‚¨æ‰€æœ‰æ•°æ®
       async function getAllData(){
        try {
            const res = await axios.get('/api/posts/index');
            allData = res.data; // ä¿å­˜æ•°æ®åˆ°å…¨å±€å˜é‡
            return res.data;  // è¿”å›çœŸæ­£çš„æ•°æ®ï¼
        } catch (error) {
            console.error('è·å–æ•°æ®å¤±è´¥:', error);
            return []; // å¤±è´¥æ—¶è¿”å›ç©ºæ•°ç»„
        }
       
       }
       getAllData().then((allTable)=>{
        console.log(allTable)
       })

       //æŒ‰ç…§ç‚¹èµçƒ­åº¦æ¥æ’åº
       let allDataLikeDesc = []
       async function getLikeDesc(){
        try{
            const res = await axios.get('/api/posts/indexLike')
            allDataLikeDesc = res.data
            return allDataLikeDesc
        }catch(error){
            console.log(error)
            return []
        }
       }

       //æ”¶è—
       let allCollect = []

    async function getCollectData(){
        try{
            const res = await axios.get('/api/posts/collect')
            allCollect = res.data
            
            return(allCollect)
        }catch(error){
            console.log(error.message)
            return []
        }

    }
    getCollectData().then(allC=>console.log(allC))

    //é¦–å…ˆçœ‹æ˜¯å¦æ˜¯æŒ‰çƒ­åº¦/æŒ‰ç‚¹èµ

    const likeDesc = document.getElementById('likeDesc')
    const timeDesc = document.getElementById('timeDesc')
    const content = document.querySelector('.content-next')

    
      
      

       //ç„¶åæˆ‘ä»¬è·å–çƒ­é—¨è´´
       async function getPosts(sortBy){

        //é¦–å…ˆçœ‹æ˜¯å¦æ˜¯æŒ‰çƒ­åº¦/æŒ‰ç‚¹èµ

       
        let post_Datas = []

        if (sortBy === 'like') {
            post_Datas = await getLikeDesc()  
            console.log(sortBy) // æ ¹æ®ç‚¹èµæ•°æ’åºçš„å¸–å­
        } else {
            post_Datas = await getAllData()  
            console.log(sortBy)  // æ ¹æ®æ—¶é—´æ’åºçš„å¸–å­
        }
    

        /*likeDesc.addEventListener('click',()=>{
            if(!likeDesc.classList.contains('active')){
                likeDesc.classList.add('active')
                timeDesc.classList.remove('active')
            }
        })

        timeDesc.addEventListener('click',()=>{
            if(!timeDesc.classList.contains('active')){
                timeDesc.classList.add('active')
                likeDesc.classList.remove('active')
            }
        })
        

        if(likeDesc.classList.contains('active')){
            post_Datas = await getLikeDesc()
        }else{

            post_Datas = await getAllData()

        }*/

        content.innerHTML=""
        
       
    
        console.log('alldata',post_Datas)
       
        //let post_Datas = []
        for(let i in post_Datas){

            if(post_Datas[i].type == 'å¸–å­'){
                const formatted = new Date(post_Datas[i].time).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                    });

                // åˆ¤æ–­æ˜¯å¦ä¸ºè´´ä¸»
                let deleteBtnHtml = '';
                if (userData && post_Datas[i].id_user == userData.id_user) {
                    deleteBtnHtml = `<button class="btn btn-link btn-sm delete-post-btn" data-id="${post_Datas[i].id}" style="position:absolute;top:8px;right:8px;z-index:10;"><i class="bi bi-trash" style="font-size:20px;color:#e74c3c;"></i></button>`;
                }

                // å‡è®¾ post_Datas[i].images æ˜¯ JSON å­—ç¬¦ä¸²
                let imagesArr = [];
                try {
                    imagesArr = post_Datas[i].images ? JSON.parse(post_Datas[i].images) : [];
                } catch(e) {
                    imagesArr = [];
                }

                let picturesHtml = '';
                if (imagesArr.length > 0) {
                    picturesHtml = `<div class="pictures">` +
                        imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                        `</div>`;
                }

        
        
            post_Datas.push(allData)
            //const content = document.querySelector('.content-next');
        const li = document.createElement(`li`)
        content.appendChild(li)
       
        li.innerHTML = `
        <div class="mulu-top" style="position:relative;">
        ${deleteBtnHtml}
        <div class="mulu">
        <image class="avatar" src=${post_Datas[i].avatar}></image>
                
                        <div class="list">
                        <div class="divide_row">
                            <a href="javascript:;" class="uname">${post_Datas[i].name}</a>
                            
                              </div>
                             
                             
                            <p class="sentences">${post_Datas[i].content}</p>
                            ${picturesHtml}
                            <div class="last">
                                <p class="time">${formatted}</p>
                                <div class="others">
                                    <a href="javascript:;" class="like" data-id="${post_Datas[i].id}">â¤ 0</a>
                                    <a href="javascript:;" class="collect" data-id="${post_Datas[i].id}">â­ æ”¶è—</a>
                                    <a href='javascript:;' class="say" data-id="${post_Datas[i].id}">ğŸ–Š è¯„è®º</a>
    
                                    
                                </div>
                            </div>
                        
                            
                        </div>
                        
                            
                        
        </div>
         <div class="comments hidden" data-id="${post_Datas[i].id}">
                    <div class="inputComment">
                     <textarea id="my" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." maxlength="200"></textarea>
                     <button class="submitComment">å‘é€</button>
                     </div>
                     <div class="otherComments">
                    
                     </div>
                    
                                      
    
                    </div>
                   
            </div>
           
        `
         //è¯„è®ºåŒº
         async function getComments(){
            try {
                    const res = await axios.get(`/api/posts/${post_Datas[i].id}/comments`);
                    allComments = res.data; // ä¿å­˜æ•°æ®åˆ°å…¨å±€å˜é‡
                    return res.data;  // è¿”å›çœŸæ­£çš„æ•°æ®ï¼
                } catch (error) {
                    console.error('è·å–æ•°æ®å¤±è´¥:', error);
                    return []; // å¤±è´¥æ—¶è¿”å›ç©ºæ•°ç»„
                }
        }

        getComments().then((allC)=>{
            console.log(allC)
        })
    

        //è®¾ç½®è¯„è®ºåŒº

        const commentValueRemen = li.querySelector(`.comments textarea`)
        const commentSubmitRemen = li.querySelector(`.comments .submitComment`)
        const showComments = await getComments()
        let commentRemen = li.querySelector(`.otherComments`)

         //é¦–å…ˆï¼Œå¦‚æœeletokenæ²¡æœ‰çš„è¯ï¼Œæˆ‘ä»¬ä¸èƒ½å‘è¡¨è¯„è®º
         if(!localStorage.getItem('eleToken')){
                commentValueRemen.placeholder = 'è¯·å…ˆç™»å½•'
                commentSubmitRemen.disabled = true
         }
        if(showComments.length == 0){
            commentRemen.innerHTML = `æŠ¢ä¸ªæ²™å‘å§`
            
        }else{
            for(let n in showComments){
            const liComment = document.createElement('li')
            commentRemen.appendChild(liComment)
            liComment.innerHTML = `
            
                    <div class="xijie">
                        <image class="avatar1" src=${showComments[n].avatar}></image>
                            <div class="exceptA">
                            <div class='author-container'>
                                <a href="javascript:;" class="name">${showComments[n].name}</a>
                                   
                                </div>
                                  <div class="information">
                                </div>
                                <p class="words" >${showComments[n].content}</p>
                                <div class="timesLike">
                                    <p class="ctime">${showComments[n].time}</p>
                                </div>
                            </div>
                          
                    </div>
                     <div class="reply-container">

                        </div>
                    
                      
                    `
            }
        }
          //è¯„è®ºåŒº
        document.querySelector('.content-next').addEventListener('click', function(e) {
            // è¯„è®ºæŒ‰é’®
            if (e.target.classList.contains('say')) {
                const postId = e.target.dataset.id;
                const muluTop = e.target.closest('.mulu-top');
                if (muluTop) {
                    const cmt = muluTop.querySelector(`.comments[data-id=\"${postId}\"]`);
                    if (cmt) {
                        cmt.classList.toggle('hidden');
                    }
                }
            }
            // ç”¨æˆ·å
            if (e.target.classList.contains('uname')) {
                const muluTop = e.target.closest('.mulu-top');
                const postId = muluTop.querySelector('.say').dataset.id;
                const post = post_Datas.find(p => p.id == postId);
                if (post) {
                    if (userData && post.id_user == userData.id_user) {
                        window.location.href = '/personal';
                    } else {
                        window.location.href = `/accounts?id=${post.id_user}`;
                    }
                }
            }
            // åˆ é™¤æŒ‰é’®
            if (e.target.closest('.delete-post-btn')) {
                const btn = e.target.closest('.delete-post-btn');
                const postId = btn.dataset.id;
                if (window.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¸–å­å—ï¼Ÿ')) {
                    axios.delete(`/api/posts/${postId}`)
                        .then(res => {
                            alert('åˆ é™¤æˆåŠŸ');
                            window.location.reload();
                        })
                        .catch(err => {
                            alert('åˆ é™¤å¤±è´¥');
                        });
                }
            }
        });

    //å‘å¸ƒè¯„è®º
   
        commentSubmitRemen.addEventListener('click', async function() {
    const content = commentValueRemen.value.trim()  // è·å–è¯„è®ºå†…å®¹

    if (!content) {
        alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º')
        return
    }

    // å‡†å¤‡è¯„è®ºæ•°æ®
    const commentData = {
        name: userData.name,
        avatar: userData.avatar,
        content: content,
        id_user: userData.id_user,
        id_from_post: post_Datas[i].id
    }

    try {
        // å‘é€POSTè¯·æ±‚
        const res = await axios.post(`/api/posts/comments`, commentData)

        if (res.data && res.data.success) {
            success_alert.style.display = 'block';
                setTimeout(()=>{
                    success_alert.style.display = 'none';
                },5000);
            // å¯ä»¥åœ¨è¿™é‡ŒæŠŠæ–°è¯„è®ºç›´æ¥æ’å…¥åˆ°è¯„è®ºåŒºï¼ˆä¸ç”¨åˆ·æ–°é¡µé¢ï¼‰
            const liComment = document.createElement('li')
            commentRemen.appendChild(liComment)
            liComment.innerHTML = `
                <div class="xijie">
                    <img class="avatar1" src="${userData.avatar}">
                    <div class="exceptA">
                        <div class='author-container'>
                            <a href="javascript:;" class="name">${userData.name}</a>
                            
                        </div>
                        <div class="information"></div>
                        <p class="words">${content}</p>
                        <div class="timesLike">
                            <p class="ctime">åˆšåˆš</p>
                        </div>
                    </div>
                </div>
                <div class="reply-container"></div>
            `
            commentValueRemen.value = ''  // æ¸…ç©ºè¾“å…¥æ¡†
        } else {
            danger.textContent = 'è¯„è®ºå¤±è´¥';
            danger.style.display = 'block';
            setTimeout(()=>{
                danger.style.display = 'none';
            },5000);
            return;
        }
    } catch (error) {
        console.error('è¯„è®ºæäº¤å¤±è´¥:', error)
        alert('æœåŠ¡å™¨é”™è¯¯ï¼Œç¨åå†è¯•')
    }
})

    //æ”¶è—
    const collectIcon = li.querySelector('.collect')
    collectIcon.addEventListener('click', async()=>{
        collectIcon.classList.toggle('active')
       try{ const res = await axios.post('/api/posts/addCollect',{
            userid_collect:userData.id_user,
            id_from_post:post_Datas[i].id
        })
      
               
            if(res.data) {
                //æ˜¾ç¤ºæˆåŠŸ
                success_alert.style.display = 'block';
                success_alert.textContent = 'æ“ä½œæˆåŠŸ'
                setTimeout(()=>{
                    success_alert.style.display = 'none';
                },5000);
               
            }

        
    }catch(error){
        console.error('æ”¶è—å¤±è´¥:', error);
            danger.textContent = error.response?.data || error.message || 'æ”¶è—å¤±è´¥ï¼Œè¯·é‡è¯•';
            danger.style.display = 'block';
            setTimeout(()=>{
                danger.style.display = 'none';
            },5000);

    }
        
    })

    //è¡¨ç¤ºå‡ºæ˜¯å¦æ”¶è—
    const collectPost = await getCollectData()
    if(userData){
    for(let m in collectPost){
        if(collectPost[m].id_from_post == post_Datas[i].id){
            console.log('test',post_Datas[i].id)
            collectIcon.classList.add('active')


        }
    }
}

    //ç‚¹èµ
    const likeIcon = li.querySelector('.like')
    likeIcon.addEventListener('click',async()=>{
        let likeCount = parseInt(likeIcon.innerText.slice(1)) 
        //console.log('ç‚¹èµ')
        if (likeIcon.classList.contains('active')) {
            likeCount -= 1
            likeIcon.innerHTML = `â¤${likeCount}`
        } else {
            likeCount += 1
            likeIcon.innerHTML = `â¤${likeCount}`
        }
        likeIcon.classList.toggle('active')
       

        try{
            const res = await axios.post('/api/posts/addLike',{
            userid_like:userData.id_user,
            id_from_post:post_Datas[i].id
        })
        
               
            if(res.data) {
                //æ˜¾ç¤ºæˆåŠŸ
                success_alert.style.display = 'block';
                success_alert.textContent = 'æ“ä½œæˆåŠŸ'
                setTimeout(()=>{
                    success_alert.style.display = 'none';
                },5000);
               
            }

        


        }catch(error){
            console.error('æ“ä½œå¤±è´¥:', error);
            danger.textContent = error.response?.data || error.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•';
            danger.style.display = 'block';
            setTimeout(()=>{
                danger.style.display = 'none';
            },5000);

        }

    })

    //æ˜¾ç¤ºç‚¹èµ
    let allLike = []
    async function getLikeData(){
        try{
            const res = await axios.get(`/api/posts/like/${post_Datas[i].id}`)
            allLike = res.data
            return allLike
        }catch(error){
            console.log(error)
            return []

        }
    }
    if(userData){
    const likeData = await getLikeData()
    console.log(likeData)
    likeIcon.innerHTML = `â¤${likeData.likeCount}`
    for(let p in likeData.userIdLike){
        if(likeData.userIdLike[p] == userData.id_user){
            likeIcon.classList.add('active')
        }
    }
}

      
    




   
   



        }

    }

    }
    // ç‚¹å‡»æŒ‰çƒ­åº¦æ’åº
    likeDesc.addEventListener('click', () => {
        if (!likeDesc.classList.contains('active')) {
            likeDesc.classList.add('active')
            timeDesc.classList.remove('active')
            getPosts('like')  // åˆ·æ–°ä¸ºæŒ‰ç‚¹èµæ•°
        }
    })

    // ç‚¹å‡»æŒ‰æ—¶é—´æ’åº
    timeDesc.addEventListener('click', () => {
        if (!timeDesc.classList.contains('active')) {
            timeDesc.classList.add('active')
            likeDesc.classList.remove('active')
            getPosts('time')  // åˆ·æ–°ä¸ºæŒ‰æ—¶é—´
        }
    })


 

     //ç„¶åæˆ‘ä»¬è·å–é—®ç­”è´´
     async function getAsk(){
        
        const ask_Datas = await getAllData()
        console.log('alldata',ask_Datas)
       
        //let post_Datas = []
        for(let i in ask_Datas){

            if(ask_Datas[i].type == 'é—®ç­”'){
                const formatted = new Date(ask_Datas[i].time).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                    });

        
        
            ask_Datas.push(allData)
            const content = document.querySelector('.content-next');
        const li = document.createElement(`li`)
        content.appendChild(li)
       
        li.innerHTML = `
        <div class="mulu-top">
        <div class="mulu">
        <image class="avatar" src=${ask_Datas[i].avatar}></image>
                
                        <div class="list">
                        <div class="divide_row">
                            <a href="javascript:;" class="uname">${ask_Datas[i].name}</a>
                            
                              </div>
                             <div class="information">
                      
                <div class="divide">
                <image class="touxiang" src=${ask_Datas[i].avatar}></image>
                <p class="name">${ask_Datas[i].name}</p>
                <i class="bi bi-trash" style = "display:none"></i>
                </div>
               
                
                </div>
                            <p class="sentences">${ask_Datas[i].content}</p>
                            <div class="pictures">
                            
                            </div>
                            <div class="last">
                                <p class="time">${formatted}</p>
                                <div class="others">
                                    <a href="javascript:;" class="like" data-id="${i}">â¤0</a>
                                    <a href="javascript:;" class="collect" data-id="${i}">â­Collects</a>
                                    <a href='javascript:;' class="say" data-id="${i}">ğŸ–ŠComments</a>
    
                                    
                                </div>
                            </div>
                        
                            
                        </div>
                        
                            
                        
        </div>
                   
            </div>
           
        `

        }
    }

    }

    

    async function getCollect(){
        const content = document.querySelector('.content-next');
        const collectData = await getCollectData()
        const allDataCollect = await getAllData()
        console.log(collectData)
        if(!localStorage.getItem('eleToken')){
            content.innerHTML = 'è¯·å…ˆç™»å½•'
        }else{
        if(collectData.length == 0){
            content.innerHTML = 'æš‚æ— æ”¶è—'
        }else{
        for(let i in collectData){
            if(collectData[i].userid_collect == userData.id_user){
               
                console.log('this is post infom',allDataCollect.find(item=>item.id==collectData[i].id_from_post))
                const tempObj = allDataCollect.find(item=>item.id == collectData[i].id_from_post )
                const formatted = new Date(tempObj.time).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                    });

                
                const li = document.createElement(`li`)
                content.appendChild(li)
            
                li.innerHTML = `
                <div class="mulu-top">
                <div class="mulu">
                <image class="avatar" src=${tempObj.avatar}></image>
                        
                                <div class="list">
                                <div class="divide_row">
                                    <a href="javascript:;" class="uname">${tempObj.name}</a>
                                    
                                    </div>
                                    
                                    
                                    <p class="sentences">${tempObj.content}</p>
                                    <div class="pictures">
                                    
                                    </div>
                                    <div class="last">
                                        <p class="time">${formatted}</p>
                                        <div class="others">
                                            <a href="javascript:;" class="like" data-id="${tempObj.id}">â¤0</a>
                                            <a href="javascript:;" class="collect" data-id="${tempObj.id}">â­Collects</a>
                                            <a href='javascript:;' class="say" data-id="${tempObj.id}">ğŸ–ŠComments</a>
            
                                            
                                        </div>
                                    </div>
                                
                                    
                                </div>
                                
                                    
                                
                </div>
                <div class="comments hidden" data-id="${tempObj.id}">
                            <div class="inputComment">
                            <textarea id="my" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." maxlength="200"></textarea>
                            <button class="submitComment">å‘é€</button>
                            </div>
                            <div class="otherComments">
                            
                            </div>
                            
                                            
            
                            </div>
                        
                    </div>
                
                `
                const collectIcon = li.querySelector('.collect')
    collectIcon.addEventListener('click', async()=>{
        collectIcon.classList.toggle('active')

       try{ const res = await axios.post('/api/posts/addCollect',{
            userid_collect:userData.id_user,
            id_from_post:tempObj.id
        })
        if(res.data){
               
            if(res.data) {
                //æ˜¾ç¤ºæˆåŠŸ
                success_alert.style.display = 'block';
                success_alert.textContent = 'æ”¶è—æˆåŠŸ'
                setTimeout(()=>{
                    success_alert.style.display = 'none';
                },5000);
               
            }

        }
            }catch(error){
                console.error('æ”¶è—å¤±è´¥:', error);
                    danger.textContent = error.response?.data || error.message || 'æ”¶è—å¤±è´¥ï¼Œè¯·é‡è¯•';
                    danger.style.display = 'block';
                    setTimeout(()=>{
                        danger.style.display = 'none';
                    },5000);

            }
                
            })

            //è¡¨ç¤ºå‡ºæ˜¯å¦æ”¶è—
            collectIcon.classList.add('active')

        
      

                    }
                }
            }
        }

    }
  
   
     




// é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–å†…å®¹
document.addEventListener('DOMContentLoaded', async () => {
    // è·å–å½“å‰URLè·¯å¾„
    const path = window.location.pathname;
    
    // æ ¹æ®è·¯å¾„å†³å®šåŠ è½½ä»€ä¹ˆå†…å®¹
    if (path.includes('/ask')) {
        await loadContent('ask');
    } else if (path.includes('/friends')) {
        await loadContent('friend');
    } else if (path.includes('/collects')) {
        await loadContent('collects');
    } else {
        // é»˜è®¤åŠ è½½å¸–å­åˆ—è¡¨
        await loadContent('post');
    }
    
    // æ›´æ–°å¯¼èˆªæ activeçŠ¶æ€
    updateNavigation(path);
});

// æ›´æ–°å¯¼èˆªæ activeçŠ¶æ€
function updateNavigation(path) {
    const items = document.querySelectorAll('.part a');
    items.forEach(item => {
        item.classList.remove('active');
        item.style.color = 'black'
        const type = item.getAttribute('onclick').match(/'([^']+)'/)[1];
       
        if (path.includes(type)) {
            item.classList.add('active');
            item.style.color = "#e09620"
        } 
    });
}

// æ˜¾ç¤ºæ·»åŠ å†…å®¹å¼¹çª—
function showAdding() {
    document.querySelector('.adding').classList.add('active');
    document.querySelector('.adding_content').style.display = 'block';
}

// å…³é—­æ·»åŠ å†…å®¹å¼¹çª—
function closeAdding() {
    document.querySelector('.adding').classList.remove('active');
    document.querySelector('.adding_content').style.display = 'none';
}

//æäº¤è¡¨å•

Array.from(forms).forEach(form=>{
    form.addEventListener('submit',async(event)=>{
        event.preventDefault();
        event.stopPropagation();

        //æ£€æŸ¥ä¸€ä¸‹å†…å®¹ä¸èƒ½ä¸ºç©º
        const newContent = document.getElementById('content');
        const newType = document.getElementById('contentType');
        
        if(newContent.value.trim()==""){
            danger.textContent = 'å†…å®¹ä¸èƒ½ä¸ºç©º';
            danger.style.display = 'block';
            setTimeout(()=>{
                danger.style.display = 'none';
            },5000);
            return;
        }

        const formData = new FormData();
        formData.append('name', userData.name);
        formData.append('content', newContent.value.trim());
        formData.append('avatar', userData.avatar);
        formData.append('type', newType.value);
        formData.append('id_user', userData.id_user);
        formData.append('time', new Date().toISOString());
        selectedImages.forEach((img, idx) => {
            formData.append('images', img.file);
        });

        try {
            console.log('å‘é€è¯·æ±‚çš„ç”¨æˆ·æ•°æ®:', userData);
            // ä½¿ç”¨å°è£…åçš„requestæ–¹æ³•å‘é€è¯·æ±‚
            const res = await axios.post('/api/posts/add', formData, {
                    headers: {'Content-Type': 'multipart/form-data'}
                    });
            
            console.log('å‘å¸ƒå“åº”:', res);
            
            if(res.data) {
                //æ˜¾ç¤ºæˆåŠŸ
                success_alert.style.display = 'block';
                setTimeout(()=>{
                    success_alert.style.display = 'none';
                },5000);
                // é‡æ–°åŠ è½½å†…å®¹
                await loadContent(newType.value === 'å¸–å­' ? 'post' : 'ask');
                closeAdding();
                // æ¸…ç©ºè¡¨å•
                form.reset();
            }
        } catch(error) {
            console.error('å‘å¸ƒå¤±è´¥:', error);
            danger.textContent = error.response?.data || error.message || 'å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•';
            danger.style.display = 'block';
            setTimeout(()=>{
                danger.style.display = 'none';
            },5000);
        }
    });
});

// å›¾ç‰‡ä¸Šä¼ ä¸é¢„è§ˆ
let selectedImages = [];

const imageInput = document.getElementById('imageInput');
const addImageBtn = document.getElementById('addImageBtn');
const imageGrid = document.getElementById('imageGrid');

addImageBtn.onclick = () => {
    if (selectedImages.length >= 9) return;
    imageInput.click();
};

imageInput.onchange = function(e) {
    const files = Array.from(e.target.files);
    const remain = 9 - selectedImages.length;
    const toAdd = files.slice(0, remain);
    toAdd.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(ev) {
            selectedImages.push({file, url: ev.target.result});
            renderImageGrid();
        };
        reader.readAsDataURL(file);
    });
    imageInput.value = '';
};

function renderImageGrid() {
    imageGrid.innerHTML = '';
    selectedImages.forEach((img, idx) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'image-thumb-wrapper';
        wrapper.innerHTML = `
            <img src="${img.url}" class="image-thumb">
            <button class="image-thumb-delete" data-idx="${idx}">&times;</button>
        `;
        imageGrid.appendChild(wrapper);
    });
    if (selectedImages.length < 9) {
        imageGrid.appendChild(addImageBtn);
    }
    // åˆ é™¤æŒ‰é’®äº‹ä»¶
    imageGrid.querySelectorAll('.image-thumb-delete').forEach(btn => {
        btn.onclick = function() {
            const idx = parseInt(btn.dataset.idx);
            selectedImages.splice(idx, 1);
            renderImageGrid();
        }
    });
}

const sortDropdown = document.querySelector('.sort-dropdown');
const sortToggle = document.querySelector('.sort-toggle');
const twoType = document.querySelector('.sort-dropdown .two_type');

sortToggle.addEventListener('click', function(e) {
    e.stopPropagation();
    sortDropdown.classList.toggle('open');
    if (sortDropdown.classList.contains('open')) {
        twoType.style.display = 'flex';
    } else {
        twoType.style.display = 'none';
    }
});

// ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹è‡ªåŠ¨æ”¶èµ·
document.addEventListener('click', function(e) {
    if (sortDropdown.classList.contains('open')) {
        sortDropdown.classList.remove('open');
        twoType.style.display = 'none';
    }
});

   

       
    </script>
