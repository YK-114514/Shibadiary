<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="../css/index.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="../http.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&display=swap" rel="stylesheet">
    </head>
<body>
    <!-- å¼•å…¥headerç»„ä»¶ -->
    <div class="father">
    
        <div class='header'>
           <div class="header-next">
                <image class="logo" src="../images/logo.png"></image>
                <image class="title" src="../images/title.png"></image>
                <ul class="topics">
                    <li >
                        <a href="/index" class="active" data-id="1">å® ç‰©åšå®¢</a>
                    </li>
                    <li>
                        <a data-id="2" style="opacity: 0.5; cursor: not-allowed; pointer-events: none;" title="åŠŸèƒ½å¼€å‘ä¸­">å® ç‰©é—®ç­”</a>
                    </li>
                  
                </ul>
              <div class="login-header">
                <a href="/login" class="before-login">ç™»å½•</a>
                <a href="javascript:;" class="user-menu" style="display:none">
                    æ¬¢è¿ï¼Œ<span class="username"></span>
                   
                </a>
                <div class="user-dropdown">
                    <a href="/personal">ä¸ªäººä¿¡æ¯</a>
                    <a href="/message">æ¶ˆæ¯ä¸­å¿ƒ<span class="message-dot"></span></a>
                    <a href="javascript:;" id="logout">é€€å‡ºç™»å½•</a>
                </div>
               </div>
               
            </div>
        </div>
    

    <!-- å·¦ä¾§èœå•æ -->
    <div class="next">
        <div class="menu">
            <div class="menu-next">
                <ul class="part">
                   
                        <a href="javascript:;" onclick="navigate('post')" class="active" data-id="1">æ™’å›¾</a>
                    
                  
                   
                        <a href="javascript:;" onclick="navigate('friend')" data-id="3">å¥½å‹</a>
                    
                        <a href="javascript:;" onclick="navigate('collect')" data-id="4">æ”¶è—</a>
                   

                </ul>
            </div>
            <!-- æ·»åŠ å†…å®¹æŒ‰é’® -->

        <img class='adding' src="../images/add.png" alt="æ·»åŠ " onclick="showAdding()">


    <!-- æ·»åŠ å†…å®¹å¼¹çª— -->
    <div class="adding_content" style="display:none">
        <div class="top_new">
            <h3 class="title">æ·»åŠ å†…å®¹</h3>
            <a href="javascript:;" class="out" onclick="closeAdding()">Ã—</a>
        </div>
        <form id="contentForm" class="row g-3 needs-validation" novalidate enctype="multipart/form-data">
            <div class="mb-3">
                <label for="contentType" class="form-label">ç±»å‹</label>
                <select class="form-control" id="contentType" required>
                    <option value="å¸–å­">å¸–å­</option>
                    <option value="é—®ç­”" disabled>é—®ç­” (å¼€å‘ä¸­)</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="content" class="form-label">å†…å®¹</label>
                <textarea class="form-control" id="content" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">å›¾ç‰‡ï¼ˆæœ€å¤š9å¼ ï¼‰</label>
                <div class="image-upload-area" id="imageUploadArea">
                    <input type="file" id="imageInput" accept="image/*" multiple style="display:none">
                    <div class="image-grid" id="imageGrid">
                        <div class="add-image-btn" id="addImageBtn">+</div>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-secondary">å‘å¸ƒ</button>
        </form>
    </div>
    <div class="alert alert-success" role="alert" style="display:none">
        å‘å¸ƒæˆåŠŸ
    </div>
    <div class="alert alert-danger" role="alert" style="display:none">
        å‘å¸ƒå¤±è´¥ï¼
    </div>
    


        </div>
    </div>

    <!-- æœç´¢æ å±•ç¤º -->
    <div class="content">
        <div class="main-card">
            <div class="content-top-bar">
                <div class="sort-dropdown">
                    <button class="sort-toggle">
                        <span class="arrow">&#9660;</span>
                    </button>
                    <div class="two_type" style="display: none;">
                        <a href="javascript:;" id="likeDesc" class="active">æœ€çƒ­</a>
                        <a href="javascript:;" id="timeDesc">æœ€æ–°</a>
                    </div>
                </div>
                <div class="search-bar-demo">
                    <div class="search-input-wrapper">
                        <input type="text" class="search-input-demo" placeholder="è¯·è¾“å…¥å…³é”®è¯..." id="searchInput">
                    </div>
                    <button class="search-btn-demo" id="searchBtn">
                        <i class="bi bi-search"></i>
                    </button>
                    <button class="clear-btn-demo" id="clearBtn" style="display:none;">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
            <!-- æœç´¢ç»“æœåˆ‡æ¢æŒ‰é’® -->
            <div class="search-filter-buttons" id="searchFilterButtons" style="display: none;">
                <button class="filter-btn active" id="contentFilterBtn" data-type="content">å†…å®¹</button>
                <button class="filter-btn" id="userFilterBtn" data-type="user">ç”¨æˆ·å</button>
            </div>
            <ul class="content-next">
            </div>
            <ul class="content-next">
            </ul>
            <!-- æ·»åŠ åˆ†é¡µç»„ä»¶ -->
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item">
                        <a class="page-link" href="javascript:;" id="prevPage" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <span class="page-link" id="currentPageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="javascript:;" id="nextPage" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
                
                <!-- å¥½å‹åŠŸèƒ½åˆ†é¡µ -->
                <ul class="pagination justify-content-center" id="friendPagination" style="display: none;">
                    <li class="page-item">
                        <a class="page-link" href="javascript:;" id="friendPrevPage" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <span class="page-link" id="friendCurrentPageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="javascript:;" id="friendNextPage" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
                
                <!-- æ”¶è—åŠŸèƒ½åˆ†é¡µ -->
                <ul class="pagination justify-content-center" id="collectPagination" style="display: none;">
                    <li class="page-item">
                        <a class="page-link" href="javascript:;" id="collectPrevPage" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <span class="page-link" id="collectCurrentPageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="javascript:;" id="collectNextPage" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
        </div>
        <!-- æ·»åŠ å›¾ç‰‡é¢„è§ˆå®¹å™¨ -->
        <div class="image-preview-overlay" style="display: none;">
            <img class="preview-image" src="" alt="é¢„è§ˆå›¾ç‰‡">
        </div>
    </div>

    <div class="right-sidebar">
        <div class="sidebar-card">
            <div class="sidebar-title">æˆ‘çš„å…³æ³¨</div>
            <ul class="sidebar-list">
                <li>
                    <span class="sidebar-avatar"></span>
                    <span class="sidebar-name">xxx</span>
                </li>
                <li>
                    <span class="sidebar-avatar"></span>
                    <span class="sidebar-name">xxx</span>
                </li>
                <li>
                    <span class="sidebar-avatar"></span>
                    <span class="sidebar-name">xxx</span>
                </li>
            </ul>
        </div>
    </div>

    <script>
        // ç»‘å®šè¯„è®ºäº‹ä»¶çš„é€šç”¨å‡½æ•°
        function bindCommentEvents(otherComments, cmt) {
            // ç»‘å®šè¯„è®ºç‚¹å‡»äº‹ä»¶
            const commentItems = otherComments.querySelectorAll('.xijie');
            commentItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const commentId = this.dataset.idcomments;
                    const commentName = this.querySelector('.name').textContent;
                    const commentUserId = this.dataset.userid;
                    const parentId = this.dataset.parentId;

                    const textarea = cmt.querySelector('textarea');
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å›å¤çš„å›å¤
                    if (parentId) {
                        // è¿™æ˜¯å›å¤ï¼Œæ˜¾ç¤º"å›å¤ xxxï¼š"
                        textarea.placeholder = `å›å¤ ${commentName}ï¼š`;
                        textarea.dataset.parentId = commentId;
                        textarea.dataset.parentUserId = commentUserId;
                        textarea.dataset.isReplyToReply = 'true';
                    } else {
                        // è¿™æ˜¯è¯„è®ºï¼Œæ˜¾ç¤º"å›å¤ xxxï¼š"
                        textarea.placeholder = `å›å¤ ${commentName}ï¼š`;
                        textarea.dataset.parentId = commentId;
                        textarea.dataset.parentUserId = commentUserId;
                        textarea.dataset.isReplyToReply = 'false';
                    }
                    textarea.focus();
                });
            });

            // ç»‘å®šåˆ é™¤è¯„è®ºæŒ‰é’®äº‹ä»¶
            const deleteCommentBtns = otherComments.querySelectorAll('.delete-comment-btn');
            deleteCommentBtns.forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const commentId = this.dataset.commentId;
                    
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
                        try {
                            const res = await axios.delete(`/api/posts/comments/${commentId}`);
                            
                            if (res.data.success) {
                                // åˆ é™¤æˆåŠŸï¼Œé‡æ–°åŠ è½½è¯„è®º
                                const postId = cmt.closest('.mulu').dataset.postId;
                                const pageInfo = window.commentPages[postId];
                                const res = await axios.get(`/api/posts/${postId}/comments?page=${pageInfo.currentPage}&limit=${pageInfo.pageSize}`);
                                const data = res.data;
                                const comments = data.comments || data;
                                
                                // é‡æ–°åˆ†ç»„
                                const commentMap = {};
                                const rootComments = [];
                                const flatReplies = [];
                                comments.forEach(comment => {
                                    commentMap[comment.idcomments] = comment;
                                    if (!comment.parent_id) {
                                        rootComments.push(comment);
                                    } else {
                                        flatReplies.push(comment);
                                    }
                                });
                                
                                // é‡æ–°æ¸²æŸ“è¯„è®º
                                if (comments.length === 0) {
                                    otherComments.innerHTML = '<div class="empty-comment">æŠ¢ä¸ªæ²™å‘å§</div>';
                                } else {
                                    const commentsHtml = rootComments.map(renderComment).join('');
                                    let paginationHtml = '';
                                    if (pageInfo.totalPages > 1) {
                                        paginationHtml = `
                                            <div class="comment-pagination">
                                                <div class="pagination-info">
                                                    ç¬¬ ${pageInfo.currentPage} é¡µï¼Œå…± ${pageInfo.totalPages} é¡µ
                                                </div>
                                                <div class="pagination-controls">
                                                    ${pageInfo.currentPage > 1 ? `<button class="prev-page-btn" data-post-id="${postId}">ä¸Šä¸€é¡µ</button>` : ''}
                                                    ${pageInfo.currentPage < pageInfo.totalPages ? `<button class="next-page-btn" data-post-id="${postId}">ä¸‹ä¸€é¡µ</button>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }
                                    otherComments.innerHTML = commentsHtml + paginationHtml;
                                }
                                
                                // é‡æ–°ç»‘å®šäº‹ä»¶
                                bindCommentEvents(otherComments, cmt);
                                
                                const successAlert = document.querySelector('.alert-success');
                                if (successAlert) {
                                    successAlert.style.display = 'block';
                                    successAlert.textContent = 'åˆ é™¤æˆåŠŸ';
                                    setTimeout(() => {
                                        successAlert.style.display = 'none';
                                    }, 2000);
                                }
                            }
                        } catch (error) {
                            console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
                            const errorAlert = document.querySelector('.alert-danger');
                            if (errorAlert) {
                                errorAlert.style.display = 'block';
                                errorAlert.textContent = 'åˆ é™¤å¤±è´¥';
                                setTimeout(() => {
                                    errorAlert.style.display = 'none';
                                }, 2000);
                            }
                        }
                    }
                });
            });

            // ç»‘å®šåˆ†é¡µæŒ‰é’®äº‹ä»¶
            const prevPageBtn = otherComments.querySelector('.prev-page-btn');
            const nextPageBtn = otherComments.querySelector('.next-page-btn');
            
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const postId = this.dataset.postId;
                    const pageInfo = window.commentPages[postId];
                    if (pageInfo.currentPage > 1) {
                        pageInfo.currentPage--;
                        await loadCommentsForPost(postId, pageInfo, otherComments, cmt);
                    }
                });
            }
            
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const postId = this.dataset.postId;
                    const pageInfo = window.commentPages[postId];
                    if (pageInfo.currentPage < pageInfo.totalPages) {
                        pageInfo.currentPage++;
                        await loadCommentsForPost(postId, pageInfo, otherComments, cmt);
                    }
                });
            }
        }



        // åŠ è½½è¯„è®ºçš„é€šç”¨å‡½æ•°
        async function loadCommentsForPost(postId, pageInfo, otherComments, cmt) {
            const res = await axios.get(`/api/posts/${postId}/comments?page=${pageInfo.currentPage}&limit=${pageInfo.pageSize}`);
            const data = res.data;
            const comments = data.comments || data;
            
            // é‡æ–°åˆ†ç»„
            const commentMap = {};
            const rootComments = [];
            const flatReplies = [];
            comments.forEach(comment => {
                commentMap[comment.idcomments] = comment;
                if (!comment.parent_id) {
                    rootComments.push(comment);
                } else {
                    flatReplies.push(comment);
                }
            });
            
            console.log('è¯„è®ºåˆ†ç»„ç»“æœ:', {
                totalComments: comments.length,
                rootComments: rootComments.length,
                flatReplies: flatReplies.length,
                commentMapKeys: Object.keys(commentMap)
            });
            
            // é‡æ–°æ¸²æŸ“è¯„è®º
            if (comments.length === 0) {
                otherComments.innerHTML = '<div class="empty-comment">æŠ¢ä¸ªæ²™å‘å§</div>';
            } else {
                // å®šä¹‰å±€éƒ¨æ¸²æŸ“å‡½æ•°
                function renderReplies(parentId) {
                    // è·å–æ‰€æœ‰ç›´æ¥å›å¤å’ŒåµŒå¥—å›å¤
                    const getAllReplies = (parentId) => {
                        const directReplies = flatReplies.filter(reply => reply.parent_id == parentId);
                        let allReplies = [...directReplies];
                        
                        // é€’å½’è·å–æ‰€æœ‰åµŒå¥—å›å¤
                        directReplies.forEach(reply => {
                            const nestedReplies = getAllReplies(reply.idcomments);
                            allReplies = allReplies.concat(nestedReplies);
                        });
                        
                        return allReplies;
                    };
                    
                    const allReplies = getAllReplies(parentId);
                    
                    // æŒ‰æ—¶é—´å‡åºæ’åº
                    allReplies.sort((a, b) => {
                        const timeA = new Date(a.time).getTime();
                        const timeB = new Date(b.time).getTime();
                        return timeA - timeB;
                    });
                    
                    console.log(`æ¸²æŸ“è¯„è®º ${parentId} çš„æ‰€æœ‰å›å¤:`, allReplies.map(r => r.idcomments));
                    
                    return allReplies.map(reply => {
                        let showName = reply.name;
                        let content = reply.content;
                        
                        // åˆ¤æ–­æ˜¯å¦æ˜¯"å›å¤çš„å›å¤"
                        if (reply.parent_id && reply.parent_user_name && commentMap[reply.parent_id] && commentMap[reply.parent_id].parent_id) {
                            // è¿™æ˜¯å›å¤çš„å›å¤ï¼Œæ˜¾ç¤ºä¸º"å›å¤xxxxï¼šï¼ˆå†…å®¹ï¼‰"
                            showName = reply.name;
                            content = `å›å¤${reply.parent_user_name}ï¼š${reply.content}`;
                            console.log(`å›å¤çš„å›å¤ ${reply.idcomments}: ${content}`);
                        } else if (reply.parent_id && reply.parent_user_name) {
                            // è¿™æ˜¯å›å¤è¯„è®ºï¼Œæ˜¾ç¤ºä¸º"xxx å›å¤ xxx"
                            showName = `${reply.name} å›å¤ ${reply.parent_user_name}`;
                            console.log(`å›å¤è¯„è®º ${reply.idcomments}: ${showName}`);
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰ç”¨æˆ·çš„è¯„è®º
                        const isCurrentUser = userData && reply.id_user == userData.id_user;
                        const deleteBtn = isCurrentUser ? `<button class="delete-comment-btn" data-comment-id="${reply.idcomments}"><i class="bi bi-trash"></i></button>` : '';
                        
                        return `
                            <div class="xijie" data-idcomments="${reply.idcomments}" data-userid="${reply.id_user}" data-parent-id="${reply.parent_id}" style="margin-left: 32px;">
                                <image class="avatar1" src=${reply.avatar}></image>
                                <div class="exceptA">
                                    <div class='author-container'>
                                        <a href="javascript:;" class="name" data-userid="${reply.id_user}">${showName}</a>
                                        ${deleteBtn}
                                    </div>
                                    <div class="information"></div>
                                    <p class="words">${content}</p>
                                    <div class="timesLike">
                                        <p class="ctime">${formatFriendlyTime(reply.time)}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                function renderComment(comment) {
                    // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰ç”¨æˆ·çš„è¯„è®º
                    const isCurrentUser = userData && comment.id_user == userData.id_user;
                    const deleteBtn = isCurrentUser ? `<button class="delete-comment-btn" data-comment-id="${comment.idcomments}"><i class="bi bi-trash"></i></button>` : '';
                    
                    let html = `
                        <div class="xijie" data-idcomments="${comment.idcomments}" data-userid="${comment.id_user}" data-parent-id="">
                            <image class="avatar1" src=${comment.avatar}></image>
                            <div class="exceptA">
                                <div class='author-container'>
                                    <a href="javascript:;" class="name" data-userid="${comment.id_user}">${comment.name}</a>
                                    ${deleteBtn}
                                </div>
                                <div class="information"></div>
                                <p class="words">${comment.content}</p>
                                <div class="timesLike">
                                    <p class="ctime">${formatFriendlyTime(comment.time)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="reply-container">
                            ${renderReplies(comment.idcomments)}
                        </div>
                    `;
                    return html;
                }
                
                const commentsHtml = rootComments.map(renderComment).join('');
                let paginationHtml = '';
                if (pageInfo.totalPages > 1) {
                    paginationHtml = `
                        <div class="comment-pagination">
                            <div class="pagination-info">
                                ç¬¬ ${pageInfo.currentPage} é¡µï¼Œå…± ${pageInfo.totalPages} é¡µ
                            </div>
                            <div class="pagination-controls">
                                ${pageInfo.currentPage > 1 ? `<button class="prev-page-btn" data-post-id="${postId}">ä¸Šä¸€é¡µ</button>` : ''}
                                ${pageInfo.currentPage < pageInfo.totalPages ? `<button class="next-page-btn" data-post-id="${postId}">ä¸‹ä¸€é¡µ</button>` : ''}
                            </div>
                        </div>
                    `;
                }
                otherComments.innerHTML = commentsHtml + paginationHtml;
            }
            
            // é‡æ–°ç»‘å®šäº‹ä»¶
            bindCommentEvents(otherComments, cmt);
        }

        // åŠ è½½headerç»„ä»¶
        const userD = localStorage.getItem('user_data');
        let userData = null;
        try {
            userData = userD ? JSON.parse(userD) : null;
        } catch (e) {
            console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
        }

        // æœç´¢ç›¸å…³å˜é‡
        let searchTimeout = null;
        let currentSearchKeyword = '';
        let isSearching = false;
        let currentSearchRequest = null; // ç”¨äºå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æœç´¢è¯·æ±‚

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = null;
                    func(...args);
                };
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(later, wait);
            };
        }

        // å…³é”®è¯é«˜äº®å‡½æ•°
        function highlightKeyword(text, keyword) {
            if (!keyword || keyword.trim() === '') {
                return text;
            }
            
            const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // æ‡’åŠ è½½å…³æ³¨åˆ—è¡¨
        let allFollowingUsers = [];
        let currentDisplayIndex = 0;
        const batchSize = 5; // æ¯æ¬¡åŠ è½½5ä¸ªç”¨æˆ·

        async function loadFollowingList() {
            if (!userData || !userData.id_user) {
                console.log('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•åŠ è½½å…³æ³¨åˆ—è¡¨');
                const sidebarList = document.querySelector('.sidebar-list');
                sidebarList.innerHTML = '<li><span class="sidebar-name">ç™»å½•åå†æŸ¥çœ‹å…³æ³¨å“¦ï¼</span></li>';
                return;
            }

            try {
                const response = await axios.get(`/api/accounts/following/${userData.id_user}`);
                if (response.data.success) {
                    const followingList = response.data.data;
                    const sidebarList = document.querySelector('.sidebar-list');
                    
                    // æ¸…ç©ºç°æœ‰å†…å®¹
                    sidebarList.innerHTML = '';
                    
                    if (followingList.length === 0) {
                        sidebarList.innerHTML = '<li><span class="sidebar-name">å»å…³æ³¨ä¸€ä¸‹å§ï¼</span></li>';
                        return;
                    }
                    
                    // ä½¿ç”¨çœŸå®å…³æ³¨ç”¨æˆ·æ•°æ®ï¼ŒæŒ‰æœ€æ–°å¸–å­æ—¶é—´æ’åºï¼ˆå€’åºï¼‰ï¼Œæœ‰æ–°å¸–å­çš„ç½®é¡¶
                    allFollowingUsers = [...followingList].sort((a, b) => {
                        // é¦–å…ˆæŒ‰æ˜¯å¦æœ‰æ–°å¸–å­æ’åºï¼ˆæœ‰æ–°å¸–å­çš„åœ¨å‰ï¼‰
                        if (a.hasNewPost && !b.hasNewPost) return -1;
                        if (!a.hasNewPost && b.hasNewPost) return 1;
                        
                        // å¦‚æœéƒ½æœ‰æ–°å¸–å­ï¼ŒæŒ‰å‘å¸ƒæ—¶é—´å€’åº
                        if (a.hasNewPost && b.hasNewPost) {
                            const timeA = new Date(a.latestPostTime).getTime();
                            const timeB = new Date(b.latestPostTime).getTime();
                            return timeB - timeA; // å€’åº
                        }
                        
                        // å¦‚æœéƒ½æ²¡æœ‰æ–°å¸–å­ï¼ŒæŒ‰ç”¨æˆ·åæ’åº
                        const nameA = (a.name || '').toLowerCase();
                        const nameB = (b.name || '').toLowerCase();
                        return nameA.localeCompare(nameB, 'zh-CN');
                    });
                    
                    currentDisplayIndex = 0;
                    
                    // åˆå§‹åŠ è½½ç¬¬ä¸€æ‰¹
                    loadMoreUsers();
                    
                    // è®¾ç½®æ»šåŠ¨æ£€æµ‹
                    setupScrollDetection();
                    
                    // åŠ¨æ€è°ƒæ•´åˆ—è¡¨é«˜åº¦
                    adjustSidebarHeight();
                    
                    console.log(`æˆåŠŸåŠ è½½äº† ${allFollowingUsers.length} ä¸ªå…³æ³¨ç”¨æˆ·ï¼ˆæ‡’åŠ è½½æ¨¡å¼ï¼‰`);
                } else {
                    console.error('è·å–å…³æ³¨åˆ—è¡¨å¤±è´¥:', response.data.message);
                    const sidebarList = document.querySelector('.sidebar-list');
                    sidebarList.innerHTML = '<li><span class="sidebar-name">åŠ è½½å¤±è´¥</span></li>';
                }
            } catch (error) {
                console.error('åŠ è½½å…³æ³¨åˆ—è¡¨å¤±è´¥:', error);
                const sidebarList = document.querySelector('.sidebar-list');
                sidebarList.innerHTML = '<li><span class="sidebar-name">åŠ è½½å¤±è´¥</span></li>';
            }
        }

        // åŠ è½½æ›´å¤šç”¨æˆ·
        function loadMoreUsers() {
            const sidebarList = document.querySelector('.sidebar-list');
            
            // ç§»é™¤ç°æœ‰çš„åŠ è½½æ›´å¤šæŒ‰é’®
            const existingLoadMore = sidebarList.querySelector('.load-more-item');
            if (existingLoadMore) {
                existingLoadMore.remove();
            }
            
            const endIndex = Math.min(currentDisplayIndex + batchSize, allFollowingUsers.length);
            
            for (let i = currentDisplayIndex; i < endIndex; i++) {
                const user = allFollowingUsers[i];
                const li = document.createElement('li');
                
                // ä¸ºæ–°å¸–å­çš„ç”¨æˆ·æ·»åŠ é«˜äº®æ ·å¼
                if (user.hasNewPost) {
                    li.className = 'sidebar-item-new-post';
                    li.innerHTML = `
                        <span class="sidebar-avatar" style="background-image: url('${user.avatar || '../images/default_avatar.jpg'}');"></span>
                        <span class="sidebar-name">${user.name || 'æœªçŸ¥ç”¨æˆ·'}</span>
                        <span class="new-post-indicator">æ–°</span>
                    `;
                } else {
                    li.innerHTML = `
                        <span class="sidebar-avatar" style="background-image: url('${user.avatar || '../images/default_avatar.jpg'}');"></span>
                        <span class="sidebar-name">${user.name || 'æœªçŸ¥ç”¨æˆ·'}</span>
                    `;
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè·³è½¬åˆ°ç”¨æˆ·ä¸»é¡µ
                li.style.cursor = 'pointer';
                li.addEventListener('click', function() {
                    console.log('ç‚¹å‡»ç”¨æˆ·:', user.name, 'ç”¨æˆ·ID:', user.id_user);
                    console.log('å½“å‰ç™»å½•ç”¨æˆ·ID:', userData ? userData.id_user : 'æœªç™»å½•');
                    // åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰ç™»å½•ç”¨æˆ·
                    if (userData && user.id_user == userData.id_user) {
                        console.log('è·³è½¬åˆ°ä¸ªäººé¡µé¢');
                        window.location.href = '/personal';
                    } else {
                        console.log('è·³è½¬åˆ°ç”¨æˆ·é¡µé¢:', `/accounts?id=${user.id_user}`);
                        window.location.href = `/accounts?id=${user.id_user}`;
                    }
                });
                
                // æ·»åŠ æ‚¬åœæ•ˆæœ
                li.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'rgba(198, 131, 23, 0.1)';
                });
                
                li.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
                
                sidebarList.appendChild(li);
            }
            
            currentDisplayIndex = endIndex;
            
            // å¦‚æœè¿˜æœ‰æ›´å¤šç”¨æˆ·ï¼Œæ·»åŠ åŠ è½½æ›´å¤šæŒ‰é’®
            if (currentDisplayIndex < allFollowingUsers.length) {
                const loadMoreLi = document.createElement('li');
                loadMoreLi.className = 'load-more-item';
                loadMoreLi.innerHTML = `
                    <span class="load-more-btn">åŠ è½½æ›´å¤š...</span>
                `;
                loadMoreLi.addEventListener('click', function(e) {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    loadMoreUsers();
                });
                sidebarList.appendChild(loadMoreLi);
            }
        }

        // è‡ªåŠ¨æ£€æµ‹æ»šåŠ¨åˆ°åº•éƒ¨å¹¶åŠ è½½æ›´å¤š
        function setupScrollDetection() {
            const sidebarList = document.querySelector('.sidebar-list');
            if (!sidebarList) return;
            
            sidebarList.addEventListener('scroll', function() {
                const { scrollTop, scrollHeight, clientHeight } = this;
                
                // å½“æ»šåŠ¨åˆ°è·ç¦»åº•éƒ¨50pxæ—¶è‡ªåŠ¨åŠ è½½æ›´å¤š
                if (scrollHeight - scrollTop - clientHeight < 50) {
                    if (currentDisplayIndex < allFollowingUsers.length) {
                        loadMoreUsers();
                    }
                }
            });
        }

        // åŠ¨æ€è°ƒæ•´ä¾§è¾¹æ é«˜åº¦
        function adjustSidebarHeight() {
            const sidebarCard = document.querySelector('.sidebar-card');
            const sidebarList = document.querySelector('.sidebar-list');
            const sidebarTitle = document.querySelector('.sidebar-title');
            
            if (!sidebarCard || !sidebarList || !sidebarTitle) return;
            
            // è®¡ç®—å¯ç”¨ç©ºé—´
            const cardHeight = sidebarCard.offsetHeight;
            const titleHeight = sidebarTitle.offsetHeight;
            const padding = 48; // ä¸Šä¸‹paddingçš„æ€»å’Œ
            const availableHeight = cardHeight - titleHeight - padding;
            
            // è®¾ç½®åˆ—è¡¨çš„æœ€å¤§é«˜åº¦
            sidebarList.style.maxHeight = `${Math.max(200, availableHeight)}px`;
            
            console.log(`è°ƒæ•´ä¾§è¾¹æ é«˜åº¦: å¡ç‰‡é«˜åº¦=${cardHeight}px, æ ‡é¢˜é«˜åº¦=${titleHeight}px, å¯ç”¨é«˜åº¦=${availableHeight}px`);
        }

        // ç›‘å¬ç”¨æˆ·ä¿¡æ¯æ›´æ–°
        window.addEventListener('storage', function(e) {
            if (e.key === 'userUpdate') {
                try {
                    const updateData = JSON.parse(e.newValue);
                    console.log('æ”¶åˆ°ç”¨æˆ·ä¿¡æ¯æ›´æ–°é€šçŸ¥:', updateData);
                    
                    // é‡æ–°åŠ è½½å…³æ³¨åˆ—è¡¨
                    loadFollowingList();
                } catch (error) {
                    console.error('è§£æç”¨æˆ·ä¿¡æ¯æ›´æ–°æ•°æ®å¤±è´¥:', error);
                }
            }
        });

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œè°ƒæ•´ä¾§è¾¹æ é«˜åº¦
        window.addEventListener('resize', function() {
            adjustSidebarHeight();
        });

        // æœç´¢å‡½æ•°
        async function performSearch(keyword) {
            console.log('æ‰§è¡Œæœç´¢ï¼Œå…³é”®è¯:', keyword);
            
            // å–æ¶ˆä¹‹å‰çš„æœç´¢è¯·æ±‚
            if (currentSearchRequest) {
                currentSearchRequest.cancel();
                currentSearchRequest = null;
            }
            
            // éšè—æ‰€æœ‰åˆ†é¡µä¿¡æ¯ï¼Œå› ä¸ºæœç´¢æ—¶ä¸æ˜¾ç¤ºåˆ†é¡µ
            const mainPagination = document.querySelector('.pagination');
            const friendPagination = document.getElementById('friendPagination');
            const collectPagination = document.getElementById('collectPagination');
            
            if (mainPagination) mainPagination.style.display = 'none';
            if (friendPagination) friendPagination.style.display = 'none';
            if (collectPagination) collectPagination.style.display = 'none';
            
            if (!keyword || keyword.trim() === '') {
                // å¦‚æœæœç´¢å…³é”®è¯ä¸ºç©ºï¼Œæ¢å¤åˆ°åŸæ¥çš„é¡µé¢çŠ¶æ€
                console.log('æœç´¢å…³é”®è¯ä¸ºç©ºï¼Œæ¢å¤åˆ°åŸæ¥çš„åŠŸèƒ½:', currentActiveFunction);
                loadContent(currentActiveFunction);
                return;
            }

            try {
                isSearching = true;
                currentSearchKeyword = keyword;
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const contentNext = document.querySelector('.content-next');
                contentNext.innerHTML = '<div class="search-loading">æœç´¢ä¸­...</div>';
                
                console.log('å‘é€æœç´¢è¯·æ±‚:', `/api/posts/search?keyword=${encodeURIComponent(keyword)}`);
                
                // åˆ›å»ºå¯å–æ¶ˆçš„è¯·æ±‚
                const CancelToken = axios.CancelToken;
                const source = CancelToken.source();
                currentSearchRequest = source;
                
                const response = await axios.get(`/api/posts/search?keyword=${encodeURIComponent(keyword)}`, {
                    cancelToken: source.token
                });
                
                // æ£€æŸ¥è¯·æ±‚æ˜¯å¦è¢«å–æ¶ˆ
                if (currentSearchRequest !== source) {
                    console.log('æœç´¢è¯·æ±‚å·²è¢«å–æ¶ˆ');
                    return;
                }
                
                console.log('æœç´¢å“åº”:', response.data);
                
                if (response.data.success) {
                    const searchData = response.data.data;
                    console.log('å†…å®¹æœç´¢ç»“æœæ•°é‡:', searchData.content.length);
                    console.log('ç”¨æˆ·åæœç´¢ç»“æœæ•°é‡:', searchData.users.length);
                    
                    // æ˜¾ç¤ºæœç´¢è¿‡æ»¤æŒ‰é’®
                    const filterButtons = document.getElementById('searchFilterButtons');
                    filterButtons.style.display = 'flex';
                    
                    // é»˜è®¤æ˜¾ç¤ºå†…å®¹æœç´¢ç»“æœ
                    displaySearchResults(searchData.content, keyword, 'content');
                    
                    // å­˜å‚¨æœç´¢ç»“æœä¾›åˆ‡æ¢ä½¿ç”¨
                    window.currentSearchData = searchData;
                    window.currentSearchKeyword = keyword;
                } else {
                    console.log('æœç´¢å¤±è´¥:', response.data.message);
                    showSearchError(response.data.message);
                }
            } catch (error) {
                if (axios.isCancel(error)) {
                    console.log('æœç´¢è¯·æ±‚è¢«å–æ¶ˆ');
                    return;
                }
                console.error('æœç´¢å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.response?.data);
                showSearchError('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                isSearching = false;
                currentSearchRequest = null;
            }
        }

        // æ˜¾ç¤ºæœç´¢æç¤º
        function showSearchPrompt() {
            const contentNext = document.querySelector('.content-next');
            contentNext.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ”</div>
                    <div class="empty-state-title">å¼€å§‹æœç´¢</div>
                    <div class="empty-state-description">è¯·è¾“å…¥ä½ æ„Ÿå…´è¶£çš„å†…å®¹</div>
                </div>
            `;
            
            // éšè—æ‰€æœ‰åˆ†é¡µä¿¡æ¯
            const mainPagination = document.querySelector('.pagination');
            const friendPagination = document.getElementById('friendPagination');
            const collectPagination = document.getElementById('collectPagination');
            
            if (mainPagination) mainPagination.style.display = 'none';
            if (friendPagination) friendPagination.style.display = 'none';
            if (collectPagination) collectPagination.style.display = 'none';
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        async function displaySearchResults(results, keyword, searchType = 'content') {
            const contentNext = document.querySelector('.content-next');
            
            if (results.length === 0) {
                const typeText = searchType === 'content' ? 'å†…å®¹' : 'ç”¨æˆ·å';
                contentNext.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <div class="empty-state-title">æœç´¢æ— ç»“æœ</div>
                        <div class="empty-state-description">æ²¡æœ‰æ‰¾åˆ°åŒ…å«"${keyword}"çš„${typeText}</div>
                    </div>
                `;
                return;
            }

                                                // åªæœ‰å½“æœ‰å…³é”®è¯æ—¶æ‰æ·»åŠ æœç´¢ç»“æœç»Ÿè®¡
                                    if (keyword && keyword.trim() !== '') {
                                        const searchStats = document.createElement('div');
                                        searchStats.className = 'search-stats';
                                        const typeText = searchType === 'content' ? 'å†…å®¹' : 'ç”¨æˆ·å';
                                        searchStats.innerHTML = `
                                            <div class="search-status">
                                                æ‰¾åˆ° ${results.length} æ¡åŒ…å«"${keyword}"çš„${typeText}
                                            </div>
                                        `;
                                        contentNext.innerHTML = '';
                                        contentNext.appendChild(searchStats);
                                    } else {
                                        contentNext.innerHTML = '';
                                    }

                                    // å¦‚æœæ˜¯ç”¨æˆ·åæœç´¢ç»“æœï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†æ˜¾ç¤ºæ ¼å¼
                                    if (searchType === 'user') {
                                        // æ˜¾ç¤ºç”¨æˆ·åæœç´¢ç»“æœ
                                        results.forEach(user => {
                                            const userItem = document.createElement('div');
                                            userItem.className = 'post-item user-search-item';
                                            userItem.innerHTML = `
                                                <div class="post-header">
                                                    <div class="user-info">
                                                        <img src="${user.avatar}" alt="å¤´åƒ" class="avatar">
                                                        <span class="username">${user.name}</span>
                                                    </div>
                                                </div>
                                            `;
                                            
                                            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè·³è½¬åˆ°ç”¨æˆ·ä¸ªäººä¸»é¡µ
                                            userItem.addEventListener('click', function() {
                                                // å¦‚æœæœç´¢åˆ°çš„æ˜¯å½“å‰ç™»å½•ç”¨æˆ·ï¼Œè·³è½¬åˆ°personalé¡µé¢
                                                // å¦åˆ™è·³è½¬åˆ°accountsé¡µé¢
                                                const currentUserId = userData ? userData.id_user : null;
                                                if (user.id_user == currentUserId) {
                                                    window.location.href = '/personal';
                                                } else {
                                                    window.location.href = `/accounts?id=${user.id_user}`;
                                                }
                                            });
                                            
                                            contentNext.appendChild(userItem);
                                        });
                                        return;
                                    }
            
            for (let i = 0; i < results.length; i++) {
                const post = results[i];
                
                if (post.type === 'å¸–å­') {
                    const formatted = formatFriendlyTime(post.time);

                    // è·å–ç”¨æˆ·çš„å…³æ³¨æ•°å’Œç²‰ä¸æ•°
                    let userFollowing = 0;
                    let userFollowers = 0;
                    try {
                        const userRes = await axios.get(`/api/accounts/${post.id_user}/accounts`);
                        userFollowing = userRes.data.following || 0;
                        userFollowers = userRes.data.followers || 0;
                    } catch (error) {
                        console.error('è·å–ç”¨æˆ·å…³æ³¨æ•°æ®å¤±è´¥:', error);
                    }

                    // åˆ¤æ–­æ˜¯å¦ä¸ºè´´ä¸»
                    let deleteBtnHtml = '';
                    if (userData && post.id_user == userData.id_user) {
                        deleteBtnHtml = `<button class="btn btn-link btn-sm delete-post-btn" data-id="${post.id}">
                            <i class="bi bi-trash" style="font-size:20px;color:rgb(207, 185, 137);"></i>
                        </button>`;
                    }

                    // å¤„ç†å›¾ç‰‡
                    let imagesArr = [];
                    try {
                        imagesArr = post.images ? JSON.parse(post.images) : [];
                    } catch(error) {
                        console.error('è§£æå›¾ç‰‡æ•°æ®å¤±è´¥:', error);
                        imagesArr = [];
                    }

                    let picturesHtml = '';
                    if (imagesArr.length > 0) {
                        picturesHtml = `<div class="pictures">` +
                            imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                            `</div>`;
                    }

                    // é«˜äº®ç”¨æˆ·åå’Œå†…å®¹
                    const highlightedName = highlightKeyword(post.name, keyword);
                    const highlightedContent = highlightKeyword(post.content, keyword);

                    const li = document.createElement('li');
                    contentNext.appendChild(li);
           
                    li.innerHTML = `
                    <div class="mulu-top" style="position:relative;">
                    ${deleteBtnHtml}
                    <div class="mulu">
                    <image class="avatar" src=${post.avatar}></image>
                                    <div class="list">
                                    <div class="divide_row">
                                        <a href="javascript:;" class="uname" data-userid="${post.id_user}">${highlightedName}</a>
                                        <div class="information">
                                            <div class="divide">
                                                <image class="touxiang" src=${post.avatar}></image>
                                                <p class="name">${highlightedName}</p>
                                            </div>
                                            <div class="people">
                                                <p>å…³æ³¨: ${userFollowing}</p>
                                                <p>ç²‰ä¸: ${userFollowers}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="sentences">${highlightedContent}</p>
                                    ${picturesHtml}
                                    <div class="last">
                                        <p class="time">${formatted}</p>
                                        <div class="others">
                                            <a href="javascript:;" class="like" data-id="${post.id}">â¤ 0</a>
                                            <a href="javascript:;" class="collect" data-id="${post.id}">â­ æ”¶è—</a>
                                            <a href='javascript:;' class="say" data-id="${post.id}">ğŸ–Š è¯„è®º</a>
                                        </div>
                                    </div>
                                    </div>
                                    </div>
                                     <div class="comments hidden" data-id="${post.id}">
                                        <div class="inputComment">
                                         <textarea id="my" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." maxlength="200"></textarea>
                                         <button class="submitComment">å‘é€</button>
                                         </div>
                                                <div class="otherComments"></div>
                                         </div>
                                        </div>
                    `;
                }
            }
        }

        // æ˜¾ç¤ºæœç´¢é”™è¯¯
        function showSearchError(message) {
            const contentNext = document.querySelector('.content-next');
            contentNext.innerHTML = `
                <div class="search-status">
                    <div style="color: #dc3545; text-align: center; padding: 20px;">
                        ${message}
                    </div>
                </div>
            `;
        }

        // é˜²æŠ–æœç´¢
        const debouncedSearch = debounce(performSearch, 500);

        // æœç´¢äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const clearBtn = document.getElementById('clearBtn');

            console.log('æœç´¢ç»„ä»¶åˆå§‹åŒ–å®Œæˆ');
            console.log('æ¸…é™¤æŒ‰é’®å…ƒç´ :', clearBtn);

            // æœç´¢è¿‡æ»¤æŒ‰é’®äº‹ä»¶ç›‘å¬
            const contentFilterBtn = document.getElementById('contentFilterBtn');
            const userFilterBtn = document.getElementById('userFilterBtn');

            contentFilterBtn.addEventListener('click', function() {
                if (!window.currentSearchData) return;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                contentFilterBtn.classList.add('active');
                userFilterBtn.classList.remove('active');
                
                // æ˜¾ç¤ºå†…å®¹æœç´¢ç»“æœ
                displaySearchResults(window.currentSearchData.content, window.currentSearchKeyword, 'content');
            });

            userFilterBtn.addEventListener('click', function() {
                if (!window.currentSearchData) return;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                userFilterBtn.classList.add('active');
                contentFilterBtn.classList.remove('active');
                
                // æ˜¾ç¤ºç”¨æˆ·åæœç´¢ç»“æœ
                displaySearchResults(window.currentSearchData.users, window.currentSearchKeyword, 'user');
            });

            searchInput.addEventListener('input', function() {
                const keyword = this.value.trim();
                console.log('æœç´¢è¾“å…¥å˜åŒ–:', keyword);
                if (keyword) { 
                    clearBtn.style.display = 'block'; 
                    debouncedSearch(keyword);
                } else { 
                    // å½“æœç´¢æ¡†ä¸ºç©ºæ—¶ï¼Œç›´æ¥é‡æ–°åŠ è½½é¡µé¢å†…å®¹
                    console.log('æœç´¢æ¡†ä¸ºç©ºï¼Œç›´æ¥é‡æ–°åŠ è½½é¡µé¢å†…å®¹');
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                        searchTimeout = null;
                    }
                    if (currentSearchRequest) {
                        currentSearchRequest.cancel();
                        currentSearchRequest = null;
                    }
                    
                    // ç›´æ¥é‡æ–°åŠ è½½é¡µé¢å†…å®¹ï¼Œä¸ä¾èµ–å¤æ‚çš„çŠ¶æ€ç®¡ç†
                    console.log('å¼€å§‹ç›´æ¥é‡æ–°åŠ è½½é¡µé¢å†…å®¹');
                    
                    // æ¸…ç©ºå†…å®¹åŒºåŸŸ
                    const contentNext = document.querySelector('.content-next');
                    contentNext.innerHTML = '';
                    console.log('å†…å®¹åŒºåŸŸå·²æ¸…ç©º');
                    
                    // ç›´æ¥è°ƒç”¨APIè·å–å¸–å­æ•°æ®
                    axios.get('/api/posts/indexLike?page=1&limit=5')
                        .then(async res => {
                            console.log('APIå“åº”:', res.data);
                            const posts = res.data.posts || [];
                            
                            // æ›´æ–°åˆ†é¡µä¿¡æ¯
                            if (res.data.pagination) {
                                currentPage = res.data.pagination.currentPage;
                                totalPages = res.data.pagination.totalPages;
                                totalPosts = res.data.pagination.totalPosts;
                                console.log('åˆ†é¡µä¿¡æ¯å·²æ›´æ–°:', { currentPage, totalPages, totalPosts });
                            }
                            
                            if (posts.length === 0) {
                                contentNext.innerHTML = '<div class="search-status">æš‚æ— å¸–å­</div>';
                                console.log('æ²¡æœ‰æ‰¾åˆ°å¸–å­');
                                return;
                            }
                            
                            // æ¸²æŸ“å¸–å­
                            for (let i in posts) {
                                const post = posts[i];
                                if (post.type === 'å¸–å­') {
                                    const formatted = formatFriendlyTime(post.time);

                                    // è·å–ç”¨æˆ·çš„å…³æ³¨æ•°å’Œç²‰ä¸æ•°
                                    let userFollowing = 0;
                                    let userFollowers = 0;
                                    try {
                                        const userRes = await axios.get(`/api/accounts/${post.id_user}/accounts`);
                                        userFollowing = userRes.data.following || 0;
                                        userFollowers = userRes.data.followers || 0;
                                    } catch (error) {
                                        console.error('è·å–ç”¨æˆ·å…³æ³¨æ•°æ®å¤±è´¥:', error);
                                    }

                                    // åˆ¤æ–­æ˜¯å¦ä¸ºè´´ä¸»
                                    let deleteBtnHtml = '';
                                    if (userData && post.id_user == userData.id_user) {
                                        deleteBtnHtml = `<button class="btn btn-link btn-sm delete-post-btn" data-id="${post.id}">
                                            <i class="bi bi-trash" style="font-size:20px;color:rgb(207, 185, 137);"></i>
                                        </button>`;
                                    }

                                    // å¤„ç†å›¾ç‰‡
                                    let imagesArr = [];
                                    try {
                                        imagesArr = post.images ? JSON.parse(post.images) : [];
                                    } catch(error) {
                                        console.error('è§£æå›¾ç‰‡æ•°æ®å¤±è´¥:', error);
                                        imagesArr = [];
                                    }

                                    let picturesHtml = '';
                                    if (imagesArr.length > 0) {
                                        picturesHtml = `<div class="pictures">` +
                                            imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                                            `</div>`;
                                    }

                                    const li = document.createElement('li');
                                    contentNext.appendChild(li);
                                    
                                    li.innerHTML = `
                                    <div class="mulu-top" style="position:relative;">
                                    ${deleteBtnHtml}
                                    <div class="mulu">
                                    <image class="avatar" src=${post.avatar}></image>
                                                    <div class="list">
                                                    <div class="divide_row">
                                                        <a href="javascript:;" class="uname" data-userid="${post.id_user}">${post.name}</a>
                                                        <div class="information">
                                                            <div class="divide">
                                                                <image class="touxiang" src=${post.avatar}></image>
                                                                <p class="name">${post.name}</p>
                                                            </div>
                                                            <div class="people">
                                                                <p>å…³æ³¨: ${userFollowing}</p>
                                                                <p>ç²‰ä¸: ${userFollowers}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p class="sentences">${post.content}</p>
                                                    ${picturesHtml}
                                                    <div class="last">
                                                        <p class="time">${formatted}</p>
                                                        <div class="others">
                                                            <a href="javascript:;" class="like" data-id="${post.id}">â¤ 0</a>
                                                            <a href="javascript:;" class="collect" data-id="${post.id}">â­ æ”¶è—</a>
                                                            <a href='javascript:;' class="say" data-id="${post.id}">ğŸ–Š è¯„è®º</a>
                                                        </div>
                                                    </div>
                                                </div>
                                        </div>
                                        <div class="comments hidden" data-id="${post.id}">
                                        <div class="inputComment">
                                         <textarea id="my" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." maxlength="200"></textarea>
                                         <button class="submitComment">å‘é€</button>
                                         </div>
                                                        <div class="otherComments"></div>
                                         </div>
                                        </div>
                                    `;

                                    // è·å–ç‚¹èµæ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
                                    try {
                                        const likeData = await getLikeData(post.id);
                                        const likeIcon = li.querySelector('.like');
                                        likeIcon.innerHTML = `â¤${likeData.likeCount}`;
                                        
                                        // åªæœ‰åœ¨ç™»å½•çŠ¶æ€ä¸‹æ‰æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ
                                        if (userData && localStorage.getItem('eleToken')) {
                                            for (let p in likeData.userIdLike) {
                                                if (likeData.userIdLike[p] == userData.id_user) {
                                                    likeIcon.classList.add('active');
                                                }
                                            }
                                        }
                                    } catch(error) {
                                        console.error('è·å–ç‚¹èµæ•°æ®å¤±è´¥:', error);
                                        // å‡ºé”™æ—¶æ˜¾ç¤ºé»˜è®¤ç‚¹èµæ•°
                                        const likeIcon = li.querySelector('.like');
                                        likeIcon.innerHTML = `â¤0`;
                                    }

                                    // è·å–æ”¶è—æ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
                                    if (userData && localStorage.getItem('eleToken')) {
                                        try {
                                            const collectPost = await getCollectData();
                                            const collectIcon = li.querySelector('.collect');
                                            
                                            for (let m in collectPost) {
                                                if (collectPost[m].id_from_post == post.id) {
                                                    collectIcon.classList.add('active');
                                                }
                                            }
                                        } catch(error) {
                                            console.error('è·å–æ”¶è—æ•°æ®å¤±è´¥:', error);
                                        }
                                    }
                                }
                            }
                            
                            console.log('å¸–å­æ¸²æŸ“å®Œæˆ');
                            
                            // æ›´æ–°åˆ†é¡µæ˜¾ç¤º
                            updatePaginationInfo('post');
                            console.log('åˆ†é¡µä¿¡æ¯å·²æ›´æ–°');
                        })
                        .catch(error => {
                            console.error('è·å–å¸–å­å¤±è´¥:', error);
                            contentNext.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-state-icon">âš ï¸</div>
                                    <div class="empty-state-title">åŠ è½½å¤±è´¥</div>
                                    <div class="empty-state-description">è¯·ç¨åé‡è¯•</div>
                                </div>
                            `;
                        });
                }
            });
            
            // æœç´¢æ¡†ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºæœç´¢æç¤ºå’Œæ¸…é™¤æŒ‰é’®
            searchInput.addEventListener('click', function() {
                
                // æ˜¾ç¤ºæ¸…é™¤æŒ‰é’®
                clearBtn.style.display = 'block';
                console.log('æ¸…é™¤æŒ‰é’®å·²æ˜¾ç¤º');
                
                if (!this.value.trim()) {
                    // å¦‚æœæœç´¢æ¡†ä¸ºç©ºä¸”è¢«ç‚¹å‡»ï¼Œæ˜¾ç¤ºæœç´¢æç¤º
                    showSearchPrompt();
                }
            });
            
            // æœç´¢æ¡†è·å¾—ç„¦ç‚¹æ—¶æ˜¾ç¤ºæ¸…é™¤æŒ‰é’®
            searchInput.addEventListener('focus', function() {
                clearBtn.style.display = 'block';
            });
            
            // æœç´¢æ¡†å¤±å»ç„¦ç‚¹æ—¶ï¼Œå¦‚æœæ²¡æœ‰å†…å®¹åˆ™éšè—æ¸…é™¤æŒ‰é’®
            searchInput.addEventListener('blur', function() {
                if (!this.value.trim()) {
                    clearBtn.style.display = 'none'; 
                }
            });
            
            searchBtn.addEventListener('click', function() {
                
                const keyword = searchInput.value.trim();
                console.log('æœç´¢æŒ‰é’®ç‚¹å‡»:', keyword);
                if (keyword) {
                    performSearch(keyword);
                }
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    
                    const keyword = this.value.trim();
                    console.log('æœç´¢å›è½¦é”®:', keyword);
                    if (keyword) {
                        performSearch(keyword);
                    }
                }
            });
            
            // æµ‹è¯•æ¸…é™¤æŒ‰é’®æ˜¯å¦å¯ç‚¹å‡»
            clearBtn.addEventListener('mousedown', function(e) {
                console.log('æ¸…é™¤æŒ‰é’®è¢«æŒ‰ä¸‹');
            });
            
            clearBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('æ¸…é™¤æœç´¢æŒ‰é’®è¢«ç‚¹å‡»');
                
                // æ¸…ç©ºæœç´¢æ¡†
                searchInput.value = '';
                console.log('æœç´¢æ¡†å·²æ¸…ç©º');
                
                // éšè—æ¸…é™¤æŒ‰é’®
                clearBtn.style.display = 'none';
                console.log('æ¸…é™¤æŒ‰é’®å·²éšè—');
                
                // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æœç´¢è¯·æ±‚
                if (currentSearchRequest) {
                    currentSearchRequest.cancel();
                    currentSearchRequest = null;
                    console.log('æœç´¢è¯·æ±‚å·²å–æ¶ˆ');
                }
                
                // éšè—æœç´¢è¿‡æ»¤æŒ‰é’®
                const filterButtons = document.getElementById('searchFilterButtons');
                filterButtons.style.display = 'none';
                
                // æ¸…é™¤æœç´¢æ•°æ®
                window.currentSearchData = null;
                window.currentSearchKeyword = null;
                
                // ç›´æ¥é‡æ–°åŠ è½½é¡µé¢å†…å®¹ï¼Œä¸ä¾èµ–å¤æ‚çš„çŠ¶æ€ç®¡ç†
                console.log('å¼€å§‹ç›´æ¥é‡æ–°åŠ è½½é¡µé¢å†…å®¹');
                
                // æ¸…ç©ºå†…å®¹åŒºåŸŸ
                const contentNext = document.querySelector('.content-next');
                contentNext.innerHTML = '';
                console.log('å†…å®¹åŒºåŸŸå·²æ¸…ç©º');
                
                                    // ç›´æ¥è°ƒç”¨APIè·å–å¸–å­æ•°æ®
                    axios.get('/api/posts/indexLike?page=1&limit=5')
                        .then(async res => {
                            console.log('APIå“åº”:', res.data);
                            const posts = res.data.posts || [];
                            
                            // æ›´æ–°åˆ†é¡µä¿¡æ¯
                            if (res.data.pagination) {
                                currentPage = res.data.pagination.currentPage;
                                totalPages = res.data.pagination.totalPages;
                                totalPosts = res.data.pagination.totalPosts;
                                console.log('åˆ†é¡µä¿¡æ¯å·²æ›´æ–°:', { currentPage, totalPages, totalPosts });
                            }
                            
                            if (posts.length === 0) {
                                contentNext.innerHTML = '<div class="search-status">æš‚æ— å¸–å­</div>';
                                console.log('æ²¡æœ‰æ‰¾åˆ°å¸–å­');
                                return;
                            }
                            
                            // æ¸²æŸ“å¸–å­
                            for (let i in posts) {
                            const post = posts[i];
                            if (post.type === 'å¸–å­') {
                                const formatted = formatFriendlyTime(post.time);

                                // è·å–ç”¨æˆ·çš„å…³æ³¨æ•°å’Œç²‰ä¸æ•°
                                let userFollowing = 0;
                                let userFollowers = 0;
                                try {
                                    const userRes = await axios.get(`/api/accounts/${post.id_user}/accounts`);
                                    userFollowing = userRes.data.following || 0;
                                    userFollowers = userRes.data.followers || 0;
                                } catch (error) {
                                    console.error('è·å–ç”¨æˆ·å…³æ³¨æ•°æ®å¤±è´¥:', error);
                                }

                                // åˆ¤æ–­æ˜¯å¦ä¸ºè´´ä¸»
                                let deleteBtnHtml = '';
                                if (userData && post.id_user == userData.id_user) {
                                    deleteBtnHtml = `<button class="btn btn-link btn-sm delete-post-btn" data-id="${post.id}">
                                        <i class="bi bi-trash" style="font-size:20px;color:rgb(207, 185, 137);"></i>
                                    </button>`;
                                }

                                // å¤„ç†å›¾ç‰‡
                                let imagesArr = [];
                                try {
                                    imagesArr = post.images ? JSON.parse(post.images) : [];
                                } catch(error) {
                                    console.error('è§£æå›¾ç‰‡æ•°æ®å¤±è´¥:', error);
                                    imagesArr = [];
                                }

                                let picturesHtml = '';
                                if (imagesArr.length > 0) {
                                    picturesHtml = `<div class="pictures">` +
                                        imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                                        `</div>`;
                                }

                                const li = document.createElement('li');
                                contentNext.appendChild(li);
                                
                                li.innerHTML = `
                                <div class="mulu-top" style="position:relative;">
                                ${deleteBtnHtml}
                                <div class="mulu">
                                <image class="avatar" src=${post.avatar}></image>
                                                <div class="list">
                                                <div class="divide_row">
                                                    <a href="javascript:;" class="uname" data-userid="${post.id_user}">${post.name}</a>
                                                    <div class="information">
                                                        <div class="divide">
                                                            <image class="touxiang" src=${post.avatar}></image>
                                                            <p class="name">${post.name}</p>
                                                        </div>
                                                        <div class="people">
                                                            <p>å…³æ³¨: ${userFollowing}</p>
                                                            <p>ç²‰ä¸: ${userFollowers}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <p class="sentences">${post.content}</p>
                                                ${picturesHtml}
                                                <div class="last">
                                                    <p class="time">${formatted}</p>
                                                    <div class="others">
                                                        <a href="javascript:;" class="like" data-id="${post.id}">â¤ 0</a>
                                                        <a href="javascript:;" class="collect" data-id="${post.id}">â­ æ”¶è—</a>
                                                        <a href='javascript:;' class="say" data-id="${post.id}">ğŸ–Š è¯„è®º</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="comments hidden" data-id="${post.id}">
                                        <div class="inputComment">
                                         <textarea id="my" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." maxlength="200"></textarea>
                                         <button class="submitComment">å‘é€</button>
                                         </div>
                                                        <div class="otherComments"></div>
                                         </div>
                                        </div>
                                    `;

                                // è·å–ç‚¹èµæ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
                                try {
                                    const likeData = await getLikeData(post.id);
                                    const likeIcon = li.querySelector('.like');
                                    likeIcon.innerHTML = `â¤${likeData.likeCount}`;
                                    
                                    // åªæœ‰åœ¨ç™»å½•çŠ¶æ€ä¸‹æ‰æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ
                                    if (userData && localStorage.getItem('eleToken')) {
                                        for (let p in likeData.userIdLike) {
                                            if (likeData.userIdLike[p] == userData.id_user) {
                                                likeIcon.classList.add('active');
                                            }
                                        }
                                    }
                                } catch(error) {
                                    console.error('è·å–ç‚¹èµæ•°æ®å¤±è´¥:', error);
                                    // å‡ºé”™æ—¶æ˜¾ç¤ºé»˜è®¤ç‚¹èµæ•°
                                    const likeIcon = li.querySelector('.like');
                                    likeIcon.innerHTML = `â¤0`;
                                }

                                // è·å–æ”¶è—æ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
                                if (userData && localStorage.getItem('eleToken')) {
                                    try {
                                        const collectPost = await getCollectData();
                                        const collectIcon = li.querySelector('.collect');
                                        
                                        for (let m in collectPost) {
                                            if (collectPost[m].id_from_post == post.id) {
                                                collectIcon.classList.add('active');
                                            }
                                        }
                                    } catch(error) {
                                        console.error('è·å–æ”¶è—æ•°æ®å¤±è´¥:', error);
                                    }
                                }
                            }
                        }
                        
                                                    console.log('å¸–å­æ¸²æŸ“å®Œæˆ');
                            
                            // æ›´æ–°åˆ†é¡µæ˜¾ç¤º
                            updatePaginationInfo('post');
                            console.log('åˆ†é¡µä¿¡æ¯å·²æ›´æ–°');
                    })
                    .catch(error => {
                        console.error('è·å–å¸–å­å¤±è´¥:', error);
                        contentNext.innerHTML = '<div class="search-status">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                    });
                
                // è®©æœç´¢æ¡†é‡æ–°è·å¾—ç„¦ç‚¹
                searchInput.focus();
                console.log('æœç´¢æ¡†é‡æ–°è·å¾—ç„¦ç‚¹');
            });
        });

        // è·å–headerç›¸å…³å…ƒç´ 
        const logining = document.querySelector('.login-header .before-login');
        const userMenu = document.querySelector('.user-menu');
        const username = document.querySelector('.username');
        const userDropdown = document.querySelector('.user-dropdown');
        const logout_click = document.getElementById('logout');

        // åˆå§‹åŒ–ç™»å½•çŠ¶æ€
        function initLoginState() {
            console.log('åˆå§‹åŒ–ç™»å½•çŠ¶æ€');
            if(!localStorage.getItem('eleToken') || !userData){
                logining.style.display = 'block';
                userMenu.style.display = 'none';
            } else {
                logining.style.display = 'none';
                userMenu.style.display = 'block';
                username.textContent = userData.name.length > 8 ? userData.name.slice(0,8) + '...' : userData.name;

                // ç‚¹å‡»æ˜¾ç¤º/éšè—ä¸‹æ‹‰èœå•
                if (userMenu && userDropdown) {
                    userMenu.addEventListener('click', (e) => {
                        e.preventDefault();
                        userDropdown.classList.toggle('show');
                        const arrow = userMenu.querySelector('.arrow');
                        if (arrow) {
                            arrow.classList.toggle('rotate');
                        }
                    });

                    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                    document.addEventListener('click', (e) => {
                        if (userMenu && userDropdown && !userMenu.contains(e.target) && !userDropdown.contains(e.target)) {
                            userDropdown.classList.remove('show');
                            const arrow = userMenu.querySelector('.arrow');
                            if (arrow) {
                                arrow.classList.remove('rotate');
                            }
                        }
                    });
                }

                // é€€å‡ºç™»å½•
                if (logout_click) {
                    logout_click.addEventListener('click', () => {
                        // è°ƒç”¨å…¨å±€é€€å‡ºç™»å½•å‡½æ•°
                        if (window.logout) {
                            window.logout();
                        }
                        // æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
                        logining.style.display = 'block';
                        userMenu.style.display = 'none';
                        userDropdown.classList.remove('show');
                        const arrow = userMenu?.querySelector('.arrow');
                        if (arrow) arrow.classList.remove('rotate');
                    });
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç™»å½•çŠ¶æ€
        //document.addEventListener('DOMContentLoaded', initLoginState);

         initLoginState();
        
        // ç›‘å¬å¤´åƒæ›´æ–°
        window.addEventListener('storage', function(e) {
            if (e.key === 'avatarUpdate') {
                try {
                    const updateData = JSON.parse(e.newValue);
                    if (updateData && updateData.avatar) {
                        updateAllAvatars(updateData.avatar);
                        console.log('æ”¶åˆ°å¤´åƒæ›´æ–°é€šçŸ¥:', updateData.avatar);
                    }
                } catch (error) {
                    console.error('è§£æå¤´åƒæ›´æ–°æ•°æ®å¤±è´¥:', error);
                }
            }
        });
        
        // æ›´æ–°æ‰€æœ‰å¤´åƒçš„å‡½æ•°
        function updateAllAvatars(newAvatarUrl) {
            // æ›´æ–°æ‰€æœ‰imgæ ‡ç­¾çš„å¤´åƒ
            const allImages = document.querySelectorAll('img');
            allImages.forEach(img => {
                if (img.src.includes('/images/default_avatar.jpg') || img.src.includes('/images/avatars/')) {
                    img.src = newAvatarUrl;
                }
            });
            
            // æ›´æ–°æ‰€æœ‰imageæ ‡ç­¾çš„å¤´åƒ
            const allImageElements = document.querySelectorAll('image');
            allImageElements.forEach(img => {
                if (img.src && (img.src.includes('/images/default_avatar.jpg') || img.src.includes('/images/avatars/'))) {
                    img.src = newAvatarUrl;
                }
            });
            
            console.log('é¦–é¡µå¤´åƒå·²æ›´æ–°ä¸º:', newAvatarUrl);
        }
        
        // è·å–å…¶ä»–å¿…è¦çš„å…ƒç´ 
        const addingImg = document.querySelector('.adding');
        const forms = document.querySelectorAll('.needs-validation');
        const danger = document.querySelector('.alert-danger');
        const success_alert = document.querySelector('.alert-success');

        // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæ·»åŠ æŒ‰é’®
        if(localStorage.getItem('eleToken')){
            addingImg.style.display='block';
        }else{
            addingImg.style.display='none';
        }

        //loadcontent è®¾ç½®
        async function loadContent(page) {
            const content = document.querySelector('.content-next');
            
            // æ›´æ–°å½“å‰æ¿€æ´»çš„åŠŸèƒ½ç±»å‹
            currentActiveFunction = page;
            
            // æ›´æ–°èœå•æ é€‰ä¸­çŠ¶æ€
            updateMenuActiveState(page);

            try {
                switch(page) {
                    case 'post':
                        content.innerHTML = ""
                        await getPosts(currentSortMode, 1);
                        break;
                    case 'friend':
                        content.innerHTML = ''
                        await getFriend(1);
                        break;
                    case 'collect':
                        content.innerHTML = ''
                        await getCollect(1)
                        break;
                   
                }
            } catch (error) {
                console.error('åŠ è½½å†…å®¹å¤±è´¥:', error);
                content.innerHTML = '<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            }
        }

        // æ›´æ–°èœå•æ é€‰ä¸­çŠ¶æ€
        function updateMenuActiveState(module) {
            // æ¸…é™¤æ‰€æœ‰èœå•é¡¹çš„activeçŠ¶æ€
            const menuItems = document.querySelectorAll('.menu .part a');
            menuItems.forEach(item => {
                item.classList.remove('active');
                item.style.color = 'black';
            });
            
            // æ ¹æ®æ¨¡å—è®¾ç½®å¯¹åº”çš„èœå•é¡¹ä¸ºactiveçŠ¶æ€
            switch(module) {
                case 'post':
                    const postItem = document.querySelector('.menu .part a[onclick*="post"]');
                    if (postItem) {
                        postItem.classList.add('active');
                        postItem.style.color = '#e09620';
                    }
                    break;
                case 'friend':
                    const friendItem = document.querySelector('.menu .part a[onclick*="friend"]');
                    if (friendItem) {
                        friendItem.classList.add('active');
                        friendItem.style.color = '#e09620';
                    }
                    break;
                case 'collect':
                    const collectItem = document.querySelector('.menu .part a[onclick*="collect"]');
                    if (collectItem) {
                        collectItem.classList.add('active');
                        collectItem.style.color = '#e09620';
                    }
                    break;
            }
        }
        
        //åˆ‡æ¢åœ°å€æ 
        function navigate(page) {
            // ä¿®æ”¹åœ°å€æ URLï¼Œä½†ä¸ä¼šåˆ·æ–°é¡µé¢
            history.pushState({}, '', `/index/${page}`);
            
            // æ›´æ–°èœå•æ é€‰ä¸­çŠ¶æ€
            updateMenuActiveState(page);
            
            // æ›´æ–°å¯¼èˆªæ activeçŠ¶æ€
            updateNavigation(page);

            // æ ¹æ®pageæ›´æ–°å†…å®¹
            loadContent(page);
        }

       

        //è·å–å…¨éƒ¨èµ„æ–™å…ˆ
        
        // æ™’å›¾ï¼ˆä¸»é¡µé¢ï¼‰åˆ†é¡µå˜é‡
        let allData = []; // å­˜å‚¨æ‰€æœ‰æ•°æ®
        let currentPage = 1;
        let totalPages = 1;
        let totalPosts = 0;
        
        // å¥½å‹åˆ†é¡µå˜é‡
        let friendCurrentPage = 1;
        let friendTotalPages = 1;
        let friendTotalPosts = 0;
        
        // æ”¶è—åˆ†é¡µå˜é‡
        let collectCurrentPage = 1;
        let collectTotalPages = 1;
        let collectTotalPosts = 0;
        
        // å½“å‰æ¿€æ´»çš„åŠŸèƒ½ç±»å‹
        let currentActiveFunction = 'post'; // 'post', 'friend', 'collect'
        
        // ä¿å­˜å½“å‰çš„æ’åºçŠ¶æ€
        let currentSortMode = 'like'; // 'like' æˆ– 'time'ï¼Œé»˜è®¤ä¸º'like'ï¼ˆæœ€çƒ­ï¼‰
        
        async function getAllData(page = 1){
            try {
                const res = await axios.get(`/api/posts/index?page=${page}&limit=5`);
                console.log('API Response:', res.data);
                
                // æ›´æ–°åˆ†é¡µä¿¡æ¯
                if (res.data.pagination) {
                    currentPage = res.data.pagination.currentPage;
                    totalPages = res.data.pagination.totalPages;
                    totalPosts = res.data.pagination.totalPosts;
                    updatePaginationInfo('post');
                }
                
                allData = res.data.posts || []; // ä¿å­˜æ•°æ®åˆ°å…¨å±€å˜é‡
                return res.data.posts || [];  // è¿”å›çœŸæ­£çš„æ•°æ®ï¼
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                return []; // å¤±è´¥æ—¶è¿”å›ç©ºæ•°ç»„
            }
        }
        
        // æ›´æ–°åˆ†é¡µä¿¡æ¯æ˜¾ç¤º - æ ¹æ®åŠŸèƒ½ç±»å‹æ›´æ–°å¯¹åº”çš„åˆ†é¡µä¿¡æ¯
        function updatePaginationInfo(functionType = 'post') {
            // éšè—æ‰€æœ‰åˆ†é¡µå…ƒç´ 
            const mainPagination = document.querySelector('.pagination');
            const friendPagination = document.getElementById('friendPagination');
            const collectPagination = document.getElementById('collectPagination');
            
            if (mainPagination) mainPagination.style.display = 'none';
            if (friendPagination) friendPagination.style.display = 'none';
            if (collectPagination) collectPagination.style.display = 'none';
            
            let pageInfo, prevBtn, nextBtn;
            
            if (functionType === 'post') {
                // æ˜¾ç¤ºä¸»åˆ†é¡µ
                if (mainPagination) mainPagination.style.display = 'flex';
                
                pageInfo = document.getElementById('currentPageInfo');
                prevBtn = document.getElementById('prevPage');
                nextBtn = document.getElementById('nextPage');
                
                if (pageInfo) {
                    pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`;
                }
                
                if (prevBtn) {
                    prevBtn.parentElement.classList.toggle('disabled', currentPage <= 1);
                }
                if (nextBtn) {
                    nextBtn.parentElement.classList.toggle('disabled', currentPage >= totalPages);
                }
            } else if (functionType === 'friend') {
                // æ˜¾ç¤ºå¥½å‹åˆ†é¡µ
                if (friendPagination) friendPagination.style.display = 'flex';
                
                pageInfo = document.getElementById('friendCurrentPageInfo');
                prevBtn = document.getElementById('friendPrevPage');
                nextBtn = document.getElementById('friendNextPage');
                
                if (pageInfo) {
                    pageInfo.textContent = `ç¬¬ ${friendCurrentPage} é¡µ / å…± ${friendTotalPages} é¡µ`;
                }
                
                if (prevBtn) {
                    prevBtn.parentElement.classList.toggle('disabled', friendCurrentPage <= 1);
                }
                if (nextBtn) {
                    nextBtn.parentElement.classList.toggle('disabled', friendCurrentPage >= friendTotalPages);
                }
            } else if (functionType === 'collect') {
                // æ˜¾ç¤ºæ”¶è—åˆ†é¡µ
                if (collectPagination) collectPagination.style.display = 'flex';
                
                pageInfo = document.getElementById('collectCurrentPageInfo');
                prevBtn = document.getElementById('collectPrevPage');
                nextBtn = document.getElementById('collectNextPage');
                
                if (pageInfo) {
                    pageInfo.textContent = `ç¬¬ ${collectCurrentPage} é¡µ / å…± ${collectTotalPages} é¡µ`;
                }
                
                if (prevBtn) {
                    prevBtn.parentElement.classList.toggle('disabled', collectCurrentPage <= 1);
                }
                if (nextBtn) {
                    nextBtn.parentElement.classList.toggle('disabled', collectCurrentPage >= collectTotalPages);
                }
            }
        }
        
        // è·³è½¬åˆ°æŒ‡å®šé¡µé¢ - æ ¹æ®å½“å‰æ¿€æ´»çš„åŠŸèƒ½ç±»å‹
        async function goToPage(page) {
            if (currentActiveFunction === 'post') {
                if (page < 1 || page > totalPages) return;
                
                // æ ¹æ®å½“å‰æ¿€æ´»çš„æ’åºæŒ‰é’®å†³å®šæ’åºæ¨¡å¼
                let sortMode = 'time'; // é»˜è®¤æ—¶é—´æ’åº
                if (likeDesc.classList.contains('active')) {
                    sortMode = 'like';
                } else if (timeDesc.classList.contains('active')) {
                    sortMode = 'time';
                }
                
                await getPosts(sortMode, page);
            } else if (currentActiveFunction === 'friend') {
                if (page < 1 || page > friendTotalPages) return;
                await getFriend(page);
            } else if (currentActiveFunction === 'collect') {
                if (page < 1 || page > collectTotalPages) return;
                await getCollect(page);
            }
        }

       //æŒ‰ç…§ç‚¹èµçƒ­åº¦æ¥æ’åº
       let allDataLikeDesc = []
       async function getLikeDesc(){
        try{
            const res = await axios.get('/api/posts/indexLike')
            allDataLikeDesc = res.data
            return allDataLikeDesc
        }catch(error){
            console.log(error)
            return []
        }
       }

       //æ”¶è—
       let allCollect = []

    async function getCollectData(){
        try{
            const token = localStorage.getItem('eleToken');
            if (!token) {
                console.log('æœªç™»å½•ï¼Œæ— æ³•è·å–æ”¶è—æ•°æ®');
                return [];
            }
            
            const res = await axios.get('/api/posts/collect', {
                headers: {
                    'Authorization': token
                }
            });
            allCollect = res.data
            
            return(allCollect)
        }catch(error){
            console.log(error.message)
            return []
        }

    }
    getCollectData().then(allC=>console.log(allC))

    async function getLikeData(postId) {
    try {
        const token = localStorage.getItem('eleToken');
        
        if (!token) {
            // æœªç™»å½•çŠ¶æ€ä¸‹ï¼Œåªè·å–ç‚¹èµæ•°ï¼Œä¸è·å–ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµçš„ä¿¡æ¯
            const res = await axios.get(`/api/posts/like/${postId}`);
            return { 
                likeCount: res.data.likeCount || 0, 
                userIdLike: [] // æœªç™»å½•æ—¶ä¸è¿”å›ç”¨æˆ·ç‚¹èµä¿¡æ¯
            };
        }
        
        // ç™»å½•çŠ¶æ€ä¸‹ï¼Œè·å–å®Œæ•´çš„ç‚¹èµä¿¡æ¯
        const res = await axios.get(`/api/posts/like/${postId}`, {
            headers: {
                'Authorization': token
            }
        });
        return res.data;
    } catch (error) {
        console.error('è·å–ç‚¹èµæ•°æ®å¤±è´¥:', error);
        return { likeCount: 0, userIdLike: [] };
    }
}

    //é¦–å…ˆçœ‹æ˜¯å¦æ˜¯æŒ‰çƒ­åº¦/æŒ‰ç‚¹èµ

    const likeDesc = document.getElementById('likeDesc')
    const timeDesc = document.getElementById('timeDesc')
    const content = document.querySelector('.content-next')

    //ç„¶åæˆ‘ä»¬è·å–çƒ­é—¨è´´
    async function getPosts(sortBy, page = 1) {
        // è®¾ç½®å½“å‰æ¿€æ´»çš„åŠŸèƒ½ç±»å‹
        currentActiveFunction = 'post';
        
        // æ›´æ–°å½“å‰æ’åºçŠ¶æ€
        currentSortMode = sortBy;
        
        // æ˜¾ç¤ºæœç´¢æ å’Œåˆ†é¡µåŠŸèƒ½ï¼ˆå¸–å­åŠŸèƒ½æ€»æ˜¯å¯ç”¨çš„ï¼Œæœç´¢åŠŸèƒ½ä¹Ÿæ€»æ˜¯å¯ç”¨çš„ï¼‰
        const searchBar = document.querySelector('.search-bar-demo');
        const sortDropdown = document.querySelector('.sort-dropdown');
        if (searchBar) searchBar.style.display = 'flex';
        if (sortDropdown) sortDropdown.style.display = 'flex';
        
        let post_Datas = [];

        if (sortBy === 'like') {
            // ç‚¹èµæ’åºæ—¶ä½¿ç”¨åˆ†é¡µAPI
            try {
                const res = await axios.get(`/api/posts/indexLike?page=${page}&limit=5`);
                post_Datas = res.data.posts || [];
                // æ›´æ–°åˆ†é¡µä¿¡æ¯
                if (res.data.pagination) {
                    currentPage = res.data.pagination.currentPage;
                    totalPages = res.data.pagination.totalPages;
                    totalPosts = res.data.pagination.totalPosts;
                    updatePaginationInfo('post');
                }
            } catch (error) {
                console.error('è·å–ç‚¹èµæ’åºæ•°æ®å¤±è´¥:', error);
                post_Datas = [];
            }
        } else {
            // æ—¶é—´æ’åºä½¿ç”¨åˆ†é¡µAPI
            post_Datas = await getAllData(page);
            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            updatePaginationInfo('post');
        }
        
        content.innerHTML = "";
        
        for (let i in post_Datas) {
            if (post_Datas[i].type == 'å¸–å­' || post_Datas[i].type == 'post') {
                const formatted = formatFriendlyTime(post_Datas[i].time);

                // è·å–ç”¨æˆ·çš„å…³æ³¨æ•°å’Œç²‰ä¸æ•°
                let userFollowing = 0;
                let userFollowers = 0;
                try {
                    const userRes = await axios.get(`/api/accounts/${post_Datas[i].id_user}/accounts`);
                    userFollowing = userRes.data.following || 0;
                    userFollowers = userRes.data.followers || 0;
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·å…³æ³¨æ•°æ®å¤±è´¥:', error);
                }

                // åˆ¤æ–­æ˜¯å¦ä¸ºè´´ä¸»
                let deleteBtnHtml = '';
                if (userData && post_Datas[i].id_user == userData.id_user) {
                    deleteBtnHtml = `<button class="btn btn-link btn-sm delete-post-btn" data-id="${post_Datas[i].id}">
                        <i class="bi bi-trash" style="font-size:20px;color:rgb(207, 185, 137);"></i>
                    </button>`;
                }

                // å¤„ç†å›¾ç‰‡
                let imagesArr = [];
                try {
                    imagesArr = post_Datas[i].images ? JSON.parse(post_Datas[i].images) : [];
                } catch(error) {
                    console.error('è§£æå›¾ç‰‡æ•°æ®å¤±è´¥:', error);
                    imagesArr = [];
                }

                let picturesHtml = '';
                if (imagesArr.length > 0) {
                    picturesHtml = `<div class="pictures">` +
                        imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                        `</div>`;
                }

                const li = document.createElement('li');
                content.appendChild(li);
       
        li.innerHTML = `
        <div class="mulu-top" style="position:relative;">
        ${deleteBtnHtml}
        <div class="mulu">
        <image class="avatar" src=${post_Datas[i].avatar}></image>
                        <div class="list">
                        <div class="divide_row">
                            <a href="javascript:;" class="uname" data-userid="${post_Datas[i].id_user}">${post_Datas[i].name}</a>
                            <div class="information">
                                <div class="divide">
                                    <image class="touxiang" src=${post_Datas[i].avatar}></image>
                                    <p class="name">${post_Datas[i].name}</p>
                                </div>
                                <div class="people">
                                    <p>å…³æ³¨: ${userFollowing}</p>
                                    <p>ç²‰ä¸: ${userFollowers}</p>
                                </div>
                            </div>
                              </div>
                            <p class="sentences">${post_Datas[i].content}</p>
                            ${picturesHtml}
                            <div class="last">
                                <p class="time">${formatted}</p>
                                <div class="others">
                                    <a href="javascript:;" class="like" data-id="${post_Datas[i].id}">â¤ 0</a>
                                    <a href="javascript:;" class="collect" data-id="${post_Datas[i].id}">â­ æ”¶è—</a>
                                    <a href='javascript:;' class="say" data-id="${post_Datas[i].id}">ğŸ–Š è¯„è®º</a>
                                </div>
                            </div>
                        </div>
        </div>
         <div class="comments hidden" data-id="${post_Datas[i].id}">
                    <div class="inputComment">
                     <textarea id="my" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." maxlength="200"></textarea>
                     <button class="submitComment">å‘é€</button>
                     </div>
                            <div class="otherComments"></div>
                     </div>
                    </div>
                `;

                // è·å–ç‚¹èµæ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
                try {
                    const likeData = await getLikeData(post_Datas[i].id);
                    const likeIcon = li.querySelector('.like');
                    likeIcon.innerHTML = `â¤${likeData.likeCount}`;
                    
                    // åªæœ‰åœ¨ç™»å½•çŠ¶æ€ä¸‹æ‰æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ
                    if (userData && localStorage.getItem('eleToken')) {
                        for (let p in likeData.userIdLike) {
                            if (likeData.userIdLike[p] == userData.id_user) {
                                likeIcon.classList.add('active');
                            }
                        }
                    }
                } catch(error) {
                    console.error('è·å–ç‚¹èµæ•°æ®å¤±è´¥:', error);
                    // å‡ºé”™æ—¶æ˜¾ç¤ºé»˜è®¤ç‚¹èµæ•°
                    const likeIcon = li.querySelector('.like');
                    likeIcon.innerHTML = `â¤0`;
                }

                // è·å–æ”¶è—æ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
                if (userData && localStorage.getItem('eleToken')) {
                    try {
                        const collectPost = await getCollectData();
                        const collectIcon = li.querySelector('.collect');
                        
                        for (let m in collectPost) {
                            if (collectPost[m].id_from_post == post_Datas[i].id) {
                                collectIcon.classList.add('active');
                            }
                        }
                    } catch(error) {
                        console.error('è·å–æ”¶è—æ•°æ®å¤±è´¥:', error);
                    }
                }
            }
        }
    }

    // ç‚¹å‡»æŒ‰çƒ­åº¦æ’åº
    likeDesc.addEventListener('click', () => {
        if (!likeDesc.classList.contains('active')) {
            likeDesc.classList.add('active')
            timeDesc.classList.remove('active')
            currentSortMode = 'like'; // æ›´æ–°æ’åºçŠ¶æ€
            getPosts('like', 1)  // æ·»åŠ åˆ†é¡µå‚æ•°
        }
    })

    // ç‚¹å‡»æŒ‰æ—¶é—´æ’åº
    timeDesc.addEventListener('click', () => {
        if (!timeDesc.classList.contains('active')) {
            timeDesc.classList.add('active')
            likeDesc.classList.remove('active')
            currentSortMode = 'time'; // æ›´æ–°æ’åºçŠ¶æ€
            getPosts('time', 1)  // æ·»åŠ åˆ†é¡µå‚æ•°
        }
    })


 

     //ç„¶åæˆ‘ä»¬è·å–é—®ç­”è´´
     async function getAsk(){
        
        const ask_Datas = await getAllData(1) // æ·»åŠ åˆ†é¡µå‚æ•°
        console.log('alldata',ask_Datas)
       
        //let post_Datas = []
        for(let i in ask_Datas){

            if(ask_Datas[i].type == 'é—®ç­”'){
                const formatted = formatFriendlyTime(ask_Datas[i].time);

                // è·å–ç”¨æˆ·çš„å…³æ³¨æ•°å’Œç²‰ä¸æ•°
                let userFollowing = 0;
                let userFollowers = 0;
                try {
                    const userRes = await axios.get(`/api/accounts/${ask_Datas[i].id_user}/accounts`);
                    userFollowing = userRes.data.following || 0;
                    userFollowers = userRes.data.followers || 0;
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·å…³æ³¨æ•°æ®å¤±è´¥:', error);
                }
        
            const content = document.querySelector('.content-next');
        const li = document.createElement(`li`)
        content.appendChild(li)
       
        li.innerHTML = `
        <div class="mulu-top">
        <div class="mulu">
        <image class="avatar" src=${ask_Datas[i].avatar}></image>
                
                        <div class="list">
                        <div class="divide_row">
                            <a href="javascript:;" class="uname" data-userid="${ask_Datas[i].id_user}">${ask_Datas[i].name}</a>
                            <div class="information">
                                <div class="divide">
                                    <image class="touxiang" src=${ask_Datas[i].avatar}></image>
                                    <p class="name">${ask_Datas[i].name}</p>
                                </div>
                                <div class="people">
                                    <p>å…³æ³¨: ${userFollowing}</p>
                                    <p>ç²‰ä¸: ${userFollowers}</p>
                                </div>
                            </div>
                              </div>
                            <p class="sentences">${ask_Datas[i].content}</p>
                            <div class="pictures">
                            
                            </div>
                            <div class="last">
                                <p class="time">${formatted}</p>
                                <div class="others">
                                    <a href="javascript:;" class="like" data-id="${i}">â¤0</a>
                                    <a href="javascript:;" class="collect" data-id="${i}">â­Collects</a>
                                    <a href='javascript:;' class="say" data-id="${i}">ğŸ–ŠComments</a>
    
                                    
                                </div>
                            </div>
                        
                            
                        
        </div>
                   
            </div>
           
        `

        }
    }

    }

    

    async function getCollect(page = 1) {
        // è®¾ç½®å½“å‰æ¿€æ´»çš„åŠŸèƒ½ç±»å‹
        currentActiveFunction = 'collect';
        
        const content = document.querySelector('.content-next');
        content.innerHTML = '';
        
        // éšè—æœç´¢æ å’Œåˆ†é¡µåŠŸèƒ½
        const searchBar = document.querySelector('.search-bar-demo');
        const sortDropdown = document.querySelector('.sort-dropdown');
        const mainPagination = document.querySelector('.pagination');
        const friendPagination = document.getElementById('friendPagination');
        const collectPagination = document.getElementById('collectPagination');
        
        if (!userData) {
            // éšè—åˆ†é¡µåŠŸèƒ½å’Œæœç´¢åŠŸèƒ½
            if (searchBar) searchBar.style.display = 'none';
            if (sortDropdown) sortDropdown.style.display = 'none';
            if (mainPagination) mainPagination.style.display = 'none';
            if (friendPagination) friendPagination.style.display = 'none';
            if (collectPagination) collectPagination.style.display = 'none';
            
            content.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ”</div>
                    <div class="empty-state-title">éœ€è¦ç™»å½•</div>
                    <div class="empty-state-description">ç™»å½•åæ‰èƒ½æŸ¥çœ‹ä½ çš„æ”¶è—å†…å®¹</div>
                    <a href="/login" class="empty-state-action">ç«‹å³ç™»å½•</a>
                </div>
            `;
            return;
        }
        
        // ç™»å½•çŠ¶æ€ä¸‹æ˜¾ç¤ºæœç´¢æ å’Œåˆ†é¡µåŠŸèƒ½
        if (searchBar) searchBar.style.display = 'flex';
        if (sortDropdown) sortDropdown.style.display = 'flex';
        
        // è·å–æ‰€æœ‰æ”¶è—è®°å½•
        const collectData = await getCollectData();
        // è·å–æ‰€æœ‰å¸–å­
        const allPosts = await getAllData(page); // æ·»åŠ åˆ†é¡µå‚æ•°

        // åªä¿ç•™å½“å‰ç”¨æˆ·æ”¶è—çš„å¸–å­id
        const myCollectIds = collectData
            .filter(item => item.userid_collect == userData.id_user)
            .map(item => item.id_from_post);

        // è¿‡æ»¤å‡ºè¢«æ”¶è—çš„å¸–å­
        const collectPosts = allPosts.filter(post => myCollectIds.includes(post.id));

        // æ›´æ–°æ”¶è—åˆ†é¡µä¿¡æ¯
        collectCurrentPage = page;
        collectTotalPages = Math.ceil(collectPosts.length / 5);
        collectTotalPosts = collectPosts.length;
        updatePaginationInfo('collect');

        if (collectPosts.length === 0) {
            content.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">â­</div>
                    <div class="empty-state-title">æš‚æ— æ”¶è—</div>
                    <div class="empty-state-description">ä½ è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•å¸–å­</div>
                </div>
            `;
            return;
        }

        for (let i in collectPosts) {
            const post = collectPosts[i];
            const formatted = formatFriendlyTime(post.time);

            // è·å–ç”¨æˆ·çš„å…³æ³¨æ•°å’Œç²‰ä¸æ•°
            let userFollowing = 0;
            let userFollowers = 0;
            try {
                const userRes = await axios.get(`/api/accounts/${post.id_user}/accounts`);
                userFollowing = userRes.data.following || 0;
                userFollowers = userRes.data.followers || 0;
            } catch (error) {
                console.error('è·å–ç”¨æˆ·å…³æ³¨æ•°æ®å¤±è´¥:', error);
            }

            // å¤„ç†å›¾ç‰‡
            let imagesArr = [];
            try {
                imagesArr = post.images ? JSON.parse(post.images) : [];
            } catch (error) {
                imagesArr = [];
            }
            let picturesHtml = '';
            if (imagesArr.length > 0) {
                picturesHtml = `<div class="pictures">` +
                    imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                    `</div>`;
            }

            const li = document.createElement('li');
            content.appendChild(li);

            li.innerHTML = `
            <div class="mulu-top" style="position:relative;">
            <div class="mulu">
            <image class="avatar" src=${post.avatar}></image>
                <div class="list">
                    <div class="divide_row">
                        <a href="javascript:;" class="uname" data-userid="${post.id_user}">${post.name}</a>
                        <div class="information">
                            <div class="divide">
                                <image class="touxiang" src=${post.avatar}></image>
                                <p class="name">${post.name}</p>
                            </div>
                            <div class="people">
                                <p>å…³æ³¨: ${userFollowing}</p>
                                <p>ç²‰ä¸: ${userFollowers}</p>
                            </div>
                        </div>
                    </div>
                    <p class="sentences">${post.content}</p>
                    ${picturesHtml}
                    <div class="last">
                        <p class="time">${formatted}</p>
                        <div class="others">
                            <a href="javascript:;" class="like" data-id="${post.id}">â¤ 0</a>
                            <a href="javascript:;" class="collect active" data-id="${post.id}">â­ æ”¶è—</a>
                            <a href='javascript:;' class="say" data-id="${post.id}">ğŸ–Š è¯„è®º</a>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            `;
            // ç‚¹èµã€æ”¶è—ç­‰åŠŸèƒ½å¯å¤ç”¨getPostsé‡Œçš„é€»è¾‘
        }
    }
  
   
     




// æ£€æŸ¥æœªè¯»æ¶ˆæ¯æ•°é‡å¹¶æ›´æ–°çº¢ç‚¹çŠ¶æ€
async function checkUnreadMessages() {
    try {
        const token = localStorage.getItem('eleToken');
        if (!token) {
            // æœªç™»å½•ï¼Œéšè—çº¢ç‚¹
            const messageDot = document.querySelector('.message-dot');
            if (messageDot) {
                messageDot.style.display = 'none';
            }
            return;
        }

        const response = await axios.get('/api/message', {
            headers: {
                'Authorization': token
            }
        });

        if (response.data.success) {
            const unreadCount = response.data.unreadCount;
            const messageDot = document.querySelector('.message-dot');
            
            if (messageDot) {
                if (unreadCount > 0) {
                    messageDot.style.display = 'inline-block';
                } else {
                    messageDot.style.display = 'none';
                }
            }
        }
    } catch (error) {
        console.error('æ£€æŸ¥æœªè¯»æ¶ˆæ¯å¤±è´¥:', error);
        // å‡ºé”™æ—¶éšè—çº¢ç‚¹
        const messageDot = document.querySelector('.message-dot');
        if (messageDot) {
            messageDot.style.display = 'none';
        }
    }
}

    // é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–å†…å®¹
    document.addEventListener('DOMContentLoaded', async () => {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const token = localStorage.getItem('eleToken');
        const userDataStr = localStorage.getItem('user_data');
        
        if (token && userDataStr) {
            try {
                // é‡æ–°è§£æç”¨æˆ·æ•°æ®ï¼Œç¡®ä¿æ•°æ®æ˜¯æœ€æ–°çš„
                userData = JSON.parse(userDataStr);
                
                // æ£€æŸ¥æœªè¯»æ¶ˆæ¯å¹¶æ›´æ–°çº¢ç‚¹çŠ¶æ€
                await checkUnreadMessages();
            } catch (e) {
                console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                // æ¸…é™¤æ— æ•ˆæ•°æ®
                localStorage.removeItem('eleToken');
                localStorage.removeItem('user_data');
                userData = null;
            }
        } else {
            // æœªç™»å½•çŠ¶æ€ï¼Œæ¸…é™¤å¯èƒ½æ®‹ç•™çš„ç”¨æˆ·æ•°æ®
            userData = null;
            console.log('æœªç™»å½•çŠ¶æ€ï¼Œè·³è¿‡ç”¨æˆ·ç›¸å…³åŠŸèƒ½');
        }
        
        // æ— è®ºæ˜¯å¦ç™»å½•ï¼Œéƒ½åŠ è½½å…³æ³¨åˆ—è¡¨ï¼ˆä¼šæ˜¾ç¤ºç›¸åº”çš„æç¤ºä¿¡æ¯ï¼‰
        await loadFollowingList();
        
        // è·å–å½“å‰URLè·¯å¾„
        const path = window.location.pathname;
        
        // æ ¹æ®è·¯å¾„å†³å®šåŠ è½½ä»€ä¹ˆå†…å®¹å¹¶æ›´æ–°èœå•çŠ¶æ€
        let currentModule = 'post'; // é»˜è®¤æ¨¡å—
        
        if (path.includes('/friend')) {
            currentModule = 'friend';
            await loadContent('friend');
        } else if (path.includes('/collect')) {
            currentModule = 'collect';
            await loadContent('collect');
        } else {
            // é»˜è®¤åŠ è½½å¸–å­åˆ—è¡¨ï¼ˆæœ€çƒ­æ¨¡å¼ï¼‰
            currentModule = 'post';
            currentSortMode = 'like'; // è®¾ç½®é»˜è®¤æ’åºçŠ¶æ€
            likeDesc.classList.add('active'); // æ¿€æ´»æœ€çƒ­æŒ‰é’®
            timeDesc.classList.remove('active'); // å–æ¶ˆæœ€æ–°æŒ‰é’®æ¿€æ´»çŠ¶æ€
            await getPosts('like', 1); // åŠ è½½å¸–å­
        }
        
        // ç¡®ä¿URLä¸å½“å‰æ¨¡å—ä¸€è‡´
        if (currentModule !== 'post') {
            history.replaceState({}, '', `/index/${currentModule}`);
        } else {
            history.replaceState({}, '', '/index');
        }
        
        // æ›´æ–°èœå•æ é€‰ä¸­çŠ¶æ€
        updateMenuActiveState(currentModule);
        
        // æ›´æ–°å¯¼èˆªæ activeçŠ¶æ€
        document.querySelector('.content-next').addEventListener('click', async function(e) {
        const target = e.target;
        const postId = parseInt(target.dataset.id, 10);

        // ç‚¹èµæŒ‰é’®
        if (target.classList.contains('like')) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è·³è½¬åˆ°å¸–å­è¯¦æƒ…é¡µ
            if (!localStorage.getItem('eleToken')) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const userData = JSON.parse(localStorage.getItem('user_data'));
            if (!userData || !userData.id_user) {
                console.error('ç”¨æˆ·æ•°æ®ä¸å®Œæ•´');
                alert('ç”¨æˆ·æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ç™»å½•');
                return;
            }

            try {
                const res = await axios.post('/api/posts/addLike', {
                    userid_like: userData.id_user,
                    id_from_post: postId
                });

                if (res.data.success) {
                    target.classList.toggle('active');
                    const currentCount = parseInt(target.textContent.match(/\d+/)[0]);
                    target.innerHTML = `â¤ ${target.classList.contains('active') ? currentCount + 1 : currentCount - 1}`;

                    const successAlert = document.querySelector('.alert-success');
                    if (successAlert) {
                        successAlert.style.display = 'block';
                        successAlert.textContent = target.classList.contains('active') ? 'ç‚¹èµæˆåŠŸ' : 'å–æ¶ˆç‚¹èµ';
                        setTimeout(() => {
                            successAlert.style.display = 'none';
                        }, 5000);
                    }
                    
                    // æ›´æ–°çº¢ç‚¹çŠ¶æ€
                    await checkUnreadMessages();
                } else {
                    alert(res.data.message);
                }
            } catch (error) {
                console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
                if (error.response) {
                    console.error('å“åº”æ•°æ®:', error.response.data);
                    console.error('å“åº”çŠ¶æ€:', error.response.status);
                    console.error('å“åº”å¤´:', error.response.headers);
                }
                const danger = document.querySelector('.alert-danger');
                if (danger) {
                    danger.textContent = 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•';
                    danger.style.display = 'block';
                    setTimeout(() => {
                        danger.style.display = 'none';
                    }, 5000);
                }
            }
            return;
        }
            
            // æ”¶è—æŒ‰é’®
            if (target.classList.contains('collect')) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è·³è½¬åˆ°å¸–å­è¯¦æƒ…é¡µ
                if (!localStorage.getItem('eleToken')) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }
                
                try {
                    const res = await axios.post('/api/posts/addCollect', {
                        userid_collect: userData.id_user,
                        id_from_post: postId
                    });
                    
                    if (res.data) {
                        target.classList.toggle('active');
                        const currentCount = parseInt(target.textContent.match(/\d+/)[0]);
                        target.innerHTML = `â¤ ${target.classList.contains('active') ? currentCount + 1 : currentCount - 1}`;
                        
                        const successAlert = document.querySelector('.alert-success');
                        if (successAlert) {
                            successAlert.style.display = 'block';
                            successAlert.textContent = target.classList.contains('active') ? 'æ”¶è—æˆåŠŸ' : 'å–æ¶ˆæ”¶è—';
                            setTimeout(() => {
                                successAlert.style.display = 'none';
                            }, 5000);
                        }
                        
                        // æ›´æ–°çº¢ç‚¹çŠ¶æ€
                        await checkUnreadMessages();
                    }
                } catch (error) {
                    console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
                    const danger = document.querySelector('.alert-danger');
                    if (danger) {
                        danger.textContent = 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•';
                        danger.style.display = 'block';
                        setTimeout(() => {
                            danger.style.display = 'none';
                        }, 5000);
                    }
                }
                return;
            }
            
            // åˆ é™¤æŒ‰é’®
            if (target.classList.contains('delete-post-btn') || target.closest('.delete-post-btn')) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è·³è½¬åˆ°å¸–å­è¯¦æƒ…é¡µ
                const deleteBtn = target.classList.contains('delete-post-btn') ? target : target.closest('.delete-post-btn');
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¸–å­å—ï¼Ÿ')) {
                    try {
                        const res = await axios.delete(`/api/posts/${deleteBtn.dataset.id}`);
                        if (res.data) {
                            const postElement = deleteBtn.closest('.mulu-top');
                            postElement.remove();
                            const successAlert = document.querySelector('.alert-success');
                            if (successAlert) {
                                successAlert.style.display = 'block';
                                successAlert.textContent = 'åˆ é™¤æˆåŠŸ';
                                setTimeout(() => {
                                    successAlert.style.display = 'none';
                                }, 5000);
                            }
                        }
                    } catch (error) {
                        console.error('åˆ é™¤å¤±è´¥:', error);
                        const danger = document.querySelector('.alert-danger');
                        if (danger) {
                            danger.textContent = 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•';
                            danger.style.display = 'block';
                            setTimeout(() => {
                                danger.style.display = 'none';
                            }, 5000);
                        }
                    }
                }
                return;
            }
            
            // å›¾ç‰‡ç‚¹å‡»äº‹ä»¶
            if (target.classList.contains('post-image')) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è·³è½¬åˆ°å¸–å­è¯¦æƒ…é¡µ
                const previewImage = document.querySelector('.preview-image');
                const overlay = document.querySelector('.image-preview-overlay');
                if (previewImage && overlay) {
                    previewImage.src = target.src;
                    overlay.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
                return;
            }

            // è¯„è®ºåˆ†é¡µæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            if (target.classList.contains('prev-page-btn') || target.classList.contains('next-page-btn')) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                const postId = target.dataset.postId;
                const pageInfo = window.commentPages[postId];
                
                if (pageInfo) {
                    if (target.classList.contains('prev-page-btn') && pageInfo.currentPage > 1) {
                        pageInfo.currentPage--;
                    } else if (target.classList.contains('next-page-btn') && pageInfo.currentPage < pageInfo.totalPages) {
                        pageInfo.currentPage++;
                    }
                    
                    // é‡æ–°åŠ è½½è¯„è®º
                    const muluTop = target.closest('.mulu-top');
                    if (muluTop) {
                        const cmt = muluTop.querySelector(`.comments[data-id="${postId}"]`);
                        if (cmt && !cmt.classList.contains('hidden')) {
                            const otherComments = cmt.querySelector('.otherComments');
                            loadCommentsForPost(postId, pageInfo, otherComments, cmt);
                        }
                    }
                }
                return;
            }

            // è¯„è®ºæŒ‰é’®
            if (target.classList.contains('say')) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è·³è½¬åˆ°å¸–å­è¯¦æƒ…é¡µ
                console.log('ç‚¹å‡»äº†è¯„è®ºæŒ‰é’®');
                const postId = target.dataset.id;
                console.log('å¸–å­ID:', postId);
                
                const muluTop = target.closest('.mulu-top');
                console.log('æ‰¾åˆ°çš„mulu-topå…ƒç´ :', muluTop);
                
                if (muluTop) {
                    const cmt = muluTop.querySelector(`.comments[data-id="${postId}"]`);
                    console.log('æ‰¾åˆ°çš„è¯„è®ºåŒºåŸŸå…ƒç´ :', cmt);
                    console.log('è¯„è®ºåŒºåŸŸå½“å‰æ˜¾ç¤ºçŠ¶æ€:', cmt ? cmt.classList.contains('hidden') : 'æœªæ‰¾åˆ°');
                    
                    if (cmt) {
                        console.log('åˆ‡æ¢è¯„è®ºåŒºåŸŸæ˜¾ç¤ºçŠ¶æ€');
                        cmt.classList.toggle('hidden');
                        console.log('åˆ‡æ¢åçš„æ˜¾ç¤ºçŠ¶æ€:', cmt.classList.contains('hidden'));
                        
                        // å¦‚æœè¯„è®ºåŒºåŸŸæ˜¾ç¤ºï¼Œåˆ™åŠ è½½è¯„è®º
                        if (!cmt.classList.contains('hidden')) {
                            try {
                                // åˆå§‹åŒ–åˆ†é¡µå˜é‡
                                if (!window.commentPages) {
                                    window.commentPages = {};
                                }
                                if (!window.commentPages[postId]) {
                                    window.commentPages[postId] = {
                                        currentPage: 1,
                                        pageSize: 5,
                                        total: 0,
                                        totalPages: 0
                                    };
                                }
                                
                                const pageInfo = window.commentPages[postId];
                                const res = await axios.get(`/api/posts/${postId}/comments?page=${pageInfo.currentPage}&limit=${pageInfo.pageSize}`);
                                const data = res.data;
                                const comments = data.comments || data; // å…¼å®¹æ—§æ ¼å¼
                                const otherComments = cmt.querySelector('.otherComments');
                                
                                // æ›´æ–°åˆ†é¡µä¿¡æ¯
                                if (data.total !== undefined) {
                                    pageInfo.total = data.total;
                                    pageInfo.totalPages = data.totalPages;
                                }
                                
                                // ä½¿ç”¨ç»Ÿä¸€çš„loadCommentsForPostå‡½æ•°æ¥æ¸²æŸ“è¯„è®º
                                await loadCommentsForPost(postId, pageInfo, otherComments, cmt);

                                // è®¾ç½®è¯„è®ºæäº¤æŒ‰é’®äº‹ä»¶
                                const submitBtn = cmt.querySelector('.submitComment');
                                const textarea = cmt.querySelector('textarea');
                                
                                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                                if (!localStorage.getItem('eleToken')) {
                                    textarea.placeholder = 'è¯·å…ˆç™»å½•åå†è¯„è®º';
                                    submitBtn.disabled = true;
                                    submitBtn.style.cursor = 'not-allowed';
                                    submitBtn.style.opacity = '0.6';
                                } else {
                                    textarea.placeholder = 'è¯´ç‚¹ä»€ä¹ˆå§...';
                                    submitBtn.disabled = false;
                                    submitBtn.style.cursor = 'pointer';
                                    submitBtn.style.opacity = '1';
                                    
                                    submitBtn.onclick = async () => {
                                        const content = textarea.value.trim();
                                        if (!content) {
                                            alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º');
                                            return;
                                        }
                                        
                                        const userData = JSON.parse(localStorage.getItem('user_data'));
                                        if (!userData || !userData.id_user) {
                                            alert('ç”¨æˆ·æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ç™»å½•');
                                            return;
                                        }
                                        
                                        try {
                                            const commentData = {
                                                content: content,
                                                id_user: userData.id_user,
                                                id_from_post: postId
                                            };

                                            if (textarea.dataset.parentId) {
                                                commentData.parent_id = textarea.dataset.parentId;
                                                console.log('å‘é€å›å¤ï¼Œparent_id:', commentData.parent_id);
                                            }
                                            if (textarea.dataset.parentUserId) {
                                                commentData.parent_user_id = textarea.dataset.parentUserId;
                                                console.log('å‘é€å›å¤ï¼Œparent_user_id:', commentData.parent_user_id);
                                            }

                                            const res = await axios.post('/api/posts/comments', commentData);
                                            
                                            if (res.data && res.data.success) {
                                                success_alert.style.display = 'block';
                                                success_alert.textContent = 'è¯„è®ºæˆåŠŸ';
                                                setTimeout(() => {
                                                    success_alert.style.display = 'none';
                                                }, 5000);
                                                
                                                // æ·»åŠ æ–°è¯„è®ºåˆ°åˆ—è¡¨
                                                const newComment = document.createElement('div');
                                                newComment.innerHTML = renderComment(res.data);
                                                otherComments.insertBefore(newComment, otherComments.firstChild);
                                                textarea.value = '';
                                                textarea.placeholder = 'è¯´ç‚¹ä»€ä¹ˆå§...';
                                                delete textarea.dataset.parentId;
                                                delete textarea.dataset.parentUserId;
                                            }
                                        } catch (error) {
                                            console.error('è¯„è®ºæäº¤å¤±è´¥:', error);
                                            danger.textContent = 'è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•';
                                            danger.style.display = 'block';
                                            setTimeout(() => {
                                                danger.style.display = 'none';
                                            }, 5000);
                                        }
                                    };
                                }
                            } catch (error) {
                                console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                            }
                        }
                    }
                }
                return;
            }
            
            // ç”¨æˆ·é¡µé¢è·³è½¬
            if (target.classList.contains('uname')) {
                const userId = target.dataset.userid;
                // åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰ç™»å½•ç”¨æˆ·
                if (userData && userId == userData.id_user) {
                    window.location.href = '/personal';
                } else {
                    window.location.href = `/accounts?id=${userId}`;
                }
                return;
            }
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯å¸–å­å®¹å™¨ï¼Œè·³è½¬åˆ°è¯¦æƒ…é¡µï¼ˆæ’é™¤è¯„è®ºåŒºï¼‰
            const muluTop = target.closest('.mulu-top');
            if (muluTop) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»çš„æ˜¯è¯„è®ºåŒºç›¸å…³å…ƒç´ 
                const isCommentArea = target.closest('.comments') || 
                                    target.closest('.inputComment') || 
                                    target.closest('.otherComments') ||
                                    target.closest('.xijie') ||
                                    target.closest('.reply-container') ||
                                    target.closest('.submitComment') ||
                                    target.closest('textarea') ||
                                    target.closest('.delete-comment-btn') ||
                                    target.closest('.reply-btn') ||
                                    target.closest('.name') ||
                                    target.closest('.author-container');
                
                if (!isCommentArea) {
                    const postId = muluTop.querySelector('.like').dataset.id;
                    window.location.href = `/post-detail/${postId}`;
                }
            }
        });
        
    });

    // æ·»åŠ ç”¨æˆ·åæ‚¬åœäº‹ä»¶å¤„ç†
    document.addEventListener('mouseover', function(e) {
        if (e.target.classList.contains('uname')) {
            const information = e.target.nextElementSibling;
            if (information && information.classList.contains('information')) {
                information.classList.add('active');
            }
        }
    });

    document.addEventListener('mouseout', function(e) {
        if (e.target.classList.contains('uname')) {
            const information = e.target.nextElementSibling;
            if (information && information.classList.contains('information')) {
                information.classList.remove('active');
            }
        }
    });

    // æ·»åŠ å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
    const overlay = document.querySelector('.image-preview-overlay');
    const previewImage = document.querySelector('.preview-image');

    // ç‚¹å‡»é®ç½©å±‚å…³é—­é¢„è§ˆ
    overlay.addEventListener('click', function() {
        overlay.style.display = 'none';
        document.body.style.overflow = '';
    });

    // é˜»æ­¢å›¾ç‰‡ç‚¹å‡»äº‹ä»¶å†’æ³¡
    previewImage.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // æ›´æ–°å¯¼èˆªæ activeçŠ¶æ€ï¼ˆåªæ›´æ–°é¡¶éƒ¨å¯¼èˆªï¼Œä¸å½±å“ä¾§è¾¹èœå•ï¼‰
    function updateNavigation(path) {
        // å½’ä¸€åŒ–è·¯å¾„ï¼Œå–æœ€åä¸€æ®µ
        let type = path.split('/').filter(Boolean).pop();
        // å…¼å®¹ /index æˆ– /index/ è¿™ç§æƒ…å†µ
        if (!type || type === 'index') type = 'post';

        // åªæ›´æ–°é¡¶éƒ¨å¯¼èˆªæ çš„activeçŠ¶æ€ï¼Œä¸å½±å“ä¾§è¾¹èœå•
        const topNavItems = document.querySelectorAll('.topics li a');
        topNavItems.forEach(item => {
            item.classList.remove('active');
            item.style.color = '#666';
            // å–æŒ‰é’®çš„ç±»å‹
            const btnType = item.getAttribute('data-type') || (item.getAttribute('onclick') ? item.getAttribute('onclick').match(/'([^']+)'/)[1] : '');
            if (btnType === type) {
                item.classList.add('active');
                item.style.color = "#e09620";
            }
        });
    }

// æ˜¾ç¤ºæ·»åŠ å†…å®¹å¼¹çª—
function showAdding() {
    document.querySelector('.adding').classList.add('active');
    document.querySelector('.adding_content').style.display = 'block';
}

// å…³é—­æ·»åŠ å†…å®¹å¼¹çª—
function closeAdding() {
    document.querySelector('.adding').classList.remove('active');
    document.querySelector('.adding_content').style.display = 'none';
}

//æäº¤è¡¨å•

// ç¦ç”¨é—®ç­”é€‰é¡¹çš„é€‰æ‹©
const contentTypeSelect = document.getElementById('contentType');
if (contentTypeSelect) {
    contentTypeSelect.addEventListener('change', function() {
        if (this.value === 'é—®ç­”') {
            this.value = 'å¸–å­';
            alert('é—®ç­”åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°"å¸–å­"ç±»å‹');
        }
    });
}

Array.from(forms).forEach(form=>{
    form.addEventListener('submit',async(event)=>{
        event.preventDefault();
        event.stopPropagation();

        //æ£€æŸ¥ä¸€ä¸‹å†…å®¹ä¸èƒ½ä¸ºç©º
        const newContent = document.getElementById('content');
        const newType = document.getElementById('contentType');
        
        console.log('=== è¡¨å•æ•°æ®æ£€æŸ¥ ===');
        console.log('newContentå…ƒç´ :', newContent);
        console.log('newTypeå…ƒç´ :', newType);
        console.log('newContent.value:', newContent ? newContent.value : 'å…ƒç´ ä¸å­˜åœ¨');
        console.log('newType.value:', newType ? newType.value : 'å…ƒç´ ä¸å­˜åœ¨');
        console.log('newContent.value.trim():', newContent ? newContent.value.trim() : 'å…ƒç´ ä¸å­˜åœ¨');
        
        if(!newContent || !newType) {
            console.error('âŒ è¡¨å•å…ƒç´ æœªæ‰¾åˆ°');
            danger.textContent = 'è¡¨å•å…ƒç´ æœªæ‰¾åˆ°';
            danger.style.display = 'block';
            setTimeout(()=>{
                danger.style.display = 'none';
            },5000);
            return;
        }
        
        if(newContent.value.trim()==""){
            console.error('âŒ å†…å®¹ä¸ºç©º');
            danger.textContent = 'å†…å®¹ä¸èƒ½ä¸ºç©º';
            danger.style.display = 'block';
            setTimeout(()=>{
                danger.style.display = 'none';
            },5000);
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºé—®ç­”ç±»å‹ï¼ˆå·²ç¦ç”¨ï¼‰
        if(newType.value === 'é—®ç­”'){
            console.error('âŒ é—®ç­”åŠŸèƒ½å·²ç¦ç”¨');
            danger.textContent = 'é—®ç­”åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œè¯·é€‰æ‹©"å¸–å­"ç±»å‹';
            danger.style.display = 'block';
            setTimeout(()=>{
                danger.style.display = 'none';
            },5000);
            return;
        }

        console.log('=== æ„å»ºFormData ===');
        const formData = new FormData();
        
        const contentValue = newContent.value.trim();
        const typeValue = newType.value;
        const timeValue = new Date().toISOString();
        
        console.log('å‡†å¤‡æ·»åŠ çš„æ•°æ®:');
        console.log('- content:', contentValue);
        console.log('- type:', typeValue);
        console.log('- time:', timeValue);
        
        formData.append('content', contentValue);
        formData.append('type', typeValue);
        formData.append('time', timeValue);
        
        selectedImages.forEach((img, idx) => {
            console.log(`- æ·»åŠ å›¾ç‰‡ ${idx}:`, img.file.name);
            formData.append('images', img.file);
        });

        // éªŒè¯FormDataå†…å®¹
        console.log('=== FormDataéªŒè¯ ===');
        console.log('FormDataæ¡ç›®æ•°:', formData.entries ? 'å¯ç”¨' : 'ä¸å¯ç”¨');
        
        // è°ƒè¯•ä¿¡æ¯
        console.log('è¡¨å•æ•°æ®:', {
            content: contentValue,
            type: typeValue,
            time: timeValue,
            imagesCount: selectedImages.length
        });

        try {
            console.log('å‘é€è¯·æ±‚çš„ç”¨æˆ·æ•°æ®:', userData);
            console.log('ç”¨æˆ·ç™»å½•çŠ¶æ€:', !!localStorage.getItem('eleToken'));
            console.log('ç”¨æˆ·æ•°æ®çŠ¶æ€:', !!userData);
            
            // æ£€æŸ¥è®¤è¯å¤´
            const headers = {
                'Content-Type': 'multipart/form-data'
            };
            
            const token = localStorage.getItem('eleToken');
            if (token) {
                headers['Authorization'] = token;
                console.log('æ·»åŠ è®¤è¯å¤´:', token.substring(0, 20) + '...');
            } else {
                console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°è®¤è¯token');
            }
            
            // ä½¿ç”¨å°è£…åçš„requestæ–¹æ³•å‘é€è¯·æ±‚
            const res = await axios.post('/api/posts/add', formData, { headers });
            
            console.log('å‘å¸ƒå“åº”:', res);
            
            if(res.data) {
                //æ˜¾ç¤ºæˆåŠŸ
                success_alert.style.display = 'block';
                setTimeout(()=>{
                    success_alert.style.display = 'none';
                },5000);
                
                // è·å–æ–°å‘å¸ƒçš„å¸–å­æ•°æ®
                const newPost = res.data;
                console.log('å‘å¸ƒå“åº”æ•°æ®:', newPost);
                console.log('æ•°æ®ç±»å‹:', typeof newPost);
                console.log('æ•°æ®é”®å€¼:', Object.keys(newPost));
                
                // ç«‹å³å°†æ–°å¸–å­æ·»åŠ åˆ°é¡µé¢é¡¶éƒ¨
                await addNewPostToTop(newPost);
                
                closeAdding();
                // æ¸…ç©ºè¡¨å•
                form.reset();
                
                // å»¶è¿Ÿåˆ·æ–°ï¼Œè®©æ–°å¸–å­æŒ‰æ­£å¸¸æ’åºè§„åˆ™æ’åˆ—
                setTimeout(async () => {
                    await loadContent('post');
                }, 2000);
            }
        } catch(error) {
            console.error('å‘å¸ƒå¤±è´¥:', error);
            danger.textContent = error.response?.data || error.message || 'å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•';
            danger.style.display = 'block';
            setTimeout(()=>{
                danger.style.display = 'none';
            },5000);
        }
    });
    });



            // æ·»åŠ æ–°å¸–å­åˆ°é¡µé¢é¡¶éƒ¨çš„å‡½æ•°
        // åœ¨æ­¤ä¹‹å‰æ’å…¥æ ¼å¼åŒ–æ—¶é—´å‡½æ•°
        function formatFriendlyTime(timeStr) {
            const now = new Date();
            const postTime = new Date(timeStr);
            const diffMs = now - postTime;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);

            if (diffMin < 1) {
                return 'åˆšåˆš';
            } else if (diffHour < 1) {
                return `${diffMin}åˆ†é’Ÿå‰`;
            } else if (diffHour < 24) {
                return `${diffHour}å°æ—¶å‰`;
            } else {
                // æ ¼å¼åŒ–ä¸º yyyy-mm-dd hh:mm
                const y = postTime.getFullYear();
                const m = String(postTime.getMonth() + 1).padStart(2, '0');
                const d = String(postTime.getDate()).padStart(2, '0');
                const h = String(postTime.getHours()).padStart(2, '0');
                const min = String(postTime.getMinutes()).padStart(2, '0');
                return `${y}-${m}-${d} ${h}:${min}`;
            }
        }
        async function addNewPostToTop(newPost) {
            console.log('addNewPostToTop æ¥æ”¶åˆ°çš„æ•°æ®:', newPost);
            console.log('newPost.id:', newPost.id);
            console.log('newPost.name:', newPost.name);
            console.log('newPost.avatar:', newPost.avatar);
            console.log('newPost.content:', newPost.content);
            console.log('newPost.time:', newPost.time);
            
            const content = document.querySelector('.content-next');
            
            // è·å–ç”¨æˆ·ä¿¡æ¯
            let userFollowing = 0;
            let userFollowers = 0;
            try {
                const userRes = await axios.get(`/api/accounts/${newPost.id_user}/accounts`);
                userFollowing = userRes.data.following || 0;
                userFollowers = userRes.data.followers || 0;
            } catch (error) {
                console.error('è·å–ç”¨æˆ·å…³æ³¨æ•°æ®å¤±è´¥:', error);
            }

            // å¤„ç†å›¾ç‰‡
            let imagesArr = [];
            try {
                imagesArr = newPost.images ? JSON.parse(newPost.images) : [];
            } catch(error) {
                console.error('è§£æå›¾ç‰‡æ•°æ®å¤±è´¥:', error);
                imagesArr = [];
            }

            let picturesHtml = '';
            if (imagesArr.length > 0) {
                picturesHtml = `<div class="pictures">` +
                    imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                    `</div>`;
            }

            const formatted = formatFriendlyTime(newPost.time);

            // åˆ¤æ–­æ˜¯å¦ä¸ºè´´ä¸»
            let deleteBtnHtml = '';
            if (userData && newPost.id_user == userData.id_user) {
                deleteBtnHtml = `<button class="btn btn-link btn-sm delete-post-btn" data-id="${newPost.id}">
                    <i class="bi bi-trash" style="font-size:20px;color:rgb(207, 185, 137);"></i>
                </button>`;
            }

            // åˆ›å»ºæ–°å¸–å­å…ƒç´ 
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="mulu-top" style="position:relative;">
                    ${deleteBtnHtml}
                    <div class="mulu">
                        <image class="avatar" src=${newPost.avatar}></image>
                        <div class="list">
                            <div class="divide_row">
                                <a href="javascript:;" class="uname" data-userid="${newPost.id_user}">${newPost.name}</a>
                                <div class="information">
                                    <div class="divide">
                                        <image class="touxiang" src=${newPost.avatar}></image>
                                        <p class="name">${newPost.name}</p>
                                    </div>
                                    <div class="people">
                                        <p>å…³æ³¨: ${userFollowing}</p>
                                        <p>ç²‰ä¸: ${userFollowers}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="sentences">${newPost.content}</div>
                            ${picturesHtml}
                            <div class="last">
                                <div class="time">${formatted}</div>
                                <div class="others">
                                    <a href="javascript:;" class="like" data-id="${newPost.id}" data-userid="${newPost.id_user}">
                                        <i class="bi bi-heart"></i>
                                        <span class="like-count">0</span>
                                    </a>
                                    <a href="javascript:;" class="collect" data-id="${newPost.id}" data-userid="${newPost.id_user}">
                                        <i class="bi bi-star"></i>
                                        æ”¶è—
                                    </a>
                                    <a href="javascript:;" class="say" data-id="${newPost.id}" data-userid="${newPost.id_user}">
                                        <i class="bi bi-chat"></i>
                                        è¯„è®º
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="comments hidden" id="comments-${newPost.id}">
                    <div class="inputComment">
                        <textarea placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." maxlength="200"></textarea>
                        <button class="submitComment" data-id="${newPost.id}" data-userid="${newPost.id_user}">å‘é€è¯„è®º</button>
                    </div>
                    <div class="otherComments">
                        <!-- è¯„è®ºåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            `;

            // å°†æ–°å¸–å­æ’å…¥åˆ°é¡µé¢é¡¶éƒ¨
            if (content.firstChild) {
                content.insertBefore(li, content.firstChild);
            } else {
                content.appendChild(li);
            }

            // æ–°å¸–å­ä¼šè‡ªåŠ¨ç»§æ‰¿ç°æœ‰çš„å§”æ‰˜äº‹ä»¶ç›‘å¬å™¨
            // ä¸éœ€è¦é¢å¤–æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯äº‹ä»¶å§”æ‰˜
        }

    // å›¾ç‰‡ä¸Šä¼ ä¸é¢„è§ˆ
let selectedImages = [];

const imageInput = document.getElementById('imageInput');
const addImageBtn = document.getElementById('addImageBtn');
const imageGrid = document.getElementById('imageGrid');

addImageBtn.onclick = () => {
    if (selectedImages.length >= 9) return;
    imageInput.click();
};

imageInput.onchange = function(e) {
    const files = Array.from(e.target.files);
    const remain = 9 - selectedImages.length;
    const toAdd = files.slice(0, remain);
    toAdd.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(ev) {
            selectedImages.push({file, url: ev.target.result});
            renderImageGrid();
        };
        reader.readAsDataURL(file);
    });
    imageInput.value = '';
};

function renderImageGrid() {
    imageGrid.innerHTML = '';
    selectedImages.forEach((img, idx) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'image-thumb-wrapper';
        wrapper.innerHTML = `
            <img src="${img.url}" class="image-thumb">
            <button class="image-thumb-delete" data-idx="${idx}">&times;</button>
        `;
        imageGrid.appendChild(wrapper);
    });
    if (selectedImages.length < 9) {
        imageGrid.appendChild(addImageBtn);
    }
    // åˆ é™¤æŒ‰é’®äº‹ä»¶
    imageGrid.querySelectorAll('.image-thumb-delete').forEach(btn => {
        btn.onclick = function() {
            const idx = parseInt(btn.dataset.idx);
            selectedImages.splice(idx, 1);
            renderImageGrid();
        }
    });
}

const sortDropdown = document.querySelector('.sort-dropdown');
const sortToggle = document.querySelector('.sort-toggle');
const twoType = document.querySelector('.sort-dropdown .two_type');

sortToggle.addEventListener('click', function(e) {
    e.stopPropagation();
    sortDropdown.classList.toggle('open');
    if (sortDropdown.classList.contains('open')) {
        twoType.style.display = 'flex';
    } else {
        twoType.style.display = 'none';
    }
});

// ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹è‡ªåŠ¨æ”¶èµ·
document.addEventListener('click', function(e) {
    if (sortDropdown.classList.contains('open')) {
        sortDropdown.classList.remove('open');
        twoType.style.display = 'none';
    }
});

    // è·å–å¥½å‹ï¼ˆå…³æ³¨çš„äººï¼‰å‘çš„æ‰€æœ‰å¸–å­
    async function getFriend(page = 1) {
        // è®¾ç½®å½“å‰æ¿€æ´»çš„åŠŸèƒ½ç±»å‹
        currentActiveFunction = 'friend';
        
        const content = document.querySelector('.content-next');
        content.innerHTML = '';
        
        // éšè—æœç´¢æ å’Œåˆ†é¡µåŠŸèƒ½
        const searchBar = document.querySelector('.search-bar-demo');
        const sortDropdown = document.querySelector('.sort-dropdown');
        const mainPagination = document.querySelector('.pagination');
        const friendPagination = document.getElementById('friendPagination');
        const collectPagination = document.getElementById('collectPagination');
        
        if (!userData) {
            // éšè—åˆ†é¡µåŠŸèƒ½å’Œæœç´¢åŠŸèƒ½
            if (searchBar) searchBar.style.display = 'none';
            if (sortDropdown) sortDropdown.style.display = 'none';
            if (mainPagination) mainPagination.style.display = 'none';
            if (friendPagination) friendPagination.style.display = 'none';
            if (collectPagination) collectPagination.style.display = 'none';
            
            content.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘¥</div>
                    <div class="empty-state-title">éœ€è¦ç™»å½•</div>
                    <div class="empty-state-description">ç™»å½•åæ‰èƒ½æŸ¥çœ‹å…³æ³¨å¥½å‹çš„åŠ¨æ€</div>
                    <a href="/login" class="empty-state-action">ç«‹å³ç™»å½•</a>
                </div>
            `;
            return;
        }
        
        // ç™»å½•çŠ¶æ€ä¸‹æ˜¾ç¤ºæœç´¢æ å’Œåˆ†é¡µåŠŸèƒ½
        if (searchBar) searchBar.style.display = 'flex';
        if (sortDropdown) sortDropdown.style.display = 'flex';
    
    try {
        // ä½¿ç”¨æ–°çš„APIç«¯ç‚¹è·å–å¥½å‹å¸–å­
        const token = localStorage.getItem('eleToken');
        if (!token) {
            content.innerHTML = 'è¯·å…ˆç™»å½•';
            return;
        }
        
        const response = await axios.get(`/api/posts/friends?page=${page}&limit=5`, {
            headers: {
                'Authorization': token
            }
        });
        
        if (!response.data.success) {
            content.innerHTML = 'è·å–å¥½å‹å¸–å­å¤±è´¥';
            return;
        }
        
        const friendPosts = response.data.data;
        
        // æ›´æ–°å¥½å‹åˆ†é¡µä¿¡æ¯
        if (response.data.pagination) {
            friendCurrentPage = response.data.pagination.currentPage;
            friendTotalPages = response.data.pagination.totalPages;
            friendTotalPosts = response.data.pagination.totalPosts;
            updatePaginationInfo('friend');
        }
        
        if (friendPosts.length === 0) {
            content.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘¥</div>
                    <div class="empty-state-title">æš‚æ— å¥½å‹åŠ¨æ€</div>
                    <div class="empty-state-description">ä½ å…³æ³¨çš„äººè¿˜æ²¡æœ‰å‘è¿‡å¸–å­</div>
                </div>
            `;
            return;
        }
        
        for (let i in friendPosts) {
            const post = friendPosts[i];
            const formatted = formatFriendlyTime(post.time);
            
            // è·å–ç”¨æˆ·çš„å…³æ³¨æ•°å’Œç²‰ä¸æ•°
            let userFollowing = 0;
            let userFollowers = 0;
            try {
                const userRes = await axios.get(`/api/accounts/${post.id_user}/accounts`);
                userFollowing = userRes.data.following || 0;
                userFollowers = userRes.data.followers || 0;
            } catch (error) {
                console.error('è·å–ç”¨æˆ·å…³æ³¨æ•°æ®å¤±è´¥:', error);
            }
            
            // å¤„ç†å›¾ç‰‡
            let imagesArr = [];
            try {
                imagesArr = post.images ? JSON.parse(post.images) : [];
            } catch(error) {
                imagesArr = [];
            }
            let picturesHtml = '';
            if (imagesArr.length > 0) {
                picturesHtml = `<div class="pictures">` +
                    imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                    `</div>`;
            }
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºè´´ä¸»
            let deleteBtnHtml = '';
            if (userData && post.id_user == userData.id_user) {
                deleteBtnHtml = `<button class="btn btn-link btn-sm delete-post-btn" data-id="${post.id}">
                    <i class="bi bi-trash" style="font-size:20px;color:rgb(207, 185, 137);"></i>
                </button>`;
            }
            
            const li = document.createElement('li');
            content.appendChild(li);
            li.innerHTML = `
            <div class="mulu-top" style="position:relative;">
                ${deleteBtnHtml}
                <div class="mulu">
                    <image class="avatar" src=${post.avatar}></image>
                    <div class="list">
                        <div class="divide_row">
                            <a href="javascript:;" class="uname" data-userid="${post.id_user}">${post.name}</a>
                            <div class="information">
                                <div class="divide">
                                    <image class="touxiang" src=${post.avatar}></image>
                                    <p class="name">${post.name}</p>
                                </div>
                                <div class="people">
                                    <p>å…³æ³¨: ${userFollowing}</p>
                                    <p>ç²‰ä¸: ${userFollowers}</p>
                                </div>
                            </div>
                        </div>
                        <p class="sentences">${post.content}</p>
                        ${picturesHtml}
                        <div class="last">
                            <p class="time">${formatted}</p>
                            <div class="others">
                                <a href="javascript:;" class="like" data-id="${post.id}">â¤ 0</a>
                                <a href="javascript:;" class="collect" data-id="${post.id}">â­ æ”¶è—</a>
                                <a href='javascript:;' class="say" data-id="${post.id}">ğŸ–Š è¯„è®º</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }
        
        // äº‹ä»¶ç»‘å®šé€šè¿‡äº‹ä»¶å§”æ‰˜å¤„ç†ï¼Œä¸éœ€è¦å•ç‹¬ç»‘å®š
        
    } catch (error) {
        console.error('è·å–å¥½å‹å¸–å­å¤±è´¥:', error);
        content.innerHTML = 'è·å–å¥½å‹å¸–å­å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
    }
}

    window.addEventListener('popstate', function() {
        const path = window.location.pathname;
        let page = 'post';
        if (path.includes('/friend')) page = 'friend';
        else if (path.includes('/collect')) page = 'collect';
        // é—®ç­”åŠŸèƒ½å·²ç¦ç”¨ï¼Œç»Ÿä¸€è·³è½¬åˆ°å¸–å­é¡µé¢
        else if (path.includes('/ask')) page = 'post';
        
        // æ›´æ–°å½“å‰æ¿€æ´»çš„åŠŸèƒ½ç±»å‹
        currentActiveFunction = page;
        
        // æ›´æ–°èœå•æ é€‰ä¸­çŠ¶æ€
        updateMenuActiveState(page);
        
        loadContent(page);
    });

// æ·»åŠ åˆ†é¡µäº‹ä»¶å¤„ç†
document.addEventListener('DOMContentLoaded', function() {
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    
    if (prevPage) {
        prevPage.addEventListener('click', function() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        });
    }
    
    if (nextPage) {
        nextPage.addEventListener('click', function() {
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        });
    }
    
    // é¡µé¢åˆå§‹åŒ–æ—¶ä¸éœ€è¦æ˜¾ç¤ºæœç´¢æç¤ºï¼Œå› ä¸ºä¸Šé¢çš„åˆå§‹åŒ–é€»è¾‘å·²ç»å¤„ç†äº†
    // showSearchPrompt();
});

    </script>
