<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4KNWJP3BH3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4KNWJP3BH3');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../css/register.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../http.js"></script>
      <!-- åŸ‹ç‚¹å·¥å…·å‡½æ•° -->
      <script>
        // åŸ‹ç‚¹å·¥å…·å‡½æ•°
        window.trackEvent = function(eventName, eventData = {}) {
            try {
                // æ„å»ºåŸ‹ç‚¹æ•°æ®
                const trackData = {
                    event_name: eventName,
                    user_id: 'anonymous',
                    timestamp: new Date().toISOString(),
                    page_url: window.location.href,
                    user_agent: navigator.userAgent,
                    ...eventData
                };
                
                // å‘é€åˆ°åç«¯åŸ‹ç‚¹æ¥å£ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                if (typeof axios !== 'undefined') {
                    axios.post('/api/tracking/event', trackData).catch(err => {
                        console.log('åŸ‹ç‚¹å‘é€å¤±è´¥:', err);
                    });
                }
                
                // æ§åˆ¶å°è¾“å‡ºï¼ˆå¼€å‘ç¯å¢ƒï¼‰
                console.log('ğŸ“Š åŸ‹ç‚¹äº‹ä»¶:', eventName, trackData);
                
            } catch (error) {
                console.error('åŸ‹ç‚¹å‘é€å¤±è´¥:', error);
            }
        };
        
        // é¡µé¢åŠ è½½åŸ‹ç‚¹
        document.addEventListener('DOMContentLoaded', function() {
            trackEvent('page_view', {
                page_title: document.title,
                page_type: 'register'
            });
        });
        </script>
</head>
<body>
    <!--turn to login-->
    <div class="header-container">
        <div class="header-next">
            <a href="/index" class="header">
                <img loading="lazy" class="logo" src="//images/logo.png">
                <img loading="lazy" class="title" src="//images/title.png">
            </a>
        </div>
        <div class="login">
            <text class="first">å·²æœ‰è´¦å·ï¼Ÿ</text>
            <a href='/login' class="second">ç™»å½•</a>
        </div>
    </div>
     
    <!--æ³¨å†Œéƒ¨åˆ†-->
    <div class="square">
        
        <form class="row g-3 needs-validation" novalidate>
            <div class="mb-3">
              <label for="name" class="form-label" >ç”¨æˆ·å</label>
              <input type="text" class="form-control" id="name" placeholder="è¯·è¾“å…¥2-30å­—ç¬¦çš„ç”¨æˆ·å" required>
              
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">æ‰‹æœºå·</label>
                <input type="tel" class="form-control" id="phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">å¯†ç </label>
                <input type="password" class="form-control" id="password" placeholder="è¯·è¾“å…¥8-20å­—ç¬¦çš„å¯†ç " required>
            </div>
            <div class="mb-3">
                <label for="checkPassword" class="form-label">ç¡®è®¤å¯†ç </label>
                <input type="password" class="form-control" id="checkPassword" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
            </div>
            <button type="submit" class="btn btn-primary" >æ³¨å†Œ</button>
          </form>
    </div>

   
    
    
    </div>
    <div class="alert alert-success" role="alert" style="display:none">
        æ³¨å†ŒæˆåŠŸ
      </div>
      <div class="alert alert-danger" role="alert" style="display:none">
        æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡æ–°æ³¨å†Œ
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
            //æ£€æŸ¥ç”¨æˆ·å
            const checkUser = document.getElementById('name');
            const checkPhone = document.getElementById('phone');
            const checkPass = document.getElementById('password');
            const checkPass2 = document.getElementById('checkPassword');
            const reg1 = /^1[3-9]\d{9}$/;
            const reg2 = /^[a-zA-Z0-9-_~!@#$%^&*]{8,20}$/;

            // ç”¨æˆ·åéªŒè¯
            if (checkUser) {
                checkUser.addEventListener('blur', () => {
                    if (checkUser.value.trim().length < 2 || checkUser.value.trim().length > 30) {
                        checkUser.classList.add('is-invalid');
                        checkUser.classList.remove('is-valid');
                    } else {
                        checkUser.classList.add('is-valid');
                        checkUser.classList.remove('is-invalid');
                    }
                });
            }

            // æ‰‹æœºå·éªŒè¯
            if (checkPhone) {
                checkPhone.addEventListener('blur', () => {
                    if (!reg1.test(checkPhone.value)) {
                        checkPhone.classList.add('is-invalid');
                        checkPhone.classList.remove('is-valid');
                    } else {
                        checkPhone.classList.add('is-valid');
                        checkPhone.classList.remove('is-invalid');
                    }
                });
            }

            // å¯†ç éªŒè¯
            if (checkPass) {
                checkPass.addEventListener('blur', () => {
                    if (!reg2.test(checkPass.value)) {
                        checkPass.classList.add('is-invalid');
                        checkPass.classList.remove('is-valid');
                    } else {
                        checkPass.classList.add('is-valid');
                        checkPass.classList.remove('is-invalid');
                    }
                });
            }

            // ç¡®è®¤å¯†ç éªŒè¯
            if (checkPass2) {
                checkPass2.addEventListener('blur', () => {
                    if ((checkPass2.value !== checkPass.value) || (!reg2.test(checkPass.value))) {
                        checkPass2.classList.add('is-invalid');
                        checkPass2.classList.remove('is-valid');
                    } else {
                        checkPass2.classList.add('is-valid');
                        checkPass2.classList.remove('is-invalid');
                    }
                });
            }

            // è¡¨å•æäº¤å¤„ç†
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // é‡ç½®é”™è¯¯æç¤º
                    const alertDanger = document.querySelector('.alert-danger');
                    alertDanger.style.display = 'none';
                    
                    // éªŒè¯ç”¨æˆ·å
                    if (checkUser.value.trim().length < 2 || checkUser.value.trim().length > 30) {
                        alertDanger.textContent = 'ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨2-30ä¸ªå­—ç¬¦ä¹‹é—´';
                        alertDanger.style.display = 'block';
                        setTimeout(() => {
                            alertDanger.style.display = 'none';
                        }, 5000); 
                        return;
                    }
                    
                    // éªŒè¯æ‰‹æœºå·
                    if (!reg1.test(checkPhone.value)) {
                        alertDanger.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·';
                        alertDanger.style.display = 'block';
                        setTimeout(() => {
                            alertDanger.style.display = 'none';
                        }, 5000); 
                        return;
                    }
                    
                    // éªŒè¯å¯†ç 
                    if (!reg2.test(checkPass.value)) {
                        alertDanger.textContent = 'å¯†ç å¿…é¡»æ˜¯8-20ä½å­—ç¬¦';
                        alertDanger.style.display = 'block';
                        setTimeout(() => {
                            alertDanger.style.display = 'none';
                        }, 5000); 
                        return;
                    }
                    
                    // éªŒè¯ç¡®è®¤å¯†ç 
                    if (checkPass.value !== checkPass2.value) {
                        alertDanger.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                        alertDanger.style.display = 'block';
                        setTimeout(() => {
                            alertDanger.style.display = 'none';
                        }, 5000); 
                        return;
                    }

                    // æäº¤æ•°æ®
                    const newUser = {
                        name: checkUser.value.trim(),
                        phone: checkPhone.value.trim(),
                        password: checkPass.value.trim()
                    };

                    axios.post('/api/user/register', newUser)
                        .then(res => {
                            console.log('æ³¨å†ŒæˆåŠŸ:', res.data);
                             // æ·»åŠ åŸ‹ç‚¹
                             trackEvent('user_register', {
                                username: newUser.name,
                                phone: newUser.phone.substring(0, 3) + '****' + newUser.phone.substring(7), // è„±æ•å¤„ç†
                                register_success: true
                            });
                            
                            const alertSuccess = document.querySelector('.alert-success');
                            alertSuccess.style.display = 'block';
                            
                            setTimeout(() => {
                                window.location.href = '/login';
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('æ³¨å†Œå¤±è´¥:', err.response?.data || err.message);
                            console.log('å®Œæ•´é”™è¯¯å¯¹è±¡:', err);
                            console.log('é”™è¯¯å“åº”:', err.response);
                            console.log('é”™è¯¯æ•°æ®:', err.response?.data);
                            console.log('é”™è¯¯çŠ¶æ€:', err.response?.status);
                            
                            // æ ¹æ®åç«¯è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºä¸åŒçš„æç¤º
                            let errorMessage = 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡æ–°æ³¨å†Œ';
                            
                            // æ£€æŸ¥é”™è¯¯å¯¹è±¡æœ¬èº«æ˜¯å¦åŒ…å«é”™è¯¯ä¿¡æ¯
                            if (typeof err === 'string') {
                                errorMessage = err;
                            } else if (err.response?.data) {
                                console.log('åç«¯è¿”å›çš„é”™è¯¯ä¿¡æ¯:', err.response.data);
                                if (err.response.data === 'è¯¥æ˜µç§°å·²è¢«å ç”¨') {
                                    errorMessage = 'è¯¥æ˜µç§°å·²è¢«å ç”¨';
                                } else if (err.response.data === 'è¯¥æ‰‹æœºå·å·²è¢«å ç”¨') {
                                    errorMessage = 'è¯¥æ‰‹æœºå·å·²è¢«å ç”¨';
                                } else {
                                    errorMessage = err.response.data;
                                }
                            } else if (err.message) {
                                // å¦‚æœé”™è¯¯å¯¹è±¡æœ¬èº«åŒ…å«æ¶ˆæ¯
                                if (err.message === 'è¯¥æ˜µç§°å·²è¢«å ç”¨') {
                                    errorMessage = 'è¯¥æ˜µç§°å·²è¢«å ç”¨';
                                } else if (err.message === 'è¯¥æ‰‹æœºå·å·²è¢«å ç”¨') {
                                    errorMessage = 'è¯¥æ‰‹æœºå·å·²è¢«å ç”¨';
                                } else {
                                    errorMessage = err.message;
                                }
                            }
                            
                            console.log('æœ€ç»ˆæ˜¾ç¤ºçš„é”™è¯¯ä¿¡æ¯:', errorMessage);
                            alertDanger.textContent = errorMessage;
                            alertDanger.style.display = 'block';
                            setTimeout(() => {
                                alertDanger.style.display = 'none';
                            }, 5000);
                        });
                });
            });
        });
    </script>
</body>
</html>