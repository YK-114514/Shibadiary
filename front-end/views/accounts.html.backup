<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4KNWJP3BH3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4KNWJP3BH3');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../css/accounts.css?v=1.0.5">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../http.js"></script>
    
</head>
<body>
   
    <div class="header">
        <div class="header-next">
            <a class="index" href="/index">
                <img loading="lazy" class="logo" src="/images/logo.png">
                <img loading="lazy" class="title" src="/images/title.png">
            </a>
        </div>
    </div>
    
        <div class="middle">
            <img loading="lazy" class="profile" src=""></img>
            <div class="info-block">
            <p class="name">æµ‹è¯•</p>
            <p class="stats">å…³æ³¨: -- | ç²‰ä¸: --</p>
            <button class="follow-btn" data-id="è¢«å…³æ³¨ç”¨æˆ·çš„id">å…³æ³¨</button>
        </div>
        </div>
        
        <div class="content-container">
        
        <ul class="content">
           
        </ul>
        </div>
    

    
</body>
</html>

<script>
    // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œå¦‚æœæœªç™»å½•åˆ™è·³è½¬åˆ°ç™»å½•é¡µé¢
    (function checkLoginStatus() {
        const token = localStorage.getItem('eleToken');
        const userData = localStorage.getItem('user_data');
        
        if (!token || !userData) {
            console.log('æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
            window.location.href = '/login';
            return;
        }
        
        try {
            JSON.parse(userData);
        } catch (e) {
            console.log('ç”¨æˆ·æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
            window.location.href = '/login';
            return;
        }
    })();

const avatarGet = document.querySelector('.profile')
const nameGet = document.querySelector('.name')
const params = new URLSearchParams(window.location.search)
const userId = params.get('id')



console.log(userId)



    

    //è·å–å‘çš„å¸–å­
    const content = document.querySelector('.content')

    let allData = []

    async function getAllData(){
        try{
            console.log('æ­£åœ¨è¯·æ±‚ç”¨æˆ·æ•°æ®ï¼Œç”¨æˆ·ID:', userId);
            const res = await axios.get(`/api/accounts/${userId}/accounts`)
            console.log('API Response:', res.data)

            // ç›´æ¥ä½¿ç”¨è¿”å›çš„æ•°ç»„æ•°æ®
            allData = res.data

            // è®¾ç½®å¤´åƒå’Œåå­—
            if (allData.posts && allData.posts.length > 0) {
                nameGet.innerHTML = allData.posts[0].name
                avatarGet.src = allData.posts[0].avatar
            } else {
                // å¦‚æœç”¨æˆ·æ²¡æœ‰å¸–å­ï¼Œéœ€è¦å•ç‹¬è·å–ç”¨æˆ·ä¿¡æ¯
                try {
                    const userInfoRes = await axios.get(`/api/user/${userId}`);
                    if (userInfoRes.data && userInfoRes.data.name) {
                        nameGet.innerHTML = userInfoRes.data.name;
                        avatarGet.src = userInfoRes.data.avatar || '/front-end/images/default_avatar.jpg';
                    } else {
                        nameGet.innerHTML = 'æœªçŸ¥ç”¨æˆ·';
                        avatarGet.src = '/front-end/images/default_avatar.jpg';
                    }
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    nameGet.innerHTML = 'æœªçŸ¥ç”¨æˆ·';
                    avatarGet.src = '/front-end/images/default_avatar.jpg';
                }
            }

            // è®¾ç½®å…³æ³¨æ•°å’Œç²‰ä¸æ•°
            const statsGet = document.querySelector('.stats')
            statsGet.innerHTML = `å…³æ³¨: ${res.data.following} | ç²‰ä¸: ${res.data.followers}`

            // åˆ¤æ–­æ˜¯å¦å·²å…³æ³¨ - ä»æ•°æ®åº“è·å–æœ€æ–°çŠ¶æ€
            const userD = localStorage.getItem('user_data');
            const user_data = JSON.parse(userD);
            
            // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²å…³æ³¨ç›®æ ‡ç”¨æˆ·
            try {
                const checkFollowRes = await axios.get(`/api/accounts/check-follow?follower_id=${user_data.id_user}&following_id=${userId}`);
                const isFollowing = checkFollowRes.data.isFollowing;
                
                const followBtn = document.querySelector('.follow-btn');
                if (isFollowing) {
                    followBtn.innerText = 'å·²å…³æ³¨';
                    followBtn.classList.add('active');
                } else {
                    followBtn.innerText = 'å…³æ³¨';
                    followBtn.classList.remove('active');
                }
            } catch (error) {
                console.error('æ£€æŸ¥å…³æ³¨çŠ¶æ€å¤±è´¥:', error);
                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨localStorageä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                const followingStr = user_data.following || '';
                const followingArr = followingStr ? followingStr.split(',') : [];
                const isFollowing = followingArr.includes(userId);
                
                const followBtn = document.querySelector('.follow-btn');
                if (isFollowing) {
                    followBtn.innerText = 'å·²å…³æ³¨';
                    followBtn.classList.add('active');
                } else {
                    followBtn.innerText = 'å…³æ³¨';
                    followBtn.classList.remove('active');
                }
            }

            return allData;   
        }catch(error){
            console.error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            console.error('é”™è¯¯è¯¦æƒ…:', error.response?.data);
            console.error('é”™è¯¯çŠ¶æ€:', error.response?.status);
            return[]
        }
    }
    getAllData().then((allTable)=>{
        console.log(allTable)

    })

    async function getAccounts() {
        console.log('å¼€å§‹è·å–accountsæ•°æ®');
        const allData = await getAllData();
        const post_Datas = allData.posts || []; // åªå–postsæ•°ç»„

        console.log('è·å–åˆ°çš„å¸–å­æ•°æ®:', post_Datas);

        if (post_Datas.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 50px 20px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
                    <div style="font-size: 18px; margin-bottom: 10px;">è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•å†…å®¹</div>
                    <div style="font-size: 14px;">è¿™ä¸ªç”¨æˆ·è¿˜æ²¡æœ‰å‘å¸ƒè¿‡å¸–å­å“¦</div>
                </div>
            `
            return
        }

        content.innerHTML = '' // æ¸…ç©ºç°æœ‰å†…å®¹

        post_Datas.forEach(async (post) => {
            console.log('æ­£åœ¨æ¸²æŸ“å¸–å­:', post);
            const formatted = new Date(post.time).toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            })

            // è·å–ç”¨æˆ·çš„å…³æ³¨æ•°å’Œç²‰ä¸æ•°
            let userFollowing = 0;
            let userFollowers = 0;
            try {
                const userRes = await axios.get(`/api/accounts/${post.id_user}/accounts`);
                userFollowing = userRes.data.following || 0;
                userFollowers = userRes.data.followers || 0;
            } catch (error) {
                console.error('è·å–ç”¨æˆ·å…³æ³¨æ•°æ®å¤±è´¥:', error);
            }

            // å¤„ç†å›¾ç‰‡æ˜¾ç¤º - å’Œpersonalé¡µé¢ä¿æŒä¸€è‡´
            let imagesArr = [];
            try {
                imagesArr = post.images ? JSON.parse(post.images) : [];
            } catch(error) {
                imagesArr = [];
            }
            let picturesHtml = '';
            if (imagesArr.length > 0) {
                picturesHtml = `<div class="pictures">` +
                    imagesArr.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('') +
                    `</div>`;
            }

            console.log('æ¸²æŸ“å¸–å­HTML:', picturesHtml);
            const li = document.createElement('li')
            li.innerHTML = `
                <div class="mulu-top" style="position:relative;">
                    <div class="mulu" style="cursor: pointer;" onclick="window.location.href='/post-detail/${post.id}'">
                        <image class="avatar" src=${post.avatar}></image>
                        <div class="list">
                            <div class="divide_row">
                                <a href="javascript:;" class="uname" data-userid="${post.id_user}" onclick="event.stopPropagation()">${post.name}</a>
                                <div class="information">
                                    <div class="divide">
                                        <image class="touxiang" src=${post.avatar}></image>
                                        <p class="name">${post.name}</p>
                                    </div>
                                    <div class="people">
                                        <p>å…³æ³¨: ${userFollowing}</p>
                                        <p>ç²‰ä¸: ${userFollowers}</p>
                                    </div>
                                </div>
                            </div>
                            <p class="sentences">${post.content}</p>
                            ${picturesHtml}
                            <div class="last">
                                <p class="time">${formatted}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `
            console.log('æ·»åŠ åˆ°DOM:', li);
            content.prepend(li)
        })
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–accountsé¡µé¢');
        getAccounts();
        
        // æ·»åŠ ç”¨æˆ·åæ‚¬åœäº‹ä»¶å¤„ç†
        document.addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('uname')) {
                const information = e.target.nextElementSibling;
                if (information && information.classList.contains('information')) {
                    information.classList.add('active');
                }
            }
        });

        document.addEventListener('mouseout', function(e) {
            if (e.target.classList.contains('uname')) {
                const information = e.target.nextElementSibling;
                if (information && information.classList.contains('information')) {
                    information.classList.remove('active');
                }
            }
        });



        // å¤„ç†ç‚¹èµã€æ”¶è—ã€è¯„è®ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.addEventListener('click', async function(e) {
            const target = e.target;
            const postId = parseInt(target.dataset.id, 10);

            // ç‚¹èµæŒ‰é’®
            if (target.classList.contains('like') || target.closest('.like')) {
                e.stopPropagation();
                if (!localStorage.getItem('eleToken')) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }

                const userData = JSON.parse(localStorage.getItem('user_data'));
                if (!userData || !userData.id_user) {
                    console.error('ç”¨æˆ·æ•°æ®ä¸å®Œæ•´');
                    alert('ç”¨æˆ·æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ç™»å½•');
                    return;
                }

                try {
                    const res = await axios.post('/api/posts/addLike', {
                        userid_like: userData.id_user,
                        id_from_post: postId
                    });

                    if (res.data.success) {
                        const likeBtn = target.classList.contains('like') ? target : target.closest('.like');
                        const likeCount = likeBtn.querySelector('.like-count');
                        likeBtn.classList.toggle('active');
                        const currentCount = parseInt(likeCount.textContent);
                        likeCount.textContent = likeBtn.classList.contains('active') ? currentCount + 1 : currentCount - 1;
                    } else {
                        alert(res.data.message);
                    }
                } catch (error) {
                    console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                return;
            }

            // æ”¶è—æŒ‰é’®
            if (target.classList.contains('collect') || target.closest('.collect')) {
                e.stopPropagation();
                if (!localStorage.getItem('eleToken')) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }

                const userData = JSON.parse(localStorage.getItem('user_data'));
                if (!userData || !userData.id_user) {
                    console.error('ç”¨æˆ·æ•°æ®ä¸å®Œæ•´');
                    alert('ç”¨æˆ·æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ç™»å½•');
                    return;
                }

                try {
                    const res = await axios.post('/api/posts/addCollect', {
                        userid_collect: userData.id_user,
                        id_from_post: postId
                    });

                    if (res.data.success) {
                        const collectBtn = target.classList.contains('collect') ? target : target.closest('.collect');
                        collectBtn.classList.toggle('active');
                    } else {
                        alert(res.data.message);
                    }
                } catch (error) {
                    console.error('æ”¶è—æ“ä½œå¤±è´¥:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                return;
            }

            // è¯„è®ºæŒ‰é’®
            if (target.classList.contains('say') || target.closest('.say')) {
                e.stopPropagation();
                const muluTop = target.closest('.mulu-top');
                if (muluTop) {
                    const cmt = muluTop.querySelector(`.comments[data-id="${postId}"]`);
                    if (cmt) {
                        cmt.classList.toggle('hidden');
                        
                        // å¦‚æœè¯„è®ºåŒºåŸŸæ˜¾ç¤ºï¼Œåˆ™åŠ è½½è¯„è®º
                        if (!cmt.classList.contains('hidden')) {
                            try {
                                const res = await axios.get(`/api/posts/${postId}/comments`);
                                const comments = res.data;
                                const otherComments = cmt.querySelector('.otherComments');
                                
                                if (comments.length === 0) {
                                    otherComments.innerHTML = '<div class="empty-comment">æŠ¢ä¸ªæ²™å‘å§</div>';
                                } else {
                                    otherComments.innerHTML = comments.map(comment => `
                                        <div class="xijie" data-idcomments="${comment.idcomments}" data-userid="${comment.id_user}">
                                            <image class="avatar1" src=${comment.avatar}></image>
                                            <div class="exceptA">
                                                <div class='author-container'>
                                                    <a href="javascript:;" class="name" data-userid="${comment.id_user}">${comment.name}</a>
                                                </div>
                                                <div class="information"></div>
                                                <p class="words">${comment.content}</p>
                                                <div class="timesLike">
                                                    <p class="ctime">${comment.time}</p>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('');
                                }
                            } catch (error) {
                                console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                            }
                        }
                    }
                }
                return;
            }

            // ç”¨æˆ·é¡µé¢è·³è½¬
            if (target.classList.contains('uname')) {
                const userId = target.dataset.userid;
                // åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰ç™»å½•ç”¨æˆ·
                if (userData && userId == userData.id_user) {
                    window.location.href = '/personal';
                } else {
                    window.location.href = `/accounts?id=${userId}`;
                }
                return;
            }

            // å¦‚æœç‚¹å‡»çš„æ˜¯å¸–å­å®¹å™¨ï¼Œè·³è½¬åˆ°è¯¦æƒ…é¡µï¼ˆæ’é™¤è¯„è®ºåŒºï¼‰
            const muluTop = target.closest('.mulu-top');
            if (muluTop) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»çš„æ˜¯è¯„è®ºåŒºç›¸å…³å…ƒç´ 
                const isCommentArea = target.closest('.comments') || 
                                    target.closest('.inputComment') || 
                                    target.closest('.otherComments') ||
                                    target.closest('.xijie') ||
                                    target.closest('.reply-container') ||
                                    target.closest('.submitComment') ||
                                    target.closest('textarea') ||
                                    target.closest('.delete-comment-btn') ||
                                    target.closest('.reply-btn') ||
                                    target.closest('.name') ||
                                    target.closest('.author-container');
                
                if (!isCommentArea) {
                    const postId = muluTop.querySelector('.like').dataset.id;
                    window.location.href = `/post-detail/${postId}`;
                }
            }
        });
    });

    const followBtn = document.querySelector('.follow-btn');
    const userD = localStorage.getItem('user_data');
    const user_data = JSON.parse(userD);
    const follower_id = user_data.id_user; // å½“å‰ç™»å½•ç”¨æˆ·id
    const following_id = userId;           // è¢«å…³æ³¨ç”¨æˆ·idï¼ˆå°±æ˜¯urlå‚æ•°ï¼‰

    followBtn.addEventListener('click', async () => {
        if (followBtn.classList.contains('active')) {
            // å·²å…³æ³¨ï¼Œç‚¹å‡»åå¼¹å‡ºç¡®è®¤å¼¹çª—
            if (confirm('ç¡®å®šè¦å–å…³è¯¥ç”¨æˆ·ï¼Ÿ')) {
                try {
                    const res = await axios.post('/api/accounts/unfollow', {
                        follower_id,
                        following_id
                    });
                    if (res.data.success) {
                        alert('å·²å–æ¶ˆå…³æ³¨');
                        followBtn.innerText = 'å…³æ³¨';
                        followBtn.classList.remove('active');
                        // æ›´æ–°localStorage
                        let followingArr = user_data.following ? user_data.following.split(',') : [];
                        followingArr = followingArr.filter(id => id !== following_id);
                        user_data.following = followingArr.join(',');
                        localStorage.setItem('user_data', JSON.stringify(user_data));
                    } else {
                        alert(res.data.message || 'å–æ¶ˆå…³æ³¨å¤±è´¥');
                    }
                } catch (err) {
                    alert('å–æ¶ˆå…³æ³¨å¤±è´¥');
                    console.error(err);
                }
            }
        } else {
            // æœªå…³æ³¨ï¼Œç‚¹å‡»åå…³æ³¨
            try {
                const res = await axios.post('/api/accounts/follow', {
                    follower_id,
                    following_id
                });
                if (res.data.success) {
                    alert('å…³æ³¨æˆåŠŸï¼');
                    followBtn.innerText = 'å·²å…³æ³¨';
                    followBtn.classList.add('active');
                    // æ›´æ–°localStorage
                    let followingArr = user_data.following ? user_data.following.split(',') : [];
                    if (!followingArr.includes(following_id)) {
                        followingArr.push(following_id);
                        user_data.following = followingArr.join(',');
                        localStorage.setItem('user_data', JSON.stringify(user_data));
                    }
                } else {
                    alert(res.data.message || 'å…³æ³¨å¤±è´¥');
                }
            } catch (err) {
                alert('å…³æ³¨å¤±è´¥');
                console.error(err);
            }
        }
    });



</script>