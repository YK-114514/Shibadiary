<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../css/login.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.js"></script>
    <script src="../http.js"></script>
</head>
<body>
 <!--turn to sign up-->
 <div class="background">
 <div class="top">
   
 <div class="signup">
    <text class="first">还没有账号？</text>
    <a href='/register' class="second">注册</a>

</div>
<a href="/index" class="header">
    <img class="logo" src="../images/logo.png" alt="logo">
    <img class="title" src="../images/title.png" alt="title">
</a>
 </div>
 <div class="content">
    <div class="cute_image">
        <img class="logo_2" src="../images/logo_2.png" alt="logo_2">
    </div>
    <div class="square">
        
        <form class="row g-3 needs-validation" novalidate>
            <h3 class="welcome">登录</h3>
            <div class="mb-3">
                <label for="phone" class="form-label">手机号</label>
                <input type="tel" class="form-control" id="phone" placeholder="请输入手机号" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">密码</label>
                <input type="password" class="form-control" id="password" placeholder="请输入密码" required>
            </div>
            
            <button type="submit" class="btn btn-primary" >登录</button>
          </form>
    </div>
 </div>

</div>
<div class="alert alert-success" role="alert" style="display:none">
    登录成功
</div>
<div class="alert alert-danger" role="alert" style="display:none">
    登录失败
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const danger = document.querySelector('.alert-danger');
        const forms = document.querySelectorAll('.needs-validation');

        Array.from(forms).forEach(form => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                event.stopPropagation();

                const checkPhone = document.getElementById('phone');
                const checkPass = document.getElementById('password');

                // 手机号不能为空
                if (checkPhone.value.trim() === '') {
                    danger.textContent = '手机号不能为空';
                    danger.style.display = 'block';
                    setTimeout(() => {
                        danger.style.display = 'none';
                    }, 5000);
                    return;
                }

                if (checkPass.value.trim() === '') {
                    danger.textContent = '密码不能为空';
                    danger.style.display = 'block';
                    setTimeout(() => {
                        danger.style.display = 'none';
                    }, 5000);
                    return;
                }

                try {
                    // 传给后端
                    const res = await axios.post('/api/user/login', {
                        phone: checkPhone.value.trim(),
                        password: checkPass.value.trim()
                    });
                    
                    console.log('登录成功:', res.data);
                    const alertSuccess = document.querySelector('.alert-success');
                    alertSuccess.style.display = 'block';
                    
                    // 存储token到localStorage
                    const { token } = res.data;
                    localStorage.setItem('eleToken', token);

                    //用户全部信息存储到session里面
                    const decode = jwt_decode(token);
                    sessionStorage.setItem('user_data', JSON.stringify(decode));

                    setTimeout(() => {
                        window.location.href = '/index';
                    }, 1000);
                } catch (error) {
                    console.error('登录失败:', error.response?.data || error.message);
                    danger.textContent = error.response?.data || '登录失败';
                    danger.style.display = 'block';
                }
            });
        });
    });
</script>
</body>
</html>