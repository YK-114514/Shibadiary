<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4KNWJP3BH3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4KNWJP3BH3');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../css/login.min.css?v=1.0.1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@4.0.0/build/jwt-decode.js"></script>
    <script src="../http.js"></script>
    <style>
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            min-width: 300px;
            text-align: center;
        }
    </style>
      <!-- åŸ‹ç‚¹å·¥å…·å‡½æ•° -->
      <script>
        // åŸ‹ç‚¹å·¥å…·å‡½æ•°
        window.trackEvent = function(eventName, eventData = {}) {
            try {
                // æ„å»ºåŸ‹ç‚¹æ•°æ®
                const trackData = {
                    event_name: eventName,
                    user_id: 'anonymous',
                    timestamp: new Date().toISOString(),
                    page_url: window.location.href,
                    user_agent: navigator.userAgent,
                    ...eventData
                };
                
                // å‘é€åˆ°åç«¯åŸ‹ç‚¹æ¥å£ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                if (typeof axios !== 'undefined') {
                    axios.post('/api/tracking/event', trackData).catch(err => {
                        console.log('åŸ‹ç‚¹å‘é€å¤±è´¥:', err);
                    });
                }
                
                // æ§åˆ¶å°è¾“å‡ºï¼ˆå¼€å‘ç¯å¢ƒï¼‰
                console.log('ğŸ“Š åŸ‹ç‚¹äº‹ä»¶:', eventName, trackData);
                
            } catch (error) {
                console.error('åŸ‹ç‚¹å‘é€å¤±è´¥:', error);
            }
        };
        
        // é¡µé¢åŠ è½½åŸ‹ç‚¹
        document.addEventListener('DOMContentLoaded', function() {
            trackEvent('page_view', {
                page_title: document.title,
                page_type: 'login'
            });
        });
        </script>
</head>
<body>
 <!--turn to sign up-->
 <div class="background">
 <div class="top">
    <div class="header-next">
        <a href="/index" class="header">
            <img loading="lazy" class="logo" src="//images/logo.png" alt="logo">
            <img loading="lazy" class="title" src="//images/title.png" alt="title">
        </a>
    </div>
    <div class="signup">
        <text class="first">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</text>
        <a href='/register' class="second">æ³¨å†Œ</a>
    </div>
 </div>
 <div class="content">
    <div class="cute_image">
        <img loading="lazy" class="logo_2" src="//images/logo_2.png" alt="logo_2">
    </div>
    <div class="square">
        
        <form class="row g-3 needs-validation" novalidate>
            <h3 class="welcome">ç™»å½•</h3>
            <div class="mb-3">
                <label for="phone" class="form-label">æ‰‹æœºå·</label>
                <input type="tel" class="form-control" id="phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">å¯†ç </label>
                <input type="password" class="form-control" id="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
            </div>
            
            <button type="submit" class="btn btn-primary" >ç™»å½•</button>
          </form>
    </div>
 </div>

</div>
<div class="alert alert-success" role="alert" style="display:none">
    ç™»å½•æˆåŠŸ
</div>
<div class="alert alert-danger" role="alert" style="display:none">
    ç™»å½•å¤±è´¥
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const danger = document.querySelector('.alert-danger');
        const forms = document.querySelectorAll('.needs-validation');

        Array.from(forms).forEach(form => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                event.stopPropagation();

                const checkPhone = document.getElementById('phone');
                const checkPass = document.getElementById('password');

                // æ‰‹æœºå·ä¸èƒ½ä¸ºç©º
                if (checkPhone.value.trim() === '') {
                    danger.textContent = 'æ‰‹æœºå·ä¸èƒ½ä¸ºç©º';
                    danger.style.display = 'block';
                    setTimeout(() => {
                        danger.classList.add('show');
                    }, 10);
                    setTimeout(() => {
                        danger.classList.remove('show');
                        setTimeout(() => {
                            danger.style.display = 'none';
                        }, 300);
                    }, 3000);
                    return;
                }

                if (checkPass.value.trim() === '') {
                    danger.textContent = 'å¯†ç ä¸èƒ½ä¸ºç©º';
                    danger.style.display = 'block';
                    setTimeout(() => {
                        danger.classList.add('show');
                    }, 10);
                    setTimeout(() => {
                        danger.classList.remove('show');
                        setTimeout(() => {
                            danger.style.display = 'none';
                        }, 300);
                    }, 3000);
                    return;
                }

                try {
                    // ä¼ ç»™åç«¯
                    const res = await axios.post('/api/user/login', {
                        phone: checkPhone.value.trim(),
                        password: checkPass.value.trim()
                    });
                    
                    console.log('ç™»å½•æˆåŠŸ:', res.data);
                       
                    // æ·»åŠ åŸ‹ç‚¹
                    trackEvent('user_login', {
                        login_method: 'phone_password',
                        phone: checkPhone.value.trim().substring(0, 3) + '****' + checkPhone.value.trim().substring(7), // è„±æ•å¤„ç†
                        login_success: true
                    });
                    const alertSuccess = document.querySelector('.alert-success');
                    alertSuccess.style.display = 'block';
                    setTimeout(() => {
                        alertSuccess.classList.add('show');
                    }, 10);
                    
                    // å­˜å‚¨tokenåˆ°localStorage
                    const { token } = res.data;
                    localStorage.setItem('eleToken', token);

                    //ç”¨æˆ·å…¨éƒ¨ä¿¡æ¯å­˜å‚¨åˆ°localStorageé‡Œé¢
                   /* const decode = jwtDecode(token);
                    localStorage.setItem('user_data', JSON.stringify(decode));
                        */
                        try {
                            const payload = JSON.parse(atob(token.split('.')[1]));
                        localStorage.setItem('user_data', JSON.stringify(payload));
                    } catch (error) {
                        console.error('JWTè§£ç å¤±è´¥:', error);
                        // å³ä½¿è§£ç å¤±è´¥ï¼Œä¹Ÿç»§ç»­ç™»å½•æµç¨‹
                        localStorage.setItem('user_data', JSON.stringify({}));
                    }
                    // è°ƒç”¨ç™»å½•æˆåŠŸå‡½æ•°
                    if (window.loginSuccess) {
                        window.loginSuccess();
                    }

                    setTimeout(() => {
                        alertSuccess.classList.remove('show');
                        setTimeout(() => {
                            window.location.href = '/index';
                        }, 300);
                    }, 3000);
                } catch (error) {
                    console.error('ç™»å½•å¤±è´¥:', error.response?.data || error.message);
                    danger.textContent = error.response?.data || 'ç™»å½•å¤±è´¥';
                    danger.style.display = 'block';
                    setTimeout(() => {
                        danger.classList.add('show');
                    }, 10);
                    setTimeout(() => {
                        danger.classList.remove('show');
                        setTimeout(() => {
                            danger.style.display = 'none';
                        }, 300);
                    }, 3000);
                }
            });
        });
    });
</script>
</body>
</html>