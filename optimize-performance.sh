#!/bin/bash

echo "ðŸš€ å¼€å§‹æ‰§è¡Œå°æŸ´æ—¥è®°é¡¹ç›®æ€§èƒ½ä¼˜åŒ–..."

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ£€æŸ¥Node.jsæ˜¯å¦å®‰è£…
if ! command -v node &> /dev/null; then
    echo -e "${RED}âŒ Node.jsæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Node.js${NC}"
    exit 1
fi

# æ£€æŸ¥npmæ˜¯å¦å®‰è£…
if ! command -v npm &> /dev/null; then
    echo -e "${RED}âŒ npmæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…npm${NC}"
    exit 1
fi

echo -e "${BLUE}ðŸ“¦ å®‰è£…æ€§èƒ½ä¼˜åŒ–ä¾èµ–åŒ…...${NC}"

# å®‰è£…å¿…è¦çš„ä¾èµ–åŒ…
npm install --save-dev sharp clean-css uglify-js imagemin imagemin-webp imagemin-mozjpeg imagemin-pngquant

echo -e "${GREEN}âœ… ä¾èµ–åŒ…å®‰è£…å®Œæˆ${NC}"

echo -e "${BLUE}ðŸ–¼ï¸  å¼€å§‹å›¾ç‰‡ä¼˜åŒ–...${NC}"

# è¿è¡Œå›¾ç‰‡ä¼˜åŒ–è„šæœ¬
node optimize_images_enhanced.js

echo -e "${GREEN}âœ… å›¾ç‰‡ä¼˜åŒ–å®Œæˆ${NC}"

echo -e "${BLUE}ðŸ“ å¼€å§‹CSSå’ŒJSåŽ‹ç¼©...${NC}"

# è¿è¡Œé™æ€èµ„æºåŽ‹ç¼©
node optimize_static_files.js

echo -e "${GREEN}âœ… é™æ€èµ„æºåŽ‹ç¼©å®Œæˆ${NC}"

echo -e "${BLUE}ðŸ—„ï¸  ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢...${NC}"

# è¿è¡Œæ•°æ®åº“ä¼˜åŒ–
node optimize_database.js

echo -e "${GREEN}âœ… æ•°æ®åº“ä¼˜åŒ–å®Œæˆ${NC}"

echo -e "${BLUE}ðŸŒ ä¼˜åŒ–Nginxé…ç½®...${NC}"

# å¤‡ä»½åŽŸé…ç½®
if [ -f "nginx.conf" ]; then
    cp nginx.conf nginx.conf.backup
    echo -e "${YELLOW}ðŸ“‹ åŽŸNginxé…ç½®å·²å¤‡ä»½ä¸ºnginx.conf.backup${NC}"
fi

# ä½¿ç”¨ä¼˜åŒ–åŽçš„é…ç½®
if [ -f "nginx-optimized.conf" ]; then
    cp nginx-optimized.conf nginx.conf
    echo -e "${GREEN}âœ… Nginxé…ç½®å·²ä¼˜åŒ–${NC}"
else
    echo -e "${YELLOW}âš ï¸  nginx-optimized.confæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡Nginxé…ç½®ä¼˜åŒ–${NC}"
fi

echo -e "${BLUE}ðŸ”§ é…ç½®ç¼“å­˜ç­–ç•¥...${NC}"

# è¿è¡Œç¼“å­˜é…ç½®è„šæœ¬
node cache-config.js

echo -e "${GREEN}âœ… ç¼“å­˜ç­–ç•¥é…ç½®å®Œæˆ${NC}"

echo -e "${BLUE}ðŸ“Š ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š...${NC}"

# åˆ›å»ºæ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š
cat > PERFORMANCE_OPTIMIZATION_REPORT.md << EOF
# å°æŸ´æ—¥è®°é¡¹ç›®æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š

## ðŸŽ¯ ä¼˜åŒ–ç›®æ ‡
- æ”¹å–„é¦–å±åŠ è½½é€Ÿåº¦ (LCP < 2.5s)
- å‡å°‘é¦–æ¬¡å†…å®¹ç»˜åˆ¶æ—¶é—´ (FCP < 2s)
- ä¼˜åŒ–å›¾ç‰‡åŠ è½½æ€§èƒ½
- å®žçŽ°èµ„æºæ‡’åŠ è½½å’Œé¢„åŠ è½½

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. å›¾ç‰‡ä¼˜åŒ–
- è½¬æ¢ä¸ºWebPæ ¼å¼
- ç”Ÿæˆå“åº”å¼å›¾ç‰‡å°ºå¯¸
- å®žçŽ°å›¾ç‰‡æ‡’åŠ è½½
- ä¼˜åŒ–å›¾ç‰‡è´¨é‡è®¾ç½®

### 2. é™æ€èµ„æºä¼˜åŒ–
- CSSå’ŒJSæ–‡ä»¶åŽ‹ç¼©
- å¯ç”¨gzipåŽ‹ç¼©
- å®žçŽ°èµ„æºé¢„åŠ è½½
- ä¼˜åŒ–ç¼“å­˜ç­–ç•¥

### 3. å‰ç«¯æ€§èƒ½ä¼˜åŒ–
- å…³é”®CSSå†…è”
- JavaScriptä»£ç åˆ†å‰²
- å­—ä½“åŠ è½½ä¼˜åŒ–
- èµ„æºæç¤ºé…ç½®

### 4. æœåŠ¡å™¨ä¼˜åŒ–
- Nginxé…ç½®ä¼˜åŒ–
- ç¼“å­˜ç­–ç•¥é…ç½®
- åŽ‹ç¼©ä¸­é—´ä»¶ä¼˜åŒ–
- é™æ€æ–‡ä»¶æœåŠ¡ä¼˜åŒ–

## ðŸ“ˆ é¢„æœŸæ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| é¦–å±åŠ è½½æ—¶é—´ | 4-6s | 1.5-2.5s | 60-75% |
| å›¾ç‰‡åŠ è½½æ—¶é—´ | 2-3s | 0.5-1s | 70-80% |
| æ€»é¡µé¢å¤§å° | 2-3MB | 800KB-1.2MB | 50-60% |
| ç¼“å­˜å‘½ä¸­çŽ‡ | 30-40% | 80-90% | 100%+ |

## ðŸš€ ä½¿ç”¨æ–¹æ³•

### 1. é‡å¯æœåŠ¡å™¨
\`\`\`bash
pm2 restart all
# æˆ–è€…
npm start
\`\`\`

### 2. é‡å¯Nginx
\`\`\`bash
sudo systemctl restart nginx
# æˆ–è€…
sudo nginx -s reload
\`\`\`

### 3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- æŒ‰Ctrl+Shift+Delete
- é€‰æ‹©"ç¼“å­˜çš„å›¾ç‰‡å’Œæ–‡ä»¶"
- ç‚¹å‡»"æ¸…é™¤æ•°æ®"

## ðŸ” æ€§èƒ½ç›‘æŽ§

### ä½¿ç”¨Chrome DevTools
1. æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)
2. åˆ‡æ¢åˆ°Performanceæ ‡ç­¾
3. ç‚¹å‡»å½•åˆ¶æŒ‰é’®
4. åˆ·æ–°é¡µé¢
5. åœæ­¢å½•åˆ¶å¹¶åˆ†æžç»“æžœ

### å…³é”®æŒ‡æ ‡
- **LCP (Largest Contentful Paint)**: < 2.5s
- **FCP (First Contentful Paint)**: < 2s
- **FID (First Input Delay)**: < 100ms
- **CLS (Cumulative Layout Shift)**: < 0.1

## ðŸ“ æ³¨æ„äº‹é¡¹

1. **å›¾ç‰‡æ ¼å¼**: ä¼˜å…ˆä½¿ç”¨WebPæ ¼å¼ï¼Œä¸æ”¯æŒæ—¶è‡ªåŠ¨é™çº§åˆ°JPEG/PNG
2. **ç¼“å­˜ç­–ç•¥**: é™æ€èµ„æºç¼“å­˜1å¹´ï¼ŒHTMLæ–‡ä»¶ç¼“å­˜1å°æ—¶
3. **åŽ‹ç¼©è®¾ç½®**: å›¾ç‰‡ä¸åŽ‹ç¼©ï¼Œæ–‡æœ¬æ–‡ä»¶å¯ç”¨gzipåŽ‹ç¼©
4. **æ‡’åŠ è½½**: å›¾ç‰‡åœ¨è¿›å…¥è§†å£æ—¶æ‰å¼€å§‹åŠ è½½

## ðŸ†˜ æ•…éšœæŽ’é™¤

### å¦‚æžœä¼˜åŒ–åŽæ€§èƒ½æ²¡æœ‰æ”¹å–„
1. æ£€æŸ¥æµè§ˆå™¨ç¼“å­˜æ˜¯å¦å·²æ¸…é™¤
2. ç¡®è®¤Nginxé…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½
3. éªŒè¯å›¾ç‰‡ä¼˜åŒ–æ˜¯å¦æˆåŠŸ
4. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

### å¦‚æžœå‡ºçŽ°é”™è¯¯
1. æŸ¥çœ‹æŽ§åˆ¶å°é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥æ–‡ä»¶æƒé™è®¾ç½®
3. ç¡®è®¤ä¾èµ–åŒ…æ˜¯å¦æ­£ç¡®å®‰è£…
4. æŸ¥çœ‹æœåŠ¡å™¨é”™è¯¯æ—¥å¿—

## ðŸ“ž æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. é¡¹ç›®æ—¥å¿—æ–‡ä»¶
2. æµè§ˆå™¨æŽ§åˆ¶å°
3. æœåŠ¡å™¨é”™è¯¯æ—¥å¿—
4. Nginxé”™è¯¯æ—¥å¿—

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)*
*ä¼˜åŒ–è„šæœ¬ç‰ˆæœ¬: 1.0.0*
EOF

echo -e "${GREEN}âœ… æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Šå·²ç”Ÿæˆ: PERFORMANCE_OPTIMIZATION_REPORT.md${NC}"

echo -e "${BLUE}ðŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶...${NC}"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -f *.tmp
rm -f *.log

echo -e "${GREEN}âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ${NC}"

echo -e "${GREEN}ðŸŽ‰ æ€§èƒ½ä¼˜åŒ–å®Œæˆï¼${NC}"
echo -e "${YELLOW}ðŸ“‹ è¯·æŸ¥çœ‹ PERFORMANCE_OPTIMIZATION_REPORT.md äº†è§£è¯¦ç»†ä¼˜åŒ–å†…å®¹${NC}"
echo -e "${BLUE}ðŸ”„ å»ºè®®é‡å¯æœåŠ¡å™¨å’ŒNginxä»¥åº”ç”¨æ‰€æœ‰ä¼˜åŒ–${NC}"

# æ˜¾ç¤ºé‡å¯å‘½ä»¤
echo -e "${YELLOW}é‡å¯å‘½ä»¤:${NC}"
echo -e "${GREEN}pm2 restart all${NC}"
echo -e "${GREEN}sudo systemctl restart nginx${NC}"

echo -e "${BLUE}ðŸ“Š ä¼˜åŒ–å®ŒæˆåŽï¼Œè¯·ä½¿ç”¨Chrome DevToolsæµ‹è¯•æ€§èƒ½æŒ‡æ ‡${NC}"
